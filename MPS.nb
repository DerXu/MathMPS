(* Content-type: application/mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 6.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       145,          7]
NotebookDataLength[    368857,       8948]
NotebookOptionsPosition[    358958,       8626]
NotebookOutlinePosition[    359511,       8649]
CellTagsIndexPosition[    359424,       8644]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["MPS algorithms", "Title",
 CellChangeTimes->{{3.443512958642776*^9, 3.4435129629993067`*^9}, {
  3.449135397414262*^9, 3.44913541713166*^9}, {3.451652690823167*^9, 
  3.451652694018517*^9}, {3.467092666947618*^9, 3.467092667744766*^9}, {
  3.469859420485894*^9, 3.4698594256859922`*^9}, {3.470381194413258*^9, 
  3.470381199820562*^9}, {3.4736564714926453`*^9, 3.47365648007857*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"SetDirectory", "[", 
  RowBox[{"NotebookDirectory", "[", "]"}], "]"}]], "Input",
 CellChangeTimes->{{3.475860577098074*^9, 3.475860590055814*^9}}],

Cell[BoxData["\<\"/Users/fcucchietti/Code/MathMPS\"\>"], "Output",
 CellChangeTimes->{3.475860590859707*^9, 3.477910072076563*^9, 
  3.477992255170383*^9, 3.4779928648480263`*^9, 3.478258924310684*^9, 
  3.478372035816634*^9, 3.478969840262426*^9, 3.479011844464232*^9, 
  3.489232063288458*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{"BeginPackage", "[", "\"\<MathMPS`\>\"", "]"}]], "Input",
 CellChangeTimes->{{3.489232496976416*^9, 3.489232499189662*^9}}],

Cell[BoxData[
 RowBox[{"Print", "[", 
  "\"\<MPS manipulation from Mathematica.\nMPS Manipulation and creation:\n\t\
MPSProductState\n\tMPSExpandBond\n\tMPSNormalize\n\tMPSCanonize\nReading and \
saving to disk:\n\tMPSRead\n\tMPSSave\nExpectation values:\n\tMPSExpectation\n\
\tMPSCorrelation\nAlgorithms:\n\tMPSApproximate\n\tMPSMinimizeEnergy\n\
Hamiltonian Creation:\n\tMPSInitHamiltonian\n\tMPSHamiltonianAdd\n\nAlso \
available are TEBD algorithms:\n\nCreation and disk interaction:\n\t\
TEBDProductState\n\tTEBDRead\n\tTEBDSave\nReal and imaginary time evolution:\n\
\tTEBDEvolve\nExpectation values:\n\tTEBDExpectation\n\tTEBDExpectationList\n\
\tTEBDentropy\n\tTEBDentropyList\nHamiltonians and evolution operators:\n\t\
TEBDInitHamiltonian\n\tTEBDHamiltonianAdd\n\tTEBDEvolutionFromHamiltonian\n\t\
TEBDInitEvolution\n\tTEBDEvolutionAddGate\n\>\"", "]"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489232079666792*^9, 3.489232226449568*^9}, {
  3.4892358823535633`*^9, 3.489236128076064*^9}, {3.489295947660524*^9, 
  3.4892959668158484`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSProductState", "::", "usage"}], "=", 
  "\"\<MPSProductState[numTensors] creates a Matrix Product State of length \
numTensors. \nOptions:\n   Spin->s (default = 2)\n   Bond->\[Chi] (default = \
10)\n   Type-> \\\"Random\\\" (default), \\\"Identity\\\", \\\"Decaying\\\". \
\nAs of now the Random option produces an warning but the state is correct.\>\
\"", " "}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470381548193817*^9, 3.470381751691001*^9}, {
   3.470382503736044*^9, 3.4703825124521027`*^9}, 3.475564626392207*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSExpandBond", "::", "usage"}], "=", 
  "\"\<MPSExpandBond[mps,new\[Chi]] expands the bond dimension \[Chi] of mps \
to new\[Chi]. Returns the expanded mps as a new variable\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382179907455*^9, 3.470382235331128*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSNormalize", "::", "usage"}], "=", 
  "\"\<MPSNormalize[mps] normalizes mps so that MPSOverlap[mps,mps]=1. It \
changes the state.\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4703823420675793`*^9, 3.470382376276455*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSCanonize", "::", "usage"}], "=", 
  "\"\<MPSCanonize[mps] transforms mps into its canonical form. \nOptions:\n  \
    Direction->\\\"Left\\\" (default) or \\\"Right\\\"\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382391842243*^9, 3.4703824994339733`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSSave", "::", "usage"}], "=", 
  "\"\<MPSSave[MPS,filename] saves MPS into ASCII files for later retrieval. \
Right now it produces a lot of files, to be changed in the future. filename \
needs to be a string\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382532451457*^9, 3.470382587288331*^9}}],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"MPSRead", "::", "usage"}], "=", 
   "\"\<MPSRead[filename] reads the files produced by MPSSave and returns a \
new MPS object\>\""}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382603180705*^9, 3.470382638514471*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSOverlap", "::", "usage"}], "=", 
  "\"\<MPSOverlap[mps1,mps2] returns the overlap <psi_1|psi_2>, where psi_i \
is the state represented by mpsi\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382260739749*^9, 3.4703823219908857`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSExpectation", "::", "usage"}], "=", 
  "\"\<\nMPSExpectation[mps,operator,site]\n\
MPSExpectation[mps,operator,site1,site2]\n\
MPSExpectation[mps,operator1,site1,operator2,site2]\n\nComputes the \
expectation value of one or two Hermitian operators acting on one or two \
sites\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.475821872455428*^9, 3.475821939134164*^9}, {
  3.4758219780681868`*^9, 3.475822032607959*^9}, {3.47582214353074*^9, 
  3.475822162594906*^9}, {3.47582262772011*^9, 3.475822668515974*^9}, {
  3.475822754572332*^9, 3.475822780491611*^9}, {3.4758228133309717`*^9, 
  3.475822879551815*^9}, {3.475822918405306*^9, 3.4758229213799763`*^9}, {
  3.4758230527077427`*^9, 3.475823074960052*^9}, {3.4758346348642483`*^9, 
  3.4758346450235577`*^9}, {3.475834681586348*^9, 3.475834682605858*^9}, {
  3.475837889617421*^9, 3.475837893552219*^9}, {3.489231198052435*^9, 
  3.489231320294649*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSCorrelation", "::", "usage"}], "=", 
  "\"\<MPSCorrelation[mps,operator1,site1,operator2,site2]  Computes all the \
expectation values of operator1 and operator2 acting on all sites between \
site1 and site2\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4758229488440323`*^9, 3.475822961441382*^9}, 
   3.475823186150878*^9, {3.475823818428958*^9, 3.4758238742908297`*^9}, {
   3.4758239051424913`*^9, 3.4758242067070293`*^9}, {3.4758242372245283`*^9, 
   3.475824238440568*^9}, {3.475824463774959*^9, 3.475824584932*^9}, {
   3.475824634716448*^9, 3.475824754031307*^9}, {3.475837880345994*^9, 
   3.47583788415526*^9}, {3.475837953147972*^9, 3.475837954455832*^9}, {
   3.47583802329186*^9, 3.475838031465795*^9}, {3.475860280935561*^9, 
   3.475860281686852*^9}, {3.489231334864101*^9, 3.489231396751731*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSApproximate", "::", "usage"}], "=", 
  "\"\<MPSApproximate[Bigmps,newBond,Options]  Computes a new MPS that \
approximates Bigmps but with a smaller bond dimension, specified by newBond. \
\nOptions are:\n     UseRandomState\[Rule]bool  (Default is True. It starts \
the approximation using a random state)\n     Ansatz\[Rule]anMPS      \
(Default Empty List. If UseRandomState->True, it must contain a valid MPS to \
use as a starting Ansatz)\n     Tolerance\[Rule]someNumber  (Default is some \
small quantity)\n     Sweeps\[Rule]someNumber   (Default is 10)\n     Verbose\
\[Rule]bool   (Default is False)\n\n#### WARNING ####\nThis function is still \
being debugged\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489231436509369*^9, 3.4892317323175573`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSInitHamiltonian", "::", "usage"}], "=", 
  "\"\<Ham=MPSInitHamiltonian[length] Initializes the object Ham to be the \
Hamiltonian matrix for MPS algorithms\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487504963291223*^9, 3.487504983583084*^9}, {
   3.489234685071151*^9, 3.489234697592998*^9}, {3.4892348699158907`*^9, 
   3.489234898833209*^9}, 3.4892349570378723`*^9, {3.489235622097735*^9, 
   3.489235650509316*^9}, {3.489236499466034*^9, 3.489236502873431*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MPSHamiltonianAdd", "::", "usage"}], "=", 
   "\"\<\nMPSHamiltonianAdd[Ham,axis,strength,site]  Adds a field term to the \
Hamiltonian\nMPSHamiltonianAdd[Ham,axis,strength,site1,site2]  Adds an \
interaction term to the Hamiltonian\nAxis is either 1, 2, or 3 (which means \
X, Y, and Z Pauli matrices)\nHam must be initialized first.\nAs of now, MPS \
algorithms can only compute interactions that are of the type XX, YY, or ZZ \
with an arbitrary strength. This limitation will be lifted in the near \
future.\>\""}], "\n"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498409725955*^9, 3.487498520916314*^9}, {
  3.487498551262932*^9, 3.4874985758748426`*^9}, {3.4874986667194357`*^9, 
  3.4874986722635403`*^9}, {3.489234704463614*^9, 3.489234704669962*^9}, {
  3.48923478693493*^9, 3.489234823562299*^9}, {3.489234913573173*^9, 
  3.4892350273080387`*^9}, {3.48923507529417*^9, 3.489235322017806*^9}, {
  3.489235414790785*^9, 3.489235445387767*^9}, {3.4892354822852163`*^9, 
  3.489235530043385*^9}, {3.489235658743906*^9, 3.489235818290647*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"MPSMinimizeEnergy", "::", "usage"}], "=", 
  "\"\<MPSMinimizeEnergy[mps,aHamiltonian,Options]\n\nComputes the ground \
state of aHamiltonian using a DMRG sweeping technique. It returns the energy \
of the final state.\nOptions:\n\nSweeps\[Rule]MaxNumberOfSweeps\n\
InteractionRange->integer   (The interaction range of aHamiltonian. This will \
be deprecated in future versions)\nTolerance\[Rule]tol    (Precision \
tolerance for stopping the algorithm)\nMonitorEnergy\[Rule]bool  (Default \
True, it prints out not only the final energy of the state, but the dynamics \
of energy as a function of steps)\nVerbose\[Rule]bool   (make the routine \
more talkative)\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.48923177517767*^9, 3.489231991091792*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDProductState", "::", "usage"}], "=", 
  "\"\<TEBDProductState[numSites,Options]\nCreates a TEBD representation \
state. \nOptions:\n\tSpin\[Rule]integer (Default is 2)\n\t\
BondDimension\[Rule]integer   (default is 20)\n\tType\[Rule]{type,list}     \
(Creates several types of TEBDs: type=\\\"Random\\\" , \\\"Identity\\\", or \
\\\"Specified\\\".\n\t\t\t\t\t\tIf Specified is chosen, then list must be a \
Table of dimensions {numSites,2}, containing in each element a pair \
{probAmplitude,phase}\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4892326934112053`*^9, 3.489232917188689*^9}, 
   3.489295477617836*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDSave", "::", "usage"}], "=", 
  "\"\<TEBDSave[MPS,filename] saves TEBD into ASCII files for later \
retrieval. Right now it produces a lot of files, to be changed in the future. \
filename needs to be a string\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382532451457*^9, 3.470382587288331*^9}, {
   3.489232949736994*^9, 3.4892329631356916`*^9}, 3.489306893210471*^9}],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"TEBDRead", "::", "usage"}], "=", 
   "\"\<TEBDRead[filename] reads the files produced by TEBDSave and returns a \
new TEBD object\>\""}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470382603180705*^9, 3.470382638514471*^9}, {
  3.489232953560121*^9, 3.489232973271994*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDEvolve", "::", "usage"}], "=", 
  "\"\<\[IndentingNewLine]TEBDEvolve[TEBD,OperatorList,repeatTimes]\nEvolves \
the TEBD object with the given OperatorList (see example). It applies this \
list repeatTimes number of times, but this argument is optional and the \
default is one. It can take Verbose->True option to print out the \
steps.\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489233311877048*^9, 3.4892334035488987`*^9}, 
   3.4892368086681623`*^9, {3.489300441146426*^9, 3.489300460079199*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDExpectation", "::", "usage"}], "=", 
  "\"\<\nTEBDExpectation[TEBD,site,Operator]\n\
TEBDExpectation[TEBD,site1,site2,Operator1,Operator2]\n\nComputes the \
expectation value of one or two operators acting in one or two \
sites.\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489233411346633*^9, 3.489233484848325*^9}, {
  3.489297224607312*^9, 3.4892972305187674`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDExpectationList", "::", "usage"}], "=", 
  "\"\<\nTEBDExpectationList[TEBD,site1,site2,Operator1,Operator2]\n\n\
Computes the expectation value of one or two operators acting in one or two \
sites. The List version returns all the possible correlations between site1 \
and site2\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489297204661977*^9, 3.489297218685503*^9}, {
  3.489297391379095*^9, 3.489297392826477*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDInitHamiltonian", "::", "usage"}], "=", 
  "\"\<\[IndentingNewLine]Ham=TEBDInitHamiltonian[]   Initializes a \
Hamiltonian object Ham to an empty Hamiltonian\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487504963291223*^9, 3.487504983583084*^9}, {
  3.489233495302539*^9, 3.489233531740378*^9}, {3.489236480701313*^9, 
  3.489236488705927*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDInitEvolution", "::", "usage"}], "=", 
  "\"\<\[IndentingNewLine]U=TEBDInitEvolution[]   Initializes an evolution \
operator object U.\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489295784067923*^9, 3.489295825751916*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDEvolutionAddGate", "::", "usage"}], "=", 
  "\"\<\nTEBDEvolutionAddGate[U,operator,site]\n\
TEBDEvolutionAddGate[U,operator12,site1,site2]\n\nAdds an operator the the \
evolution operator U that acts either on a single site, or on two sites. \
Notice that operator must be a spin x spin matrix, or an arbitrary 2 spin \
operator (spin^2 x spin^2).\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498409725955*^9, 3.487498520916314*^9}, {
  3.487498551262932*^9, 3.4874985758748426`*^9}, {3.4874986667194357`*^9, 
  3.4874986722635403`*^9}, {3.4892335368686743`*^9, 3.489233615194723*^9}, {
  3.489233725135577*^9, 3.489233795286592*^9}, {3.48929585018738*^9, 
  3.489295925025134*^9}, {3.489295975647637*^9, 3.489295980142877*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDHamiltonianAdd", "::", "usage"}], "=", 
  "\"\<\nTEBDHamiltonianAdd[Ham,operator,site]\n\
TEBDHamiltonianAdd[Ham,operator1,site1,,operator2,site2]\n\nAdds an operator \
the the Hamiltonian Ham that acts either on a single site, or on two sites. \
Notice that operator must be a spin x spin matrix.\nAn arbitrary 2 spin \
operator (spin^2 x spin^2) can also be passed as\n\n\
TEBDHamiltonianAdd[Ham,operator,site1,site2]\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498409725955*^9, 3.487498520916314*^9}, {
  3.487498551262932*^9, 3.4874985758748426`*^9}, {3.4874986667194357`*^9, 
  3.4874986722635403`*^9}, {3.4892335368686743`*^9, 3.489233615194723*^9}, {
  3.489233725135577*^9, 3.489233795286592*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"TEBDEvolutionFromHamiltonian", "::", "usage"}], "=", 
   "\"\<TEBDEvolutionFromHamiltonian[Ham,time]\nCreates an evolution operator \
List that is ready to be passed to TEBDEvolve. \nNOTICE this function is \
still being optimized. As of now, it only creates the list with the operators \
in the same order as given by the Hamiltonian. This means that the evolution \
list created will very likely create many errors. In the meantime, see \
examples on how to create a good list by hand.\>\""}], "\n"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498585484786*^9, 3.48749865769564*^9}, {
   3.489233804102551*^9, 3.489233937961594*^9}, {3.489295857145932*^9, 
   3.489295860823896*^9}, 3.489296161191127*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDEntropyList", "::", "usage"}], "=", 
  "\"\<TEBDEntropyList[tebd]   Gives a list of all possible bipartite \
entropies of the TEBD state\>\""}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489301083835376*^9, 3.4893011110723743`*^9}}],

Cell[BoxData[
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]], "Input"],

Cell[CellGroupData[{

", "Subsection",
 CellChangeTimes->{{3.4703880265556507`*^9, 3.470388029856028*^9}}],

Cell[BoxData[{,

Cell[CellGroupData[{

ar", "[", "MPSProductState", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBo,

Cell[CellGroupData[{

oductState", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Spin", "->", "DefaultSpinDimension",

 ",", 
     RowBox[{"Bond", "->", "MPSDefaultBond"}], ",", 
     RowBox[{"Type", "->", "\"\<Random\>\""}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 R,

Cell[BoxData[{
 RowBox[{
  RowBox[{"DefaultSpinDimension", "=", "2"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MPSDefaultBond", "=", "10"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DefaultSweeps", "=", "10"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DefaultEnergyTolerance", "=", 
   RowBox[{"10", "^", 
    RowBox[{"(", 
     RowBox[{"-", "4"}], ")"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DefaultApproximationTolerance", "=", 
   RowBox[{"10", "^", 
    RowBox[{"(", 
     RowBox[{"-", "10"}], ")"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"DefaultInteractionRange", "=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MPSMaxBond", "=", "100"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ForceUseInternalRoutine", "=", "True"}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.44326940161269*^9, 3.4432694141302633`*^9}, {
   3.443269658649675*^9, 3.443269767770135*^9}, {3.4432699395517483`*^9, 
   3.443269970352769*^9}, {3.443270016967918*^9, 3.4432700752015057`*^9}, 
   3.4432701304751787`*^9, {3.4434394225719357`*^9, 3.4434394251994877`*^9}, 
   3.4435174587080097`*^9, 3.443527312242008*^9, {3.443791575987612*^9, 
   3.443791576270411*^9}, {3.443792066219215*^9, 3.443792066277426*^9}, {
   3.443853174724536*^9, 3.443853174868849*^9}, 3.4438560266279373`*^9, 
   3.4438591884989347`*^9, 3.444020522111377*^9, 3.4440409420943604`*^9, 
   3.444041156100191*^9, 3.44404138396012*^9, 3.444118356879141*^9, {
   3.449171434442206*^9, 3.449171434579524*^9}, {3.4491737268655653`*^9, 
   3.449173742368928*^9}, {3.449174000607956*^9, 3.449174003033008*^9}, {
   3.449174043425432*^9, 3.4491740442644167`*^9}, {3.4491743604300823`*^9, 
   3.4491743605117397`*^9}, 3.44917577131911*^9, {3.449177953900272*^9, 
   3.4491779539633303`*^9}, {3.449178357676675*^9, 3.449178359323513*^9}, {
   3.449178525154139*^9, 3.4491785252165194`*^9}, {3.4492124907573423`*^9, 
   3.449212490830147*^9}, {3.4492242733249083`*^9, 3.4492242742231693`*^9}, {
   3.449254636463402*^9, 3.449254637073791*^9}, {3.449255357727364*^9, 
   3.449255357851218*^9}, {3.449314054503016*^9, 3.4493140589097033`*^9}, {
   3.449463636997964*^9, 3.449463637068089*^9}, {3.449464344147833*^9, 
   3.449464344343712*^9}, {3.4500661949248466`*^9, 3.450066194985968*^9}, {
   3.450068238622999*^9, 3.450068239179392*^9}, {3.450070278076972*^9, 
   3.450070285004595*^9}, {3.451024457389194*^9, 3.451024457447751*^9}, {
   3.451189692813745*^9, 3.451189692997411*^9}, {3.451319896072816*^9, 
   3.451319896178259*^9}, 3.451320748006482*^9, {3.45136266938815*^9, 
   3.4513626695105267`*^9}, 3.451386417018498*^9, 3.45139127412681*^9, {
   3.4516301171193867`*^9, 3.451630117182514*^9}, {3.451652699115774*^9, 
   3.4516526994126453`*^9}, {3.467092754740958*^9, 3.467092759615608*^9}, {
   3.4670930064693203`*^9, 3.4670930135738792`*^9}, {3.469859509132738*^9, 
   3.469859519222659*^9}, {3.4703821152222757`*^9, 3.4703821219711857`*^9}, {
   3.470386028891786*^9, 3.470386032501006*^9}, {3.470386252405851*^9, 
   3.470386264982111*^9}, {3.475071519052841*^9, 3.47507152434727*^9}, {
   3.4755646835292664`*^9, 3.4755647228941803`*^9}, {3.489232284775084*^9, 
   3.48923228948447*^9}, {3.489305417875404*^9, 3.48930541856686*^9}, {
   3.48930545820191*^9, 3.489305458797453*^9}, {3.489306957157098*^9, 
   3.48930695778201*^9}, {3.4893135212570677`*^9, 3.489313521684362*^9}}]
}, Open  ]],

Cell[CellGroupData[{

\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
,

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", 
   RowBox[{"LProduct", ",", "RProduct"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LProduct", "[", 
    RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"MapThread", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ConjugateTranspose", "[", "#2", "]"}], ".", "#1"}], "&"}], 
      ",", 
      RowBox[{"{", 
       RowBox[{"A", ",", "B"}], "}"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"LProduct", "[", 
    RowBox[{"A_", ",", "B_", ",", "Lm_"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"MapThread", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"ConjugateTranspose", "[", "#2", "]"}], ".", "Lm", ".", 
        "#1"}], "&"}], ",", 
      RowBox[{"{", 
       RowBox[{"A", ",", "B"}], "}"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RProduct", "[", 
    RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"MapThread", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"#1", ".", 
        RowBox[{"ConjugateTranspose", "[", "#2", "]"}]}], "&"}], ",", 
      RowBox[{"{", 
       RowBox[{"A", ",", "B"}], "}"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RProduct", "[", 
    RowBox[{"A_", ",", "B_", ",", "Rm_"}], "]"}], ":=", 
   RowBox[{"Plus", "@@", 
    RowBox[{"MapThread", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"#1", ".", "Rm", ".", 
        RowBox[{"ConjugateTranspose", "[", "#2", "]"}]}], "&"}], ",", 
      RowBox[{"{", 
       RowBox[{"A", ",", "B"}], "}"}]}], "]"}]}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.47037883938379*^9, 3.47037887736583*^9}, {
  3.470378941933694*^9, 3.470378975239135*^9}, {3.470379008112261*^9, 
  3.470379013705633*^9}, {3.47038049079356*^9, 3.470380495125061*^9}, {
  3.470387593606989*^9, 3.470387611449492*^9}, {3.474290012067958*^9, 
  3.4742900165532*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"sigma", "[", "0", "]"}], "=", 
   RowBox[{"SparseArray", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1.0", ",", "0.0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0.0", ",", "1.0"}], "}"}]}], "}"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"sigma", "[", "1", "]"}], "=", 
   RowBox[{"SparseArray", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0.0", ",", "0.5"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0.5", ",", "0.0"}], "}"}]}], "}"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"sigma", "[", "2", "]"}], "=", 
   RowBox[{"SparseArray", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0.0", ",", 
        RowBox[{
         RowBox[{"-", "I"}], " ", "0.5"}]}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"I", " ", "0.5"}], ",", "0.0"}], "}"}]}], "}"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"sigma", "[", "3", "]"}], "=", 
   RowBox[{"SparseArray", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0.5", ",", "0.0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0.0", ",", 
        RowBox[{"-", "0.5"}]}], "}"}]}], "}"}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4703880444050903`*^9, 3.470388124607627*^9}, {
  3.477992063795862*^9, 3.477992096321067*^9}}]
}, Closed]],

Cell[CellGroupData[{

275376667*^9, 
   3.449178334557598*^9}, {3.4491785474157887`*^9, 3.4491785654408903`*^9}, {
   3.4492363,

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "MPSProductState", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MPSProductState", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Spin", "->", "DefaultSpinDimension"}], ",", 
     RowBox[{"Bond", "->", "MPSDefaultBond"}], ",", 
     RowBox[{"Type", "->", "\"\<Random\>\""}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSProductState", "[", 
    RowBox[{"numTensors_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[CapitalGamma]", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{"0", "&"}], ",", 
          RowBox[{"{", "numTensors", "}"}]}], "]"}]}], ",", 
       RowBox[{"type", "=", 
        RowBox[{"OptionValue", "[", "Type", "]"}]}], ",", "coeffList", ",", 
       RowBox[{"spin", "=", 
        RowBox[{"OptionValue", "[", "Spin", "]"}]}], ",", 
       RowBox[{"\[Chi]", "=", 
        RowBox[{"OptionValue", "[", "Bond", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Switch", "[", 
       RowBox[{"type", ",", "\n", "\"\<Identity\>\"", ",", "\n", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"i", "\[Equal]", "j", "\[Equal]", "1"}], ",", 
                RowBox[{
                 RowBox[{"{", "1.0", "}"}], "~", "Join", "~", 
                 RowBox[{"Table", "[", 
                  RowBox[{"0.0", ",", 
                   RowBox[{"{", 
                    RowBox[{"m", ",", "1", ",", 
                    RowBox[{"spin", "-", "1"}]}], "}"}]}], "]"}]}], ",", 
                RowBox[{"Table", "[", 
                 RowBox[{"0.0", ",", 
                  RowBox[{"{", 
                   RowBox[{"m", ",", "spin"}], "}"}]}], "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "\[Chi]"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "\[Chi]"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\"\<Decaying\>\""}], ",", "\n", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"i", "\[Equal]", "j", "\[Equal]", "1"}], ",", 
                RowBox[{"Normalize", "[", 
                 RowBox[{"Table", "[", 
                  RowBox[{
                   RowBox[{"Exp", "[", 
                    RowBox[{
                    RowBox[{"-", "0.5"}], " ", 
                    RowBox[{"Log", "[", "20", "]"}], 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"m", "-", "1"}], ")"}], "/", "spin"}]}], "]"}], 
                   ",", 
                   RowBox[{"{", 
                    RowBox[{"m", ",", "1", ",", "spin"}], "}"}]}], "]"}], 
                 "]"}], ",", "0"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "\[Chi]"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "\[Chi]"}], "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", "\"\<Random\>\""}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"Normalize", "[", 
               RowBox[{"RandomComplex", "[", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"-", "1"}], "-", "I"}], ",", 
                   RowBox[{"1", "+", "I"}]}], "}"}], ",", "spin"}], "]"}], 
               "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"i", ",", "1", ",", "\[Chi]"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "\[Chi]"}], "}"}]}], "]"}]}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"SparseArray", "[", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"coeffList", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j", ",", "1", ",", "n"}], "]"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "1"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", "\[Chi]"}], "}"}]}], "]"}], "]"}], 
          ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "1", ",", "spin"}], "}"}]}], "]"}], "}"}], "~", 
       "Join", "~", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"coeffList", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "j", ",", "k", ",", "n"}], "]"}], "]"}], 
              ",", 
              RowBox[{"{", 
               RowBox[{"i", ",", "1", ",", "\[Chi]"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "1", ",", "\[Chi]"}], "}"}]}], "]"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"n", ",", "1", ",", "spin"}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"k", ",", "2", ",", 
           RowBox[{"numTensors", "-", "1"}]}], "}"}]}], "]"}], "~", "Join", 
       "~", 
       RowBox[{"{", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"SparseArray", "[", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"coeffList", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j", ",", "numTensors", ",", "n"}], "]"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "\[Chi]"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", "1"}], "}"}]}], "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "1", ",", "spin"}], "}"}]}], "]"}], "}"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.443439537402534*^9, 3.443439639927244*^9}, {
   3.443439857821541*^9, 3.443439906538312*^9}, {3.4434400403401814`*^9, 
   3.443440079148674*^9}, {3.443440644319996*^9, 3.443440796360334*^9}, {
   3.443440830969428*^9, 3.443440834937833*^9}, 3.4435131760710497`*^9, {
   3.4491356898825693`*^9, 3.44913569391879*^9}, {3.449136854700157*^9, 
   3.4491369145900793`*^9}, {3.449173795914415*^9, 3.449173814460408*^9}, {
   3.4491740621434393`*^9, 3.449174070252202*^9}, {3.449178275376667*^9, 
   3.449178334557598*^9}, {3.4491785474157887`*^9, 3.4491785654408903`*^9}, {
   3.449236359094222*^9, 3.44923636708257*^9}, {3.449236398025247*^9, 
   3.449236404166627*^9}, {3.4492375780764313`*^9, 3.4492376036497583`*^9}, {
   3.449237644219357*^9, 3.449237661453532*^9}, {3.44923769587178*^9, 
   3.449237698909216*^9}, {3.4492379945384197`*^9, 3.449237995052356*^9}, {
   3.449238034231538*^9, 3.449238061045824*^9}, {3.449238218499207*^9, 
   3.449238378800868*^9}, {3.44923844288177*^9, 3.449238477639595*^9}, {
   3.449238544541551*^9, 3.449238595688814*^9}, {3.449238630122113*^9, 
   3.449238668286615*^9}, {3.449305367464713*^9, 3.4493053854013643`*^9}, {
   3.4493054254234343`*^9, 3.449305439647161*^9}, {3.44931273666776*^9, 
   3.449312756582868*^9}, {3.450030743177949*^9, 3.450030778802433*^9}, {
   3.450030810782054*^9, 3.4500309284330873`*^9}, {3.450065783029697*^9, 
   3.450065811431054*^9}, {3.450067413418728*^9, 3.45006745687751*^9}, {
   3.450685428372428*^9, 3.450685607968252*^9}, {3.451024004825375*^9, 
   3.4510242874559383`*^9}, {3.451024323295775*^9, 3.451024323456128*^9}, {
   3.4510243618010187`*^9, 3.4510243783362303`*^9}, {3.451189919160843*^9, 
   3.451189922672126*^9}, {3.451305269177762*^9, 3.451305273713153*^9}, {
   3.451305314419791*^9, 3.451305382356247*^9}, {3.451305509306275*^9, 
   3.451305529423973*^9}, {3.4513055864738417`*^9, 3.4513056414551992`*^9}, 
   3.451305703880803*^9, {3.451305857288804*^9, 3.451305884397359*^9}, {
   3.451305980350638*^9, 3.451305986632861*^9}, {3.4516686396473207`*^9, 
   3.4516686457285337`*^9}, 3.4670926886409388`*^9, {3.467092952289914*^9, 
   3.467092953259117*^9}, {3.4670929968129587`*^9, 3.467093000615815*^9}, {
   3.467093041426052*^9, 3.4670930495072536`*^9}, {3.467093086097773*^9, 
   3.4670931753738527`*^9}, {3.4671011866991663`*^9, 3.467101200524783*^9}, {
   3.4671014619435368`*^9, 3.467101566071454*^9}, {3.467101626569606*^9, 
   3.467101829909521*^9}, {3.467101919867951*^9, 3.4671019214659567`*^9}, {
   3.4671019532713737`*^9, 3.467101975752968*^9}, {3.467102048965217*^9, 
   3.467102055294055*^9}, {3.467102089961206*^9, 3.467102146226348*^9}, {
   3.467109502552329*^9, 3.467109503007831*^9}, {3.467109649376165*^9, 
   3.467109660000292*^9}, {3.4684121549766893`*^9, 3.468412268252777*^9}, {
   3.46841302488409*^9, 3.468413052912332*^9}, {3.4698594942603703`*^9, 
   3.469859557042609*^9}, {3.4698595916223392`*^9, 3.469859609629471*^9}, {
   3.4698596627724457`*^9, 3.469859666502451*^9}, {3.469859904452924*^9, 
   3.4698599282190523`*^9}, {3.470120835760366*^9, 3.470120905108337*^9}, {
   3.470121090767696*^9, 3.470121168318717*^9}, {3.470121208754171*^9, 
   3.470121221424461*^9}, {3.470121320725506*^9, 3.4701213414456663`*^9}, {
   3.470121409477817*^9, 3.4701214244234877`*^9}, {3.470121573116325*^9, 
   3.470121632361348*^9}, {3.470121723448002*^9, 3.47012182156229*^9}, {
   3.470121851745603*^9, 3.47012190143476*^9}, {3.470121935007967*^9, 
   3.47012193567629*^9}, {3.4701223556944237`*^9, 3.470122366407455*^9}, {
   3.470122706800562*^9, 3.470122711805147*^9}, 3.470122744297535*^9, {
   3.470122775682379*^9, 3.47012278995892*^9}, {3.470122830790292*^9, 
   3.470122838717616*^9}, {3.470125841845448*^9, 3.470125843498137*^9}, {
   3.4701259505687838`*^9, 3.470125959684545*^9}, 3.470381670778232*^9, {
   3.4731418636206713`*^9, 3.4731418993561*^9}, {3.473141932949246*^9, 
   3.473142044887042*^9}, {3.473142256142198*^9, 3.473142364169546*^9}, {
   3.473142505909017*^9, 3.47314259273734*^9}, 3.474289908314492*^9, {
   3.475076313328698*^9, 3.475076346903326*^9}, {3.475076394111615*^9, 
   3.475076410478909*^9}, {3.4750764429488907`*^9, 3.475076452164936*^9}, {
   3.475564652136931*^9, 3.4755647056963873`*^9}}]
}, Closed]],

Cell[CellGroupData[{

op", "[", 
        RowBox[{"MPSOverlap", "[", 
         RowBox[{"mps", ",", "mps"}], "]"}], "]"}]}], ";", 
      "\[I,

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "MPSExpandBond", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSExpandBond", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSExpandBond", "[", 
    RowBox[{"MPS_", ",", "new\[Chi]_"}], "]"}], ":=", 
   RowBox[{"Module", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"{", "old\[Chi]", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"old\[Chi]", "=", 
       RowBox[{"Max", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", "MPS"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"old\[Chi]", ">", "new\[Chi]"}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<WARNING: Trying to expand an MPS to a smaller bond dimension\>\
\"", "]"}], ";", "MPS"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Print", "[", 
          RowBox[{"\"\<Grow \[Chi] to \>\"", "<>", 
           RowBox[{"ToString", "[", "new\[Chi]", "]"}]}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"SparseArray", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"PadRight", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"1", ",", "new\[Chi]"}], "}"}]}], "]"}], "&"}], "/@", 
             RowBox[{"MPS", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], "}"}], "~", "Join", 
          "~", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"SparseArray", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"PadRight", "[", 
                RowBox[{"#", ",", 
                 RowBox[{"{", 
                  RowBox[{"new\[Chi]", ",", "new\[Chi]"}], "}"}]}], "]"}], 
               "&"}], "/@", 
              RowBox[{"MPS", "[", 
               RowBox[{"[", "M", "]"}], "]"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"M", ",", "2", ",", 
              RowBox[{
               RowBox[{"Length", "[", "MPS", "]"}], "-", "1"}]}], "}"}]}], 
           "]"}], "~", "Join", "~", 
          RowBox[{"{", 
           RowBox[{"SparseArray", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"PadRight", "[", 
               RowBox[{"#", ",", 
                RowBox[{"{", 
                 RowBox[{"new\[Chi]", ",", "1"}], "}"}]}], "]"}], "&"}], "/@", 
             RowBox[{"MPS", "[", 
              RowBox[{"[", 
               RowBox[{"Length", "[", "MPS", "]"}], "]"}], "]"}]}], "]"}], 
           "}"}]}]}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.467114162791239*^9, 3.467114262253087*^9}, {
   3.467114313292901*^9, 3.467114399035953*^9}, {3.467114459159977*^9, 
   3.4671144659409113`*^9}, {3.4671147525729637`*^9, 3.46711476206586*^9}, {
   3.467115359241096*^9, 3.467115432248981*^9}, {3.467531769337514*^9, 
   3.467531772403961*^9}, {3.469859678675845*^9, 3.469859714882284*^9}, {
   3.47012092782722*^9, 3.470120931295766*^9}, {3.470387573184863*^9, 
   3.470387580538789*^9}, {3.472822048874318*^9, 3.472822142528508*^9}, 
   3.474289913396447*^9, {3.4771218155169783`*^9, 3.47712191732415*^9}}]
}, Closed]],

Cell[CellGroupData[{

 RowBox[{"1", ",", "3"}], "}"}]}], "}"}]}], "]"}], "]"}]}], ";",
         "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Prepare", " ", "new", " ", "right", " ", "matrix"}], " ", 
         "*)",

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSOverlap", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSOverlap", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSOverlap", "[", 
    RowBox[{"mps1_", ",", "mps2_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"ctemp", "=", "0"}], ",", "L"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "This", " ", "function", " ", "also", " ", "works", " ", "with", " ", 
        "Fold"}], ",", " ", 
       RowBox[{
       "which", " ", "is", " ", "appealing", " ", "because", " ", "can", " ", 
        "also", " ", "give", " ", 
        RowBox[{"FoldList", ":", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Fold", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"LProduct", "[", 
              RowBox[{
               RowBox[{"mps1", "[", 
                RowBox[{"[", "#2", "]"}], "]"}], ",", 
               RowBox[{"mps2", "[", 
                RowBox[{"[", "#2", "]"}], "]"}], ",", "#1"}], "]"}], "&"}], 
            ",", 
            RowBox[{"LProduct", "[", 
             RowBox[{
              RowBox[{"mps1", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"mps2", "[", 
               RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", 
            RowBox[{"Range", "[", 
             RowBox[{"2", ",", 
              RowBox[{"Length", "[", "mps1", "]"}]}], "]"}]}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "1"}], "]"}], "]"}]}]}]}], "\[IndentingNewLine]",
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"L", "[", "1", "]"}], "=", 
       RowBox[{"LProduct", "[", 
        RowBox[{
         RowBox[{"mps1", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"mps2", "[", 
          RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"L", "[", "n_", "]"}], ":=", 
       RowBox[{"LProduct", "[", 
        RowBox[{
         RowBox[{"mps1", "[", 
          RowBox[{"[", "n", "]"}], "]"}], ",", 
         RowBox[{"mps2", "[", 
          RowBox[{"[", "n", "]"}], "]"}], ",", 
         RowBox[{"L", "[", 
          RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Chop", "[", 
       RowBox[{
        RowBox[{"L", "[", 
         RowBox[{"Length", "[", "mps1", "]"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4701202869441433`*^9, 3.47012031273973*^9}, {
   3.470120756726285*^9, 3.4701207875430717`*^9}, {3.47037975758845*^9, 
   3.470379758565158*^9}, {3.4703801213023663`*^9, 3.47038022147857*^9}, {
   3.470380306638424*^9, 3.470380321015937*^9}, {3.470380387039513*^9, 
   3.470380390588241*^9}, {3.470380483612225*^9, 3.470380485793109*^9}, {
   3.47038076221015*^9, 3.470380824600356*^9}, {3.4703876152133636`*^9, 
   3.470387621947822*^9}, 3.474289920214899*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSNormalize", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSNormalize", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSNormalize", "[", "mps_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "norm", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"norm", "=", 
       RowBox[{"Chop", "[", 
        RowBox[{"MPSOverlap", "[", 
         RowBox[{"mps", ",", "mps"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"mps", "=", 
       RowBox[{"Chop", "[", 
        RowBox[{"mps", "/", 
         RowBox[{
          RowBox[{"Abs", "[", "norm", "]"}], "^", 
          RowBox[{"(", 
           RowBox[{"1", "/", 
            RowBox[{"(", 
             RowBox[{"2", " ", 
              RowBox[{"Length", "[", "mps", "]"}]}], ")"}]}], ")"}]}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "norm"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.470378707668352*^9, 3.470378802852049*^9}, {
   3.470387629456568*^9, 3.470387633472892*^9}, 3.474289923564296*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSCanonizeSite", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MPSCanonizeSite", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Direction", "\[Rule]", "\"\<Right\>\""}], ",", 
     RowBox[{"UseMatrix", "\[Rule]", "True"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSCanonizeSite", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSCanonizeSite", "[", 
    RowBox[{"tensor_", ",", "matrix_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"sense", "=", 
        RowBox[{"OptionValue", "[", "Direction", "]"}]}], ",", 
       RowBox[{"usematrix", "=", 
        RowBox[{"OptionValue", "[", "UseMatrix", "]"}]}], ",", "numTensors", 
       ",", "\[Chi]L", ",", "\[Chi]R", ",", "\[Chi]", ",", "u", ",", "v", ",",
        "t", ",", "newTensor"}], "}"}], ",", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Start", " ", "by", " ", "multiplying", " ", "the", " ", "tensor", " ", 
       "with", " ", "the", " ", "matrix", " ", "from", " ", "the", " ", 
       "previous", " ", "site"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"sense", "\[Equal]", "\"\<Right\>\""}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"usematrix", ",", 
          RowBox[{"newTensor", "=", 
           RowBox[{"tensor", ".", "matrix"}]}], ",", 
          RowBox[{"newTensor", "=", "tensor"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Chi]L", ",", "\[Chi]R"}], "}"}], "=", 
         RowBox[{"Dimensions", "[", 
          RowBox[{"newTensor", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Chi]", "=", 
         RowBox[{"Max", "[", 
          RowBox[{"\[Chi]L", ",", "\[Chi]R"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"SVD", " ", "of", " ", "the", " ", "new", " ", "tensor"}], 
          ",", " ", 
          RowBox[{"putting", " ", "[", 
           RowBox[{"chiL", ",", " ", 
            RowBox[{"spin", "*", "chiR"}]}], "]"}]}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"u", ",", "v", ",", "t"}], "}"}], "=", 
         RowBox[{"SingularValueDecomposition", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"newTensor", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", "2", "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"1", ",", "3"}], "}"}]}], "}"}]}], "]"}], "]"}]}], ";",
         "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Prepare", " ", "new", " ", "right", " ", "matrix"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"matrix", "=", 
         RowBox[{"PadRight", "[", 
          RowBox[{
           RowBox[{"u", ".", "v"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Min", "[", 
              RowBox[{"\[Chi]", ",", "\[Chi]L"}], "]"}], ",", 
             RowBox[{"Min", "[", 
              RowBox[{"\[Chi]", ",", 
               RowBox[{"Length", "[", "t", "]"}], ",", "\[Chi]L"}], "]"}]}], 
            "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Form", " ", "the", " ", "new", " ", "tensor", " ", "with", " ", 
          "the", " ", "first", " ", "row", " ", "of", " ", 
          RowBox[{"t", "^", "dagger"}]}], " ", "*)"}], "\[IndentingNewLine]", 
        
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"ConjugateTranspose", "[", "t", "]"}], ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"Min", "[", 
               RowBox[{"\[Chi]", ",", 
                RowBox[{"Length", "[", "t", "]"}], ",", "\[Chi]L"}], "]"}], 
              ",", "\[Chi]R"}], "}"}]}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], 
       "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"usematrix", ",", 
          RowBox[{"newTensor", "=", 
           RowBox[{
            RowBox[{
             RowBox[{"matrix", ".", "#"}], "&"}], "/@", "tensor"}]}], ",", 
          RowBox[{"newTensor", "=", "tensor"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Chi]L", ",", "\[Chi]R"}], "}"}], "=", 
         RowBox[{"Dimensions", "[", 
          RowBox[{"newTensor", "[", 
           RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Chi]", "=", 
         RowBox[{"Max", "[", 
          RowBox[{"\[Chi]L", ",", "\[Chi]R"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"SVD", " ", "of", " ", "the", " ", "new", " ", "tensor"}], 
          ",", " ", 
          RowBox[{"putting", " ", "[", 
           RowBox[{
            RowBox[{"chiL", "*", "spin"}], ",", " ", "chiR"}], "]"}]}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"u", ",", "v", ",", "t"}], "}"}], "=", 
         RowBox[{"SingularValueDecomposition", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"newTensor", ",", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{"1", ",", "2"}], "}"}], ",", 
              RowBox[{"{", "3", "}"}]}], "}"}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Prepare", " ", "new", " ", "right", " ", "matrix"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"matrix", "=", 
         RowBox[{"PadRight", "[", 
          RowBox[{
           RowBox[{"v", ".", 
            RowBox[{"ConjugateTranspose", "[", "t", "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"Min", "[", 
              RowBox[{"\[Chi]", ",", 
               RowBox[{"Length", "[", "u", "]"}], ",", "\[Chi]R"}], "]"}], 
             ",", 
             RowBox[{"Min", "[", 
              RowBox[{"\[Chi]", ",", "\[Chi]R"}], "]"}]}], "}"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Form", " ", "the", " ", "new", " ", "tensor", " ", "with", " ", 
          "the", " ", "first", " ", "column", " ", "of", " ", "u"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"u", ",", 
            RowBox[{"{", 
             RowBox[{"\[Chi]L", ",", 
              RowBox[{"Min", "[", 
               RowBox[{"\[Chi]", ",", 
                RowBox[{"Length", "[", "u", "]"}], ",", "\[Chi]R"}], "]"}]}], 
             "}"}]}], "]"}], "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4729073705568333`*^9, 3.4729074542057953`*^9}, {
   3.472907492312113*^9, 3.47290759614567*^9}, {3.472907631263289*^9, 
   3.472907731825211*^9}, 3.472907924082934*^9, {3.4729079970600863`*^9, 
   3.472908041446335*^9}, {3.47290808514633*^9, 3.472908091914699*^9}, {
   3.472908133165533*^9, 3.472908168933487*^9}, 3.472908204359551*^9, {
   3.4729090795811777`*^9, 3.472909131501047*^9}, {3.472909182603491*^9, 
   3.4729091873598413`*^9}, {3.4729758899114027`*^9, 3.472975993050537*^9}, {
   3.472988315367649*^9, 3.472988320465564*^9}, {3.4729885161488543`*^9, 
   3.472988517517951*^9}, 3.474289930490778*^9, {3.4743706103566523`*^9, 
   3.474370686442527*^9}, {3.47437089742904*^9, 3.474370901101371*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSCanonize", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MPSCanonize", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Site", "\[Rule]", "1"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSCanonize", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSCanonize", "[", 
    RowBox[{"mps_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"site", "=", 
        RowBox[{"OptionValue", "[", "Site", "]"}]}], ",", "numTensors", ",", 
       "xM"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "mps", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"First", ":", " ", 
        RowBox[{
        "Right", " ", "normalization", " ", "up", " ", "to", " ", "site"}]}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"xM", "=", 
       RowBox[{"{", 
        RowBox[{"{", "1.", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "s", "]"}], "]"}], "=", 
          RowBox[{"SparseArray", "[", 
           RowBox[{"MPSCanonizeSite", "[", 
            RowBox[{
             RowBox[{"mps", "[", 
              RowBox[{"[", "s", "]"}], "]"}], ",", "xM"}], "]"}], "]"}]}], 
         ";"}], "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"s", ",", "numTensors", ",", 
          RowBox[{"site", "+", "1"}], ",", 
          RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Now", " ", "do", " ", "LEFT", " ", "normalization"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"xM", "=", 
       RowBox[{"{", 
        RowBox[{"{", "1.", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "s", "]"}], "]"}], "=", 
          RowBox[{"SparseArray", "[", 
           RowBox[{"MPSCanonizeSite", "[", 
            RowBox[{
             RowBox[{"mps", "[", 
              RowBox[{"[", "s", "]"}], "]"}], ",", "xM", ",", 
             RowBox[{"Direction", "\[Rule]", "\"\<Left\>\""}]}], "]"}], 
           "]"}]}], ";"}], "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"s", ",", "1", ",", 
          RowBox[{"site", "-", "1"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "site"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.47038043133191*^9, 3.4703804528672867`*^9}, {
   3.470387638009944*^9, 3.470387646874694*^9}, 3.47246913374358*^9, {
   3.472469829297296*^9, 3.472469833617672*^9}, {3.472469871716321*^9, 
   3.472469919168717*^9}, {3.4725454292387123`*^9, 3.472545452582137*^9}, {
   3.472799398452806*^9, 3.47279940227726*^9}, {3.472799547814547*^9, 
   3.472799623432804*^9}, {3.472799708360259*^9, 3.472799885377548*^9}, {
   3.472802142434319*^9, 3.472802158819228*^9}, {3.4728027641030197`*^9, 
   3.4728031467264633`*^9}, {3.472803227019786*^9, 3.47280334252566*^9}, {
   3.472803859925631*^9, 3.4728038936578903`*^9}, {3.4728041246554527`*^9, 
   3.47280415851094*^9}, {3.4728141773074913`*^9, 3.4728141780127974`*^9}, {
   3.4728142109670887`*^9, 3.472814217845005*^9}, {3.4728150286361628`*^9, 
   3.472815037166613*^9}, {3.47282218992724*^9, 3.472822246541328*^9}, {
   3.472822283288518*^9, 3.472822342565064*^9}, {3.4728223796851807`*^9, 
   3.472822424382967*^9}, 3.472822482087603*^9, {3.4728226200037394`*^9, 
   3.472822629724009*^9}, {3.472822675845084*^9, 3.472822679580763*^9}, {
   3.472822800031939*^9, 3.472822817330935*^9}, {3.472822988475267*^9, 
   3.472823034612584*^9}, {3.472879170950828*^9, 3.472879180563735*^9}, {
   3.472879259980986*^9, 3.4728792630245857`*^9}, {3.472879460330365*^9, 
   3.472879469219365*^9}, {3.472879943368863*^9, 3.4728799455017357`*^9}, 
   3.47288041559301*^9, {3.472895780753783*^9, 3.472895800358292*^9}, {
   3.472895874808771*^9, 3.472895926077297*^9}, {3.4728960889885798`*^9, 
   3.472896204650764*^9}, {3.472896240407856*^9, 3.472896389539443*^9}, {
   3.472896455144389*^9, 3.472896462952427*^9}, {3.4728967933834343`*^9, 
   3.4728968907535753`*^9}, {3.472897007588146*^9, 3.472897054774235*^9}, {
   3.4729054420018387`*^9, 3.4729054437502613`*^9}, {3.472905516411969*^9, 
   3.472905527472625*^9}, {3.472905578593405*^9, 3.4729056155667763`*^9}, 
   3.472905948246478*^9, 3.472906407856189*^9, {3.472906443660903*^9, 
   3.472906506387929*^9}, {3.472906536969001*^9, 3.472906546239655*^9}, 
   3.4729066043851624`*^9, {3.472906717746292*^9, 3.472906720847331*^9}, {
   3.472906769045422*^9, 3.472906860853746*^9}, {3.4729077525128107`*^9, 
   3.4729078825713387`*^9}, 3.4729079616744967`*^9, {3.4729081180763607`*^9, 
   3.472908119537073*^9}, {3.472908173767152*^9, 3.472908184314024*^9}, {
   3.472908216493116*^9, 3.472908224532613*^9}, {3.47290901809424*^9, 
   3.472909024528969*^9}, {3.4729758088654137`*^9, 3.472975842777125*^9}, 
   3.474289937022634*^9, {3.474370572677966*^9, 3.474370576500985*^9}, {
   3.474370798688612*^9, 3.4743707990532503`*^9}, {3.477121997017009*^9, 
   3.477122013834096*^9}, {3.478970744752268*^9, 3.47897074482351*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSCanonizationCheck", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MPSCanonizationCheck", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Site", "\[Rule]", "1"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSCanonizationCheck", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSCanonizationCheck", "[", 
    RowBox[{"mps_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"checksite", "=", 
        RowBox[{"OptionValue", "[", "Site", "]"}]}], ",", "numTensors", ",", 
       "spin", ",", "norm"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "mps", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"spin", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"mps", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"norm", "=", 
       RowBox[{"Sum", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Total", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Abs", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"mps", "[", 
                 RowBox[{"[", 
                  RowBox[{"site", ",", "s"}], "]"}], "]"}], ".", 
                RowBox[{"ConjugateTranspose", "[", 
                 RowBox[{"mps", "[", 
                  RowBox[{"[", 
                   RowBox[{"site", ",", "s"}], "]"}], "]"}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], "-", 
             RowBox[{"IdentityMatrix", "[", 
              RowBox[{"Length", "[", 
               RowBox[{"mps", "[", 
                RowBox[{"[", 
                 RowBox[{"site", ",", "1"}], "]"}], "]"}], 
               "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", "]"}]}], 
            "\[IndentingNewLine]", "]"}], ",", "Infinity"}], "]"}], 
         "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"site", ",", "numTensors", ",", 
           RowBox[{"checksite", "+", "1"}], ",", 
           RowBox[{"-", "1"}]}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"norm", "+=", 
       RowBox[{"Sum", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Total", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Abs", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", 
                 RowBox[{"mps", "[", 
                  RowBox[{"[", 
                   RowBox[{"site", ",", "s"}], "]"}], "]"}], "]"}], ".", 
                RowBox[{"mps", "[", 
                 RowBox[{"[", 
                  RowBox[{"site", ",", "s"}], "]"}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], "-", 
             RowBox[{"IdentityMatrix", "[", 
              RowBox[{"Length", "[", 
               RowBox[{"mps", "[", 
                RowBox[{"[", 
                 RowBox[{"site", ",", "1", ",", "1"}], "]"}], "]"}], 
               "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", "]"}]}], 
            "\[IndentingNewLine]", "]"}], ",", "Infinity"}], "]"}], 
         "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"site", ",", "1", ",", 
           RowBox[{"checksite", "-", "1"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Chop", "[", "norm", "]"}], "\[Equal]", "0"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4728144595619783`*^9, 3.472814627430078*^9}, {
   3.4728146853980427`*^9, 3.472814689758243*^9}, {3.472814820990467*^9, 
   3.472814859411484*^9}, {3.472814907202626*^9, 3.472814961990583*^9}, {
   3.472905982127469*^9, 3.4729062811913233`*^9}, {3.472906320486244*^9, 
   3.472906376457374*^9}, {3.472908265423276*^9, 3.472908351428247*^9}, {
   3.472908441637455*^9, 3.4729085047011137`*^9}, {3.472908546961834*^9, 
   3.472908547519918*^9}, {3.472908585537925*^9, 3.472908594144094*^9}, {
   3.472908636857095*^9, 3.4729086471966467`*^9}, {3.472908693928211*^9, 
   3.472908718963847*^9}, 3.47428772730665*^9, 3.474289941519754*^9, {
   3.474370523707288*^9, 3.4743705516889277`*^9}, {3.4743708058394623`*^9, 
   3.474370816598921*^9}}]
}, Closed]],

Cell[CellGroupData[{

Cell["Calculation of expectation values", "Subsection",
 CellChangeTimes->{{3.475821833592638*^9, 3.475821842712514*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MPSSiteOperator", "[", 
    RowBox[{"tensor_", ",", "operator_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Flatten", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"tensor", ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "1", ",", "2"}], "}"}]}], "]"}], ".", "operator",
         ".", 
        RowBox[{"Conjugate", "[", "tensor", "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"3", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.475822204230834*^9, 3.4758222345604563`*^9}, {
  3.475822678197173*^9, 3.475822730492358*^9}, {3.475822977713525*^9, 
  3.475822978809889*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MPSExpectation", "[", 
    RowBox[{"mps_", ",", "operator_", ",", "site_Integer"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"L", ",", "R", ",", "numTensors"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "mps", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R", "[", 
        RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
       RowBox[{"{", 
        RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R", "[", "n_", "]"}], ":=", 
       RowBox[{
        RowBox[{"R", "[", "n", "]"}], "=", 
        RowBox[{"RProduct", "[", 
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"R", "[", 
           RowBox[{"n", "+", "1"}], "]"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"L", "[", "0", "]"}], "=", 
       RowBox[{"{", 
        RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"L", "[", "n_", "]"}], ":=", 
       RowBox[{
        RowBox[{"L", "[", "n", "]"}], "=", 
        RowBox[{"LProduct", "[", 
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"L", "[", 
           RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Chop", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"L", "[", 
          RowBox[{"site", "-", "1"}], "]"}], "]"}], ".", 
        RowBox[{"MPSSiteOperator", "[", 
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "site", "]"}], "]"}], ",", "operator"}], "]"}], ".", 
        RowBox[{"Flatten", "[", " ", 
         RowBox[{"R", "[", 
          RowBox[{"site", "+", "1"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.475821872455428*^9, 3.475821939134164*^9}, {
  3.4758219780681868`*^9, 3.475822032607959*^9}, {3.47582214353074*^9, 
  3.475822162594906*^9}, {3.47582262772011*^9, 3.475822668515974*^9}, {
  3.475822754572332*^9, 3.475822780491611*^9}, {3.4758228133309717`*^9, 
  3.475822879551815*^9}, {3.475822918405306*^9, 3.4758229213799763`*^9}, {
  3.4758230527077427`*^9, 3.475823074960052*^9}, {3.4758346348642483`*^9, 
  3.4758346450235577`*^9}, {3.475834681586348*^9, 3.475834682605858*^9}, {
  3.475837889617421*^9, 3.475837893552219*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MPSExpectation", "[", 
    RowBox[{
    "mps_", ",", "operator_", ",", "site1_Integer", ",", "site2_Integer"}], 
    "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"L", ",", "R", ",", "numTensors"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"MPSExpectation", "[", 
      RowBox[{
      "mps", ",", "operator", ",", "site1", ",", "operator", ",", "site2"}], 
      "]"}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{3.475834687408527*^9}],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"MPSExpectation", "[", 
     RowBox[{
     "mps_", ",", "operator1_", ",", "site1_Integer", ",", "operator2_", ",", 
      "site2_Integer"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"L", ",", "R", ",", "numTensors"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Last", "[", 
       RowBox[{"MPSCorrelation", "[", 
        RowBox[{
        "mps", ",", "operator1", ",", "site1", ",", "operator2", ",", 
         "site2"}], "]"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MPSCorrelation", "[", 
    RowBox[{
    "mps_", ",", "operator1_", ",", "site1_Integer", ",", "operator2_", ",", 
     "site2_Integer"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "L", ",", "R", ",", "Lo", ",", "numTensors", ",", "siteL", ",", "siteR",
        ",", "opL", ",", "opR", ",", "NormalOrder", ",", "corr"}], "}"}], ",",
      "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "mps", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"0", "<", "site1", "<", "site2", "<", 
         RowBox[{"numTensors", "+", "1"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"siteL", ",", "siteR"}], "}"}], "=", 
          RowBox[{"{", 
           RowBox[{"site1", ",", "site2"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"opL", ",", "opR"}], "}"}], "=", 
          RowBox[{"{", 
           RowBox[{"operator1", ",", "operator2"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"NormalOrder", "=", "True"}], ";"}], "\[IndentingNewLine]", 
        ",", 
        RowBox[{"0", "<", "site2", "<", "site1", "<", 
         RowBox[{"numTensors", "+", "1"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"siteL", ",", "siteR"}], "}"}], "=", 
          RowBox[{"{", 
           RowBox[{"site2", ",", "site1"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"opL", ",", "opR"}], "}"}], "=", 
          RowBox[{"{", 
           RowBox[{"operator2", ",", "operator1"}], "}"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"NormalOrder", "=", "False"}], ";"}], "\[IndentingNewLine]", 
        ",", "True", ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
         "Print", "[", "\"\<MPSCorrelation called with wrong sites\>\"", 
          "]"}], ";", 
         RowBox[{"Abort", "[", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R", "[", 
        RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
       RowBox[{"{", 
        RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R", "[", "n_", "]"}], ":=", 
       RowBox[{
        RowBox[{"R", "[", "n", "]"}], "=", 
        RowBox[{"RProduct", "[", 
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"R", "[", 
           RowBox[{"n", "+", "1"}], "]"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"L", "[", "0", "]"}], "=", 
       RowBox[{"{", 
        RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"L", "[", "n_", "]"}], ":=", 
       RowBox[{
        RowBox[{"L", "[", "n", "]"}], "=", 
        RowBox[{"LProduct", "[", 
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"L", "[", 
           RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Lo", "[", "siteL", "]"}], "=", 
       RowBox[{"LProduct", "[", 
        RowBox[{
         RowBox[{"opL", ".", 
          RowBox[{"mps", "[", 
           RowBox[{"[", "siteL", "]"}], "]"}]}], ",", 
         RowBox[{"mps", "[", 
          RowBox[{"[", "siteL", "]"}], "]"}], ",", 
         RowBox[{"L", "[", 
          RowBox[{"siteL", "-", "1"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Lo", "[", "n_", "]"}], ":=", 
       RowBox[{
        RowBox[{"Lo", "[", "n", "]"}], "=", 
        RowBox[{"LProduct", "[", 
         RowBox[{
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"mps", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"Lo", "[", 
           RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"corr", "=", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Chop", "[", 
          RowBox[{
           RowBox[{"Flatten", "[", 
            RowBox[{"Lo", "[", 
             RowBox[{"site", "-", "1"}], "]"}], "]"}], ".", 
           RowBox[{"MPSSiteOperator", "[", 
            RowBox[{
             RowBox[{"mps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], ",", "opR"}], "]"}], ".", 
           RowBox[{"Flatten", "[", " ", 
            RowBox[{"R", "[", 
             RowBox[{"site", "+", "1"}], "]"}], "]"}]}], "]"}], 
         "\[IndentingNewLine]", ",", 
         RowBox[{"{", 
          RowBox[{"site", ",", 
           RowBox[{"siteL", "+", "1"}], ",", "siteR"}], "}"}]}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"NormalOrder", ",", "corr", ",", 
        RowBox[{"Reverse", "[", "corr", "]"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4758229488440323`*^9, 3.475822961441382*^9}, 
   3.475823186150878*^9, {3.475823818428958*^9, 3.4758238742908297`*^9}, {
   3.4758239051424913`*^9, 3.4758242067070293`*^9}, {3.4758242372245283`*^9, 
   3.475824238440568*^9}, {3.475824463774959*^9, 3.475824584932*^9}, {
   3.475824634716448*^9, 3.475824754031307*^9}, {3.475837880345994*^9, 
   3.47583788415526*^9}, {3.475837953147972*^9, 3.475837954455832*^9}, {
   3.47583802329186*^9, 3.475838031465795*^9}, {3.475860280935561*^9, 
   3.475860281686852*^9}}]
}, Closed]],

Cell[CellGroupData[{

       RowBox[{
               RowBox[{"canon", ".", "#"}], "&"}], "/@", 
              RowBox[{"newmps", "[", 
               Ro,

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSApproximate", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MPSApproximate", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"UseRandomState", "\[Rule]", "True"}], ",", 
     RowBox[{"Ansatz", "\[Rule]", 
      RowBox[{"{", "}"}]}], ",", 
     RowBox[{"Tolerance", "\[Rule]", "DefaultApproximationTolerance"}], ",", 
     RowBox[{"Sweeps", "\[Rule]", "DefaultSweeps"}], ",", 
     RowBox[{"Verbose", "\[Rule]", "False"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSApproximate", "[", 
    RowBox[{"mps_", ",", "new\[Chi]_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"sweeps", "=", 
        RowBox[{"OptionValue", "[", "Sweeps", "]"}]}], ",", 
       RowBox[{"sweep", "=", "0"}], ",", 
       RowBox[{"tol", "=", 
        RowBox[{"OptionValue", "[", "Tolerance", "]"}]}], ",", "L", ",", "R", 
       ",", "numTensors", ",", "defineRight", ",", "defineLeft", ",", 
       "\[Chi]R", ",", "\[Chi]L", ",", "new", ",", "canon", ",", 
       RowBox[{"stillconverging", "=", "True"}], ",", 
       RowBox[{"verbose", "=", 
        RowBox[{"OptionValue", "[", "Verbose", "]"}]}], ",", "message", ",", 
       "info", ",", "success", ",", "newmps", ",", "overlapBIG", ",", 
       "overlap", ",", "prevoverlap"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", 
        RowBox[{"message", "=", 
         RowBox[{
         "PrintTemporary", "[", "\"\<Preparing matrices\>\"", "]"}]}]}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Preparation", " ", "assignments"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"MPSNormalize", "[", "mps", "]"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "mps", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"overlapBIG", "=", 
       RowBox[{"MPSOverlap", "[", 
        RowBox[{"mps", ",", "mps"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"newmps", "=", 
       RowBox[{"MPSProductState", "[", 
        RowBox[{"numTensors", ",", 
         RowBox[{"Bond", "\[Rule]", "new\[Chi]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MPSCanonize", "[", "newmps", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"prevoverlap", "=", 
       RowBox[{"1", "+", "overlapBIG", "-", 
        RowBox[{"2", " ", 
         RowBox[{"Re", "[", 
          RowBox[{"MPSOverlap", "[", 
           RowBox[{"newmps", ",", "mps"}], "]"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "These", " ", "will", " ", "be", " ", "used", " ", "to", " ", "define",
         " ", "left", " ", "and", " ", "right", " ", "matrices"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"defineRight", "[", "temp_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "fer", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ClearAll", "[", "R", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"R", "[", 
            RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
           RowBox[{"{", 
            RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"R", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"R", "[", "n", "]"}], "=", 
            RowBox[{"RProduct", "[", 
             RowBox[{
              RowBox[{"mps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"newmps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"R", "[", 
               RowBox[{"n", "+", "1"}], "]"}]}], "]"}]}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"defineLeft", "[", "temp_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "fer", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ClearAll", "[", "L", "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"L", "[", "0", "]"}], "=", 
           RowBox[{"{", 
            RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"L", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"L", "[", "n", "]"}], "=", 
            RowBox[{"LProduct", "[", 
             RowBox[{
              RowBox[{"mps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"newmps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"L", "[", 
               RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"Start", " ", "from", " ", "the", " ", "left"}], ",", " ", 
        RowBox[{
        "so", " ", "prepare", " ", "all", " ", "right", " ", "matrices"}]}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"defineRight", "[", "1", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"sweep", "<", "sweeps"}], "&&", "stillconverging"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Sweep", " ", "to", " ", "the", " ", "right", " ", "clears", " ", 
          "all", " ", "left", " ", "matrices", " ", "and", " ", "defines", 
          " ", "them", " ", "one", " ", "by", " ", "one"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"defineLeft", "[", "1", "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"canon", "=", 
          RowBox[{"{", 
           RowBox[{"{", "1.", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{"verbose", ",", 
              RowBox[{
               RowBox[{"NotebookDelete", "[", "message", "]"}], ";", 
               RowBox[{"message", "=", 
                RowBox[{"PrintTemporary", "[", 
                 RowBox[{"\"\<Right sweep:\>\"", "<>", 
                  RowBox[{"ToString", "[", "sweep", "]"}], "<>", 
                  "\"\<, site:\>\"", "<>", 
                  RowBox[{"ToString", "[", "site", "]"}], "<>", 
                  "\"\<, overlap:\>\"", "<>", 
                  RowBox[{"ToString", "[", 
                   RowBox[{"1", "+", "overlapBIG", "-", 
                    RowBox[{"2", " ", 
                    RowBox[{"Re", "[", 
                    RowBox[{"MPSOverlap", "[", 
                    RowBox[{"newmps", ",", "mps"}], "]"}], "]"}]}]}], "]"}]}],
                  "]"}]}], ";", 
               RowBox[{"Pause", "[", "1", "]"}]}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"success", "=", "False"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"newmps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], "=", 
             RowBox[{
              RowBox[{
               RowBox[{"canon", ".", "#"}], "&"}], "/@", 
              RowBox[{"newmps", "[", 
               RowBox[{"[", "site", "]"}], "]"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"new", "=", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"L", "[", 
                 RowBox[{"site", "-", "1"}], "]"}], ".", "#", ".", 
                RowBox[{"R", "[", 
                 RowBox[{"site", "+", "1"}], "]"}]}], "&"}], "/@", 
              RowBox[{"mps", "[", 
               RowBox[{"[", "site", "]"}], "]"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"newmps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], "=", 
             RowBox[{"MPSCanonizeSite", "[", 
              RowBox[{"new", ",", "canon", ",", 
               RowBox[{"Direction", "\[Rule]", "\"\<Left\>\""}], ",", 
               RowBox[{"UseMatrix", "\[Rule]", "False"}]}], "]"}]}], ";"}], 
           " ", 
           RowBox[{"(*", " ", 
            RowBox[{"This", " ", "routine", " ", "changes", " ", "canon"}], 
            " ", "*)"}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"site", ",", "1", ",", "numTensors"}], "}"}]}], "]"}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"sweep", "+=", "0.5"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "Sweep", " ", "to", " ", "the", " ", "left", " ", "clears", " ", 
           "all", " ", "right", " ", "matrices", " ", "and", " ", "defines", 
           " ", "them", " ", "one", " ", "by", " ", "one"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"defineRight", "[", "1", "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"canon", "=", 
          RowBox[{"{", 
           RowBox[{"{", "1.", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{"verbose", ",", 
              RowBox[{
               RowBox[{"NotebookDelete", "[", "message", "]"}], ";", 
               RowBox[{"message", "=", 
                RowBox[{"PrintTemporary", "[", 
                 RowBox[{"\"\<Left sweep:\>\"", "<>", 
                  RowBox[{"ToString", "[", "sweep", "]"}], "<>", 
                  "\"\<, site:\>\"", "<>", 
                  RowBox[{"ToString", "[", "site", "]"}], "<>", 
                  "\"\<, overlap:\>\"", "<>", 
                  RowBox[{"ToString", "[", 
                   RowBox[{"1", "+", "overlapBIG", "-", 
                    RowBox[{"2", " ", 
                    RowBox[{"Re", "[", 
                    RowBox[{"MPSOverlap", "[", 
                    RowBox[{"newmps", ",", "mps"}], "]"}], "]"}]}]}], "]"}]}],
                  "]"}]}], ";", 
               RowBox[{"Pause", "[", "1", "]"}]}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"success", "=", "False"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"newmps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], "=", 
             RowBox[{
              RowBox[{"newmps", "[", 
               RowBox[{"[", "site", "]"}], "]"}], ".", "canon"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"new", "=", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"L", "[", 
                 RowBox[{"site", "-", "1"}], "]"}], ".", "#", ".", 
                RowBox[{"R", "[", 
                 RowBox[{"site", "+", "1"}], "]"}]}], "&"}], "/@", 
              RowBox[{"mps", "[", 
               RowBox[{"[", "site", "]"}], "]"}]}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"newmps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], "=", 
             RowBox[{"MPSCanonizeSite", "[", 
              RowBox[{"new", ",", "canon", ",", 
               RowBox[{"UseMatrix", "\[Rule]", "False"}]}], "]"}]}], ";"}], 
           "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"site", ",", "numTensors", ",", "1", ",", 
             RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"sweep", "+=", "0.5"}], ";", "\[IndentingNewLine]", 
         RowBox[{"overlap", "=", 
          RowBox[{"1", "+", "overlapBIG", "-", 
           RowBox[{"2", " ", 
            RowBox[{"Re", "[", 
             RowBox[{"MPSOverlap", "[", 
              RowBox[{"newmps", ",", "mps"}], "]"}], "]"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"overlap", "-", "prevoverlap"}], ")"}], "/", 
              "overlap"}], "]"}], "<", "tol"}], ",", 
           RowBox[{"stillconverging", "=", "False"}], ",", 
           RowBox[{"prevoverlap", "=", "overlap"}]}], "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", 
        RowBox[{"NotebookDelete", "[", "message", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "newmps"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4443765404996643`*^9, 3.444376621000937*^9}, {
   3.4443766527253857`*^9, 3.444376788463519*^9}, {3.444380845349071*^9, 
   3.4443808488620462`*^9}, {3.444383535340488*^9, 3.444383548976645*^9}, {
   3.444383607769555*^9, 3.444383614754386*^9}, {3.444383739588228*^9, 
   3.444383798523776*^9}, {3.444383864716886*^9, 3.444383953642898*^9}, {
   3.444384029663205*^9, 3.444384041087845*^9}, {3.444384125371831*^9, 
   3.444384169374001*^9}, {3.4443852138175793`*^9, 3.444385307602394*^9}, {
   3.444385343986657*^9, 3.444385437206875*^9}, {3.444385587453373*^9, 
   3.444385624506518*^9}, {3.444390721090723*^9, 3.444390770632975*^9}, {
   3.444392795054143*^9, 3.444392909616889*^9}, {3.444392941921829*^9, 
   3.444392972641303*^9}, {3.4443934125089617`*^9, 3.444393448748394*^9}, {
   3.444393483200157*^9, 3.444393536513731*^9}, {3.444482856739016*^9, 
   3.444482873028327*^9}, {3.444495023142972*^9, 3.444495043658746*^9}, {
   3.4444950937000837`*^9, 3.4444954511897993`*^9}, 3.44449550617177*^9, {
   3.44449729965657*^9, 3.444497313477889*^9}, {3.444498182522326*^9, 
   3.444498202116714*^9}, {3.444498844496708*^9, 3.444498860944283*^9}, {
   3.444500104869728*^9, 3.444500227438293*^9}, {3.44450046946587*^9, 
   3.444500493166306*^9}, {3.444501056610929*^9, 3.444501194993861*^9}, {
   3.444544816314869*^9, 3.444544843998971*^9}, {3.444544886799921*^9, 
   3.4445449352329197`*^9}, {3.444545029449926*^9, 3.444545042622488*^9}, {
   3.444548289960601*^9, 3.444548412018338*^9}, {3.444548506039153*^9, 
   3.444548626647581*^9}, {3.444548928537655*^9, 3.444549293136994*^9}, {
   3.4445494320532227`*^9, 3.444549645342897*^9}, {3.444549685550185*^9, 
   3.444549798841894*^9}, {3.4445498291527433`*^9, 3.444550008443818*^9}, {
   3.444550039861525*^9, 3.444550040435836*^9}, {3.4445500886891403`*^9, 
   3.44455028832065*^9}, {3.4445504561068563`*^9, 3.444550514503916*^9}, {
   3.444550557040464*^9, 3.444550619034524*^9}, 3.444550731513249*^9, 
   3.444550767324177*^9, {3.444550827792081*^9, 3.444550883875959*^9}, {
   3.444550931343766*^9, 3.444550933264237*^9}, 3.4445509825767403`*^9, {
   3.444551061205894*^9, 3.444551206802371*^9}, {3.444551239136883*^9, 
   3.44455131664515*^9}, {3.4445515923637857`*^9, 3.444551706732718*^9}, 
   3.444551740715315*^9, {3.4447133725962067`*^9, 3.4447133837080173`*^9}, 
   3.444722002992326*^9, {3.444729533531344*^9, 3.444729559419153*^9}, {
   3.444729751728437*^9, 3.444729758277514*^9}, 3.444733383924189*^9, 
   3.4447339067690907`*^9, {3.445370614543693*^9, 3.44537061529211*^9}, {
   3.445371597361609*^9, 3.445371607386128*^9}, 3.445578310211288*^9, {
   3.445580894371863*^9, 3.445580909567634*^9}, {3.445580941014928*^9, 
   3.445581022962903*^9}, {3.445581223842678*^9, 3.445581225214141*^9}, {
   3.44558142910614*^9, 3.4455814466096687`*^9}, {3.44558148602195*^9, 
   3.4455815076075172`*^9}, {3.4455815416333*^9, 3.4455816538818073`*^9}, 
   3.4455816852101707`*^9, {3.4455817279633713`*^9, 3.445581895629087*^9}, {
   3.445581926285453*^9, 3.4455819684060497`*^9}, {3.4455820192636547`*^9, 
   3.4455820932341757`*^9}, {3.445582132359572*^9, 3.445582132852916*^9}, {
   3.4455823805404577`*^9, 3.445582385057062*^9}, {3.445582943514946*^9, 
   3.445583023482471*^9}, {3.445589929933601*^9, 3.445589979635372*^9}, {
   3.4455907639984913`*^9, 3.445590928869316*^9}, {3.445590961104261*^9, 
   3.445591022034176*^9}, {3.4455910577500973`*^9, 3.4455911022153673`*^9}, {
   3.445591132246114*^9, 3.445591148868465*^9}, {3.445591195490962*^9, 
   3.4455912341751966`*^9}, {3.445591282455872*^9, 3.445591345479067*^9}, {
   3.4455947435959578`*^9, 3.4455947468561993`*^9}, {3.445594840760921*^9, 
   3.445594992904476*^9}, {3.445595053524987*^9, 3.4455951376058607`*^9}, {
   3.4455955770788927`*^9, 3.4455955910764*^9}, {3.44559562451641*^9, 
   3.445595658675082*^9}, {3.4455958553706093`*^9, 3.4455959397164297`*^9}, {
   3.445595977978849*^9, 3.445595988661606*^9}, {3.44559941321484*^9, 
   3.445599423818005*^9}, {3.445599650719776*^9, 3.4455997904024563`*^9}, {
   3.445599831132061*^9, 3.4455998323992443`*^9}, {3.445599932118249*^9, 
   3.445599982693046*^9}, {3.445600023437418*^9, 3.4456001526865892`*^9}, {
   3.445601276921191*^9, 3.445601290663335*^9}, {3.445601415758614*^9, 
   3.4456014432427*^9}, {3.445601499670607*^9, 3.445601524781487*^9}, {
   3.445601560397983*^9, 3.445601681998934*^9}, {3.4456027293509703`*^9, 
   3.445602907575808*^9}, {3.4456029640150213`*^9, 3.445603185448955*^9}, {
   3.44560434858912*^9, 3.445604393269392*^9}, {3.445604501122056*^9, 
   3.44560456894623*^9}, {3.445604615456334*^9, 3.44560477751538*^9}, 
   3.4456048365353928`*^9, {3.445604867934313*^9, 3.445604968024315*^9}, {
   3.4456055189636087`*^9, 3.4456055475422173`*^9}, {3.445605636738106*^9, 
   3.445605642483376*^9}, {3.445605678806547*^9, 3.445605697714254*^9}, {
   3.445623111258121*^9, 3.445623119157885*^9}, {3.446139423265971*^9, 
   3.4461396641109858`*^9}, {3.446139796116254*^9, 3.446139813720582*^9}, {
   3.446139912403901*^9, 3.446139938029613*^9}, {3.446180513715399*^9, 
   3.446180617596689*^9}, {3.446181074226674*^9, 3.446181080894432*^9}, {
   3.446182287744276*^9, 3.446182357082388*^9}, {3.446182906280058*^9, 
   3.446182908123258*^9}, {3.4461829782326403`*^9, 3.4461830408818493`*^9}, {
   3.4461832212186832`*^9, 3.446183372435504*^9}, {3.446183413511735*^9, 
   3.446183464422475*^9}, {3.4461835385571833`*^9, 3.446183640172803*^9}, {
   3.44618367019331*^9, 3.4461837546018553`*^9}, {3.446225555497944*^9, 
   3.446225556473302*^9}, {3.446231854061204*^9, 3.446231873313554*^9}, {
   3.4464023147696047`*^9, 3.44640234290294*^9}, 3.446402629927022*^9, {
   3.446402759693386*^9, 3.446402763905994*^9}, {3.4464035096421824`*^9, 
   3.446403548388894*^9}, {3.44640658257129*^9, 3.446406583594748*^9}, {
   3.446407373297098*^9, 3.4464073758975067`*^9}, {3.446408284583968*^9, 
   3.4464083165456963`*^9}, {3.4464091509261703`*^9, 3.4464091541430387`*^9}, 
   3.446552849758011*^9, {3.446553152262273*^9, 3.4465531817155323`*^9}, {
   3.446553419658877*^9, 3.446553455068903*^9}, {3.4465536409678717`*^9, 
   3.446553641266127*^9}, {3.446553679700659*^9, 3.446553679839316*^9}, {
   3.446705958317614*^9, 3.446705958467681*^9}, {3.446706029126227*^9, 
   3.446706065571612*^9}, {3.4467061455843077`*^9, 3.4467062137598877`*^9}, {
   3.446734912257629*^9, 3.446734945008244*^9}, {3.446798053710264*^9, 
   3.4467980573397913`*^9}, {3.446811855732024*^9, 3.446811871362973*^9}, {
   3.4468121231666403`*^9, 3.446812123736794*^9}, {3.4468184107229347`*^9, 
   3.4468184112550097`*^9}, {3.4468307501076183`*^9, 
   3.4468307564894953`*^9}, {3.4468378825090847`*^9, 3.446837902961784*^9}, 
   3.4468379877995243`*^9, {3.446883360522629*^9, 3.4468835051022167`*^9}, {
   3.446894476300198*^9, 3.44689450304813*^9}, {3.447003103620595*^9, 
   3.44700313471244*^9}, {3.4470031878830748`*^9, 3.4470031955977087`*^9}, {
   3.447051968020546*^9, 3.447051970422717*^9}, {3.447052124309792*^9, 
   3.447052187204918*^9}, {3.447052315933872*^9, 3.447052339623518*^9}, 
   3.447151347333955*^9, {3.44715410754714*^9, 3.447154185211667*^9}, {
   3.447568280920417*^9, 3.447568287301379*^9}, {3.4475683349280367`*^9, 
   3.447568353046476*^9}, {3.447568386226469*^9, 3.4475684016872053`*^9}, {
   3.447568525782098*^9, 3.447568527048648*^9}, {3.4475686769726877`*^9, 
   3.4475686813026457`*^9}, {3.4475687255113573`*^9, 
   3.4475687345380096`*^9}, {3.447585965235018*^9, 3.447585995499257*^9}, 
   3.447586399791279*^9, {3.475071254233754*^9, 3.475071261016061*^9}, {
   3.475071307899613*^9, 3.475071494783567*^9}, {3.475071554506633*^9, 
   3.475071556569894*^9}, {3.475071610889977*^9, 3.475071647910136*^9}, {
   3.4750716927489023`*^9, 3.475071709952148*^9}, {3.475071740182313*^9, 
   3.475071753504629*^9}, {3.47507179850033*^9, 3.4750718605543137`*^9}, 
   3.4750719179904137`*^9, {3.475071959403256*^9, 3.475071970682399*^9}, {
   3.475072030341511*^9, 3.475072053690596*^9}, {3.475072089061721*^9, 
   3.475072127580187*^9}, {3.475072257134226*^9, 3.47507230620751*^9}, {
   3.475072344111141*^9, 3.4750723770679207`*^9}, {3.4750725222031803`*^9, 
   3.475072524087139*^9}, {3.475072682225067*^9, 3.4750727284345922`*^9}, {
   3.475072806125242*^9, 3.475072914213834*^9}, {3.475073331501101*^9, 
   3.475073341418913*^9}, {3.475073441238715*^9, 3.475073467892231*^9}, {
   3.4750735163472767`*^9, 3.475073521840919*^9}, {3.475073553720043*^9, 
   3.475073581975562*^9}, {3.47507365260858*^9, 3.4750736835831537`*^9}, 
   3.47556466173713*^9}]
}, Closed]],

Cell[CellGroupData[{

7605616*^9}, {3.465275893836484*^9, 3.4652759156339073`*^9}, {
   3.4652759744600067`*^9, 3.465275992702661*^9}, {3.465276042057399*^9,

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSSave", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSSave", ",", "HoldFirst"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSSave", "[", 
    RowBox[{"MPS_", ",", "filename_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"numSites", ",", "spin"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numSites", "=", 
       RowBox[{"Length", "[", "MPS", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"spin", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"MPS", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"Export", "[", 
       RowBox[{
        RowBox[{"filename", "<>", "\"\<.info\>\""}], ",", 
        RowBox[{"{", 
         RowBox[{"numSites", ",", "spin"}], "}"}], ",", "\"\<Table\>\""}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Export", "[", 
            RowBox[{
             RowBox[{"filename", "<>", "\"\<.\>\"", "<>", 
              RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
              RowBox[{"ToString", "[", "s", "]"}], "<>", "\"\<.dat\>\""}], 
             ",", 
             RowBox[{"MPS", "[", 
              RowBox[{"[", 
               RowBox[{"n", ",", "s"}], "]"}], "]"}], ",", "\"\<Table\>\""}], 
            "]"}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], ";"}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"n", ",", "1", ",", "numSites"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Run", "[", 
       RowBox[{
       "\"\<tar -czf \>\"", "<>", "filename", "<>", "\"\<.MPSz \>\"", "<>", 
        "filename", "<>", "\"\<.*.dat \>\"", "<>", "filename", "<>", 
        "\"\<.info\>\""}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Run", "[", 
       RowBox[{
       "\"\<rm \>\"", "<>", "filename", "<>", "\"\<*.dat \>\"", "<>", 
        "filename", "<>", "\"\<.info\>\""}], "]"}]}]}], "\[IndentingNewLine]",
     "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465272381315712*^9, 3.465272466935622*^9}, {
   3.465274872039486*^9, 3.465275077441268*^9}, {3.46527516315172*^9, 
   3.4652751816887493`*^9}, {3.4652753073560953`*^9, 3.465275331904854*^9}, {
   3.465275685829495*^9, 3.465275757088855*^9}, {3.468437373340576*^9, 
   3.4684373911993933`*^9}, {3.4698597389623947`*^9, 
   3.4698598154100933`*^9}, {3.470387651211536*^9, 3.470387658566725*^9}, {
   3.4742702361820393`*^9, 3.474270241737054*^9}, {3.474270469066131*^9, 
   3.47427047764676*^9}, {3.474270716779476*^9, 3.474270875578041*^9}, {
   3.4742709181572313`*^9, 3.47427098952947*^9}, 3.474289946071347*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSRead", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSRead", "[", "filename_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "MPS", ",", "numSites", ",", "spin", ",", "\[Chi]", ",", "info"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"FileNames", "[", 
           RowBox[{"filename", "<>", "\"\<.MPSz\>\""}], "]"}], "]"}], "=!=", 
         "1"}], ",", 
        RowBox[{"Return", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Run", "[", 
       RowBox[{"\"\<tar -zxf \>\"", "<>", "filename", "<>", "\"\<.MPSz\>\""}],
        "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"FileNames", "[", 
           RowBox[{"filename", "<>", "\"\<.info\>\""}], "]"}], "]"}], "=!=", 
         "1"}], ",", 
        RowBox[{"Return", "[", "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"info", "=", 
       RowBox[{"Flatten", "[", 
        RowBox[{"Import", "[", 
         RowBox[{
          RowBox[{"filename", "<>", "\"\<.info\>\""}], ",", "\"\<Table\>\""}],
          "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"numSites", ",", "spin"}], "}"}], "=", "info"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MPS", "=", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"MPS", "=", 
          RowBox[{"Append", "[", 
           RowBox[{"MPS", ",", 
            RowBox[{"SparseArray", "[", 
             RowBox[{"Table", "[", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", 
                    RowBox[{"FileNames", "[", 
                    RowBox[{"filename", "<>", "\"\<.\>\"", "<>", 
                    RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
                    RowBox[{"ToString", "[", "s", "]"}], "<>", 
                    "\"\<.dat\>\""}], "]"}], "]"}], "=!=", "1"}], ",", 
                  RowBox[{
                   RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<Missing File \>\"", "<>", "filename", "<>", 
                    "\"\<.\>\"", "<>", 
                    RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
                    RowBox[{"ToString", "[", "s", "]"}], "<>", 
                    "\"\<.dat\>\""}], "]"}], ";", 
                   RowBox[{"Break", "[", "]"}]}]}], "]"}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"ToExpression", "[", "\[IndentingNewLine]", 
                 RowBox[{"Import", "[", 
                  RowBox[{
                   RowBox[{"filename", "<>", "\"\<.\>\"", "<>", 
                    RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
                    RowBox[{"ToString", "[", "s", "]"}], "<>", 
                    "\"\<.dat\>\""}], ",", "\"\<Table\>\""}], "]"}], 
                 "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ",", 
               RowBox[{"{", 
                RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], "]"}]}],
            "]"}]}], ";"}], "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"n", ",", "1", ",", "numSites"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Run", "[", 
       RowBox[{
       "\"\<rm \>\"", "<>", "filename", "<>", "\"\<*.dat \>\"", "<>", 
        "filename", "<>", "\"\<.info\>\""}], "]"}], ";", 
      "\[IndentingNewLine]", "MPS"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465272381315712*^9, 3.465272466935622*^9}, {
   3.465274872039486*^9, 3.465275077441268*^9}, {3.46527516315172*^9, 
   3.4652751816887493`*^9}, {3.4652753073560953`*^9, 3.465275331904854*^9}, {
   3.465275367081286*^9, 3.465275465554977*^9}, {3.465275606648999*^9, 
   3.465275625558902*^9}, 3.465275692829726*^9, {3.465275812721534*^9, 
   3.465275817605616*^9}, {3.465275893836484*^9, 3.4652759156339073`*^9}, {
   3.4652759744600067`*^9, 3.465275992702661*^9}, {3.465276042057399*^9, 
   3.465276066453537*^9}, {3.465276127582642*^9, 3.465276134162496*^9}, {
   3.4652762037779922`*^9, 3.4652762076892776`*^9}, {3.468437392947875*^9, 
   3.4684374018832207`*^9}, {3.468437441813343*^9, 3.4684374860230494`*^9}, {
   3.4698598243614063`*^9, 3.4698598800828333`*^9}, 3.4698599360139723`*^9, {
   3.470387662743244*^9, 3.4703876693156967`*^9}, {3.474270437332644*^9, 
   3.4742704375903873`*^9}, {3.4742710023601522`*^9, 3.474271016804064*^9}, {
   3.474271067766658*^9, 3.474271069639216*^9}, {3.4742711099794188`*^9, 
   3.4742711207100077`*^9}, {3.474271161804413*^9, 3.474271184982004*^9}, {
   3.4742714250285463`*^9, 3.4742714312623663`*^9}, 3.474289950519724*^9, 
   3.4758284413401127`*^9, {3.4758342834919567`*^9, 3.475834333658786*^9}, {
   3.475834397879198*^9, 3.4758344057466927`*^9}, {3.475835314806377*^9, 
   3.475835337573958*^9}, {3.477656526105036*^9, 3.4776566167922897`*^9}, {
   3.477657293594131*^9, 3.477657299511168*^9}, {3.477660519340774*^9, 
   3.4776605242474613`*^9}, {3.4776607238172913`*^9, 
   3.4776607782749662`*^9}, {3.4776608949604063`*^9, 3.477660896590267*^9}}]
}, Closed]],

Cell[CellGroupData[{

               RowBox[{
                  RowBox[{"RProduct", "[", 
                   RowBox[{
                    RowBox[{,

Cell[CellGroupData[{

        RowBox[{"[", "n", "]"}], "]"}], ",", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", "#"}], "]"}], "&"}], 
                ,

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSMinimizeEnergy", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MPSMinimizeEnergy", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Sweeps", "\[Rule]", "DefaultSweeps"}], ",", 
     RowBox[{"Tolerance", "\[Rule]", "DefaultEnergyTolerance"}], ",", 
     RowBox[{"MonitorEnergy", "\[Rule]", "True"}], ",", 
     RowBox[{"Verbose", "\[Rule]", "False"}], ",", 
     RowBox[{"Debug", "\[Rule]", "False"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSMinimizeEnergy", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSMinimizeEnergy", "[", 
    RowBox[{"mps_", ",", "HObject_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"energy", ",", 
       RowBox[{"prevEnergy", "=", "0"}], ",", 
       RowBox[{"energyList", "=", 
        RowBox[{"{", "}"}]}], ",", 
       RowBox[{"sweeps", "=", 
        RowBox[{"OptionValue", "[", "Sweeps", "]"}]}], ",", 
       RowBox[{"sweep", "=", "0"}], ",", "IntRange", ",", 
       RowBox[{"monitorenergy", "=", 
        RowBox[{"OptionValue", "[", "MonitorEnergy", "]"}]}], ",", 
       RowBox[{"tol", "=", 
        RowBox[{"OptionValue", "[", "Tolerance", "]"}]}], ",", "L", ",", "R", 
       ",", "fieldL", ",", "fieldR", ",", "operatorsR", ",", "operatorsL", 
       ",", "interactionsL", ",", "interactionsR", ",", "Heff", ",", 
       "numTensors", ",", "defineRight", ",", "defineLeft", ",", "\[Chi]R", 
       ",", "\[Chi]L", ",", "new", ",", "canon", ",", 
       RowBox[{"stillconverging", "=", "True"}], ",", 
       RowBox[{"verbose", "=", 
        RowBox[{"OptionValue", "[", "Verbose", "]"}]}], ",", "message", ",", 
       "info", ",", "success", ",", 
       RowBox[{"debug", "=", 
        RowBox[{"OptionValue", "[", "Debug", "]"}]}], ",", 
       RowBox[{"debuglist", "=", 
        RowBox[{"{", "}"}]}], ",", "debugMSG", ",", "HMatrix"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", 
        RowBox[{"message", "=", 
         RowBox[{
         "PrintTemporary", "[", "\"\<Preparing matrices\>\"", "]"}]}]}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Preparation", " ", "assignments"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"MPSNormalize", "[", "mps", "]"}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"IntRange", ",", "HMatrix"}], "}"}], "=", "HObject"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"MPSCanonize", "[", "mps", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "mps", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "These", " ", "will", " ", "be", " ", "used", " ", "to", " ", "define",
         " ", "left", " ", "and", " ", "right", " ", "matrices"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"defineRight", "[", "temp_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "fer", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ClearAll", "[", 
           RowBox[{
           "R", ",", "fieldR", ",", "operatorsR", ",", "interactionsR"}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"R", "[", 
            RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
           RowBox[{"{", 
            RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"R", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"R", "[", "n", "]"}], "=", 
            RowBox[{"RProduct", "[", 
             RowBox[{
              RowBox[{"mps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"mps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"R", "[", 
               RowBox[{"n", "+", "1"}], "]"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"fieldR", "[", 
            RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", "0", "}"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"fieldR", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"fieldR", "[", "n", "]"}], "=", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"RProduct", "[", 
                RowBox[{
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"fieldR", "[", 
                   RowBox[{"n", "+", "1"}], "]"}], "[", 
                  RowBox[{"[", "\[Alpha]", "]"}], "]"}]}], "]"}], "+", 
               RowBox[{
                RowBox[{"HMatrix", "[", 
                 RowBox[{"[", 
                  RowBox[{"\[Alpha]", ",", "n", ",", "n"}], "]"}], "]"}], 
                RowBox[{"RProduct", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"sigma", "[", "\[Alpha]", "]"}], ".", 
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ",", 
                  RowBox[{"mps", "[", 
                   RowBox[{"[", "n", "]"}], "]"}], ",", 
                  RowBox[{"R", "[", 
                   RowBox[{"n", "+", "1"}], "]"}]}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"operatorsR", "[", 
            RowBox[{"numTensors", "+", "2"}], "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"operatorsR", "[", 
            RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"operatorsR", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"operatorsR", "[", "n", "]"}], "=", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Prepend", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"RProduct", "[", 
                   RowBox[{
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", "#"}], "]"}], "&"}], 
                 "/@", 
                 RowBox[{"(", 
                  RowBox[{"Take", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"operatorsR", "[", 
                    RowBox[{"n", "+", "1"}], "]"}], "[", 
                    RowBox[{"[", "\[Alpha]", "]"}], "]"}], ",", 
                    RowBox[{"Min", "[", 
                    RowBox[{
                    RowBox[{"IntRange", "-", "1"}], ",", 
                    RowBox[{"Length", "[", 
                    RowBox[{
                    RowBox[{"operatorsR", "[", 
                    RowBox[{"n", "+", "1"}], "]"}], "[", 
                    RowBox[{"[", "\[Alpha]", "]"}], "]"}], "]"}]}], "]"}]}], 
                   "]"}], ")"}]}], ",", 
                RowBox[{"RProduct", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"sigma", "[", "\[Alpha]", "]"}], ".", 
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ",", 
                  RowBox[{"mps", "[", 
                   RowBox[{"[", "n", "]"}], "]"}], ",", 
                  RowBox[{"R", "[", 
                   RowBox[{"n", "+", "1"}], "]"}]}], "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"interactionsR", "[", 
            RowBox[{"numTensors", "+", "1"}], "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", "0", "}"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"interactionsR", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"interactionsR", "[", "n", "]"}], "=", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"RProduct", "[", 
                RowBox[{
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"interactionsR", "[", 
                   RowBox[{"n", "+", "1"}], "]"}], "[", 
                  RowBox[{"[", "\[Alpha]", "]"}], "]"}]}], "]"}], "+", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"HMatrix", "[", 
                  RowBox[{"[", 
                   RowBox[{"\[Alpha]", ",", "n", ",", 
                    RowBox[{
                    RowBox[{"n", "+", "1"}], ";;", 
                    RowBox[{"Min", "[", 
                    RowBox[{
                    RowBox[{"n", "+", "IntRange"}], ",", "numTensors"}], 
                    "]"}]}]}], "]"}], "]"}], ".", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"RProduct", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"sigma", "[", "\[Alpha]", "]"}], ".", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ",", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", "#"}], "]"}], "&"}], 
                   "/@", 
                   RowBox[{
                    RowBox[{"operatorsR", "[", 
                    RowBox[{"n", "+", "1"}], "]"}], "[", 
                    RowBox[{"[", "\[Alpha]", "]"}], "]"}]}], ")"}]}], ")"}]}],
               ",", 
              RowBox[{"{", 
               RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], 
          ";"}]}], "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"defineLeft", "[", "temp_", "]"}], ":=", 
       RowBox[{"Module", "[", 
        RowBox[{
         RowBox[{"{", "fer", "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"ClearAll", "[", 
           RowBox[{
           "L", ",", "fieldL", ",", "operatorsL", ",", "interactionsL"}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"L", "[", "0", "]"}], "=", 
           RowBox[{"{", 
            RowBox[{"{", "1", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"L", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"L", "[", "n", "]"}], "=", 
            RowBox[{"LProduct", "[", 
             RowBox[{
              RowBox[{"mps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"mps", "[", 
               RowBox[{"[", "n", "]"}], "]"}], ",", 
              RowBox[{"L", "[", 
               RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"fieldL", "[", "0", "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", "0", "}"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"fieldL", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"fieldL", "[", "n", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"LProduct", "[", 
                RowBox[{
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"fieldL", "[", 
                   RowBox[{"n", "-", "1"}], "]"}], "[", 
                  RowBox[{"[", "\[Alpha]", "]"}], "]"}]}], "]"}], "+", 
               RowBox[{
                RowBox[{"HMatrix", "[", 
                 RowBox[{"[", 
                  RowBox[{"\[Alpha]", ",", "n", ",", "n"}], "]"}], "]"}], 
                RowBox[{"LProduct", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"sigma", "[", "\[Alpha]", "]"}], ".", 
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ",", 
                  RowBox[{"mps", "[", 
                   RowBox[{"[", "n", "]"}], "]"}], ",", 
                  RowBox[{"L", "[", 
                   RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}]}], ",", 
              RowBox[{"{", 
               RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"operatorsL", "[", 
            RowBox[{"-", "1"}], "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"operatorsL", "[", "0", "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"operatorsL", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"operatorsL", "[", "n", "]"}], "=", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Prepend", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{
                  RowBox[{"LProduct", "[", 
                   RowBox[{
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", "#"}], "]"}], "&"}], 
                 "/@", 
                 RowBox[{"Take", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"operatorsL", "[", 
                    RowBox[{"n", "-", "1"}], "]"}], "[", 
                    RowBox[{"[", "\[Alpha]", "]"}], "]"}], ",", 
                   RowBox[{"Min", "[", 
                    RowBox[{
                    RowBox[{"IntRange", "-", "1"}], ",", 
                    RowBox[{"Length", "[", 
                    RowBox[{
                    RowBox[{"operatorsL", "[", 
                    RowBox[{"n", "-", "1"}], "]"}], "[", 
                    RowBox[{"[", "\[Alpha]", "]"}], "]"}], "]"}]}], "]"}]}], 
                  "]"}]}], ",", 
                RowBox[{"LProduct", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"sigma", "[", "\[Alpha]", "]"}], ".", 
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ",", 
                  RowBox[{"mps", "[", 
                   RowBox[{"[", "n", "]"}], "]"}], ",", 
                  RowBox[{"L", "[", 
                   RowBox[{"n", "-", "1"}], "]"}]}], "]"}]}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"interactionsL", "[", "0", "]"}], "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"{", "0", "}"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";",
           "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"interactionsL", "[", "n_", "]"}], ":=", 
           RowBox[{
            RowBox[{"interactionsL", "[", "n", "]"}], "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"LProduct", "[", 
                RowBox[{
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{"mps", "[", 
                  RowBox[{"[", "n", "]"}], "]"}], ",", 
                 RowBox[{
                  RowBox[{"interactionsL", "[", 
                   RowBox[{"n", "-", "1"}], "]"}], "[", 
                  RowBox[{"[", "\[Alpha]", "]"}], "]"}]}], "]"}], "+", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"Reverse", "[", 
                  RowBox[{"HMatrix", "[", 
                   RowBox[{"[", 
                    RowBox[{"\[Alpha]", ",", 
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{
                    RowBox[{"n", "-", "IntRange"}], ",", "1"}], "]"}], ";;", 
                    RowBox[{"n", "-", "1"}]}], ",", "n"}], "]"}], "]"}], 
                  "]"}], ".", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"LProduct", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"sigma", "[", "\[Alpha]", "]"}], ".", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}]}], ",", 
                    RowBox[{"mps", "[", 
                    RowBox[{"[", "n", "]"}], "]"}], ",", "#"}], "]"}], "&"}], 
                   "/@", 
                   RowBox[{
                    RowBox[{"operatorsL", "[", 
                    RowBox[{"n", "-", "1"}], "]"}], "[", 
                    RowBox[{"[", "\[Alpha]", "]"}], "]"}]}], ")"}]}], ")"}]}],
               ",", 
              RowBox[{"{", 
               RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], 
          ";"}]}], "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"Start", " ", "from", " ", "the", " ", "left"}], ",", " ", 
        RowBox[{
        "so", " ", "prepare", " ", "all", " ", "right", " ", "matrices"}]}], 
       " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"debugMSG", "[", 
        RowBox[{"text_", ",", "s_", ",", "Am_", ",", "energ_"}], "]"}], ":=", 
       
       RowBox[{"{", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"text", "<>", "\"\<, Site:\>\"", "<>", 
           RowBox[{"ToString", "[", "s", "]"}]}], ",", "\"\<\\nMPS:\>\"", ",", 
          RowBox[{"Am", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", 
          RowBox[{"Am", "[", 
           RowBox[{"[", "2", "]"}], "]"}], ",", "\"\<\\nInt: \>\"", ",", 
          RowBox[{
           RowBox[{"interactionsL", "[", 
            RowBox[{"s", "-", "1"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", 
          RowBox[{
           RowBox[{"interactionsR", "[", 
            RowBox[{"s", "+", "1"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", "\"\<\\nh: \>\"", ",", 
          RowBox[{
           RowBox[{"fieldL", "[", 
            RowBox[{"s", "-", "1"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", 
          RowBox[{
           RowBox[{"fieldR", "[", 
            RowBox[{"s", "+", "1"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", "\"\<\\nOps: \>\"", ",", 
          RowBox[{
           RowBox[{"operatorsL", "[", 
            RowBox[{"s", "-", "1"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", 
          RowBox[{
           RowBox[{"operatorsR", "[", 
            RowBox[{"s", "+", "1"}], "]"}], "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", "\"\<\\nelsH: \>\"", ",", 
          RowBox[{
           RowBox[{"HMatrix", "[", 
            RowBox[{"[", 
             RowBox[{"All", ",", 
              RowBox[{
               RowBox[{"Max", "[", 
                RowBox[{"1", ",", 
                 RowBox[{"s", "-", "IntRange"}]}], "]"}], ";;", "s"}], ",", 
              RowBox[{
               RowBox[{"Max", "[", 
                RowBox[{"1", ",", 
                 RowBox[{"s", "-", "IntRange"}]}], "]"}], ";;", 
               RowBox[{"Min", "[", 
                RowBox[{"numTensors", ",", 
                 RowBox[{"s", "+", "IntRange"}]}], "]"}]}]}], "]"}], "]"}], 
           "[", 
           RowBox[{"[", "3", "]"}], "]"}], ",", "\"\<\\nHeff: \>\"", ",", 
          RowBox[{"Sort", "[", 
           RowBox[{"Diagonal", "[", 
            RowBox[{"MPSEffectiveHam", "[", 
             RowBox[{
              RowBox[{"interactionsL", "[", 
               RowBox[{"s", "-", "1"}], "]"}], ",", 
              RowBox[{"interactionsR", "[", 
               RowBox[{"s", "+", "1"}], "]"}], ",", 
              RowBox[{"fieldL", "[", 
               RowBox[{"s", "-", "1"}], "]"}], ",", 
              RowBox[{"fieldR", "[", 
               RowBox[{"s", "+", "1"}], "]"}], ",", 
              RowBox[{"operatorsL", "[", 
               RowBox[{"s", "-", "1"}], "]"}], ",", 
              RowBox[{"operatorsR", "[", 
               RowBox[{"s", "+", "1"}], "]"}], ",", 
              RowBox[{"HMatrix", "[", 
               RowBox[{"[", 
                RowBox[{"All", ",", 
                 RowBox[{
                  RowBox[{"Max", "[", 
                   RowBox[{"1", ",", 
                    RowBox[{"s", "-", "IntRange"}]}], "]"}], ";;", "s"}], ",", 
                 RowBox[{
                  RowBox[{"Max", "[", 
                   RowBox[{"1", ",", 
                    RowBox[{"s", "-", "IntRange"}]}], "]"}], ";;", 
                  RowBox[{"Min", "[", 
                   RowBox[{"numTensors", ",", 
                    RowBox[{"s", "+", "IntRange"}]}], "]"}]}]}], "]"}], 
               "]"}]}], "]"}], "]"}], "]"}], ",", "\"\<\\nEnergy: \>\"", ",", 
          "energ"}], "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"defineRight", "[", "1", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"While", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"sweep", "<", "sweeps"}], "&&", "stillconverging"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Sweep", " ", "to", " ", "the", " ", "right", " ", "clears", " ", 
          "all", " ", "left", " ", "matrices", " ", "and", " ", "defines", 
          " ", "them", " ", "one", " ", "by", " ", "one"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"defineLeft", "[", "1", "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"canon", "=", 
          RowBox[{"{", 
           RowBox[{"{", "1.", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{"verbose", ",", 
              RowBox[{
               RowBox[{"NotebookDelete", "[", "message", "]"}], ";", 
               RowBox[{"message", "=", 
                RowBox[{"PrintTemporary", "[", 
                 RowBox[{"\"\<Right sweep:\>\"", "<>", 
                  RowBox[{"ToString", "[", "sweep", "]"}], "<>", 
                  "\"\<, site:\>\"", "<>", 
                  RowBox[{"ToString", "[", "site", "]"}], "<>", 
                  "\"\<, Energy:\>\"", "<>", 
                  RowBox[{"ToString", "[", "energy", "]"}]}], "]"}]}]}]}], 
             "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"debug", ",", 
              RowBox[{"debuglist", "=", 
               RowBox[{"debuglist", "~", "Join", "~", 
                RowBox[{"debugMSG", "[", 
                 RowBox[{"\"\<Before (Right)\>\"", ",", "site", ",", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"canon", ".", "#"}], "&"}], "/@", 
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "site", "]"}], "]"}]}], ",", "energy"}], 
                 "]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"success", "=", "False"}], ";", "\[IndentingNewLine]", 
            RowBox[{"While", "[", 
             RowBox[{
              RowBox[{"!", "success"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"energy", ",", "new", ",", "info"}], "}"}], "=", 
                RowBox[{"FindGroundMPSSite", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{
                    RowBox[{"canon", ".", "#"}], "&"}], "/@", 
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "site", "]"}], "]"}]}], ",", 
                  RowBox[{"interactionsL", "[", 
                   RowBox[{"site", "-", "1"}], "]"}], ",", 
                  RowBox[{"interactionsR", "[", 
                   RowBox[{"site", "+", "1"}], "]"}], ",", 
                  RowBox[{"fieldL", "[", 
                   RowBox[{"site", "-", "1"}], "]"}], ",", 
                  RowBox[{"fieldR", "[", 
                   RowBox[{"site", "+", "1"}], "]"}], ",", 
                  RowBox[{"operatorsL", "[", 
                   RowBox[{"site", "-", "1"}], "]"}], ",", 
                  RowBox[{"operatorsR", "[", 
                   RowBox[{"site", "+", "1"}], "]"}], ",", 
                  RowBox[{"HMatrix", "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", 
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{"1", ",", 
                    RowBox[{"site", "-", "IntRange"}]}], "]"}], ";;", 
                    "site"}], ",", 
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{"1", ",", 
                    RowBox[{"site", "-", "IntRange"}]}], "]"}], ";;", 
                    RowBox[{"Min", "[", 
                    RowBox[{"numTensors", ",", 
                    RowBox[{"site", "+", "IntRange"}]}], "]"}]}]}], "]"}], 
                   "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{"ForceUseInternalRoutine", ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"success", "=", "True"}], ";"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"success", "=", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IsLinkActive", "[", "]"}], "===", "1"}], ")"}]}],
                   ";", "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"!", "success"}], ",", 
                    RowBox[{
                    RowBox[{"Print", "[", "\"\<Fallen link...\>\"", "]"}], 
                    ";", 
                    RowBox[{"ClearLink", "[", "link", "]"}], ";", 
                    RowBox[{"EstablishLink", "[", "link", "]"}], ";", 
                    RowBox[{
                    "Print", "[", "\"\<And we're back.\>\"", "]"}]}]}], "]"}],
                   ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
             "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"mps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], "=", 
             RowBox[{"MPSCanonizeSite", "[", 
              RowBox[{"new", ",", "canon", ",", 
               RowBox[{"Direction", "\[Rule]", "\"\<Left\>\""}], ",", 
               RowBox[{"UseMatrix", "\[Rule]", "False"}]}], "]"}]}], ";", " ", 
            RowBox[{"(*", " ", 
             RowBox[{"This", " ", "routine", " ", "changes", " ", "canon"}], 
             " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"monitorenergy", ",", 
              RowBox[{"energyList", "=", 
               RowBox[{"energyList", "~", "Join", "~", 
                RowBox[{"{", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"energy", "/", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Conjugate", "[", 
                    RowBox[{"Flatten", "[", "new", "]"}], "]"}], ".", 
                    RowBox[{"Flatten", "[", "new", "]"}]}], ")"}]}], ",", 
                   "info"}], "}"}], "}"}]}]}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"debug", ",", 
              RowBox[{"debuglist", "=", 
               RowBox[{"debuglist", "~", "Join", "~", 
                RowBox[{"debugMSG", "[", 
                 RowBox[{"\"\<After (Right)\>\"", ",", "site", ",", 
                  RowBox[{"mps", "[", 
                   RowBox[{"[", "site", "]"}], "]"}], ",", 
                  RowBox[{"energy", "/", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Conjugate", "[", 
                    RowBox[{"Flatten", "[", "new", "]"}], "]"}], ".", 
                    RowBox[{"Flatten", "[", "new", "]"}]}], ")"}]}]}], 
                 "]"}]}]}]}], "]"}], ";"}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"site", ",", "1", ",", "numTensors"}], "}"}]}], "]"}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"sweep", "+=", "0.5"}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "Sweep", " ", "to", " ", "the", " ", "left", " ", "clears", " ", 
           "all", " ", "right", " ", "matrices", " ", "and", " ", "defines", 
           " ", "them", " ", "one", " ", "by", " ", "one"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"defineRight", "[", "1", "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"canon", "=", 
          RowBox[{"{", 
           RowBox[{"{", "1.", "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Do", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{"verbose", ",", 
              RowBox[{
               RowBox[{"NotebookDelete", "[", "message", "]"}], ";", 
               RowBox[{"message", "=", 
                RowBox[{"PrintTemporary", "[", 
                 RowBox[{"\"\<Left sweep:\>\"", "<>", 
                  RowBox[{"ToString", "[", "sweep", "]"}], "<>", 
                  "\"\<, site:\>\"", "<>", 
                  RowBox[{"ToString", "[", "site", "]"}], "<>", 
                  "\"\<, Energy:\>\"", "<>", 
                  RowBox[{"ToString", "[", "energy", "]"}]}], "]"}]}]}]}], 
             "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"debug", ",", 
              RowBox[{"debuglist", "=", 
               RowBox[{"debuglist", "~", "Join", "~", 
                RowBox[{"debugMSG", "[", 
                 RowBox[{"\"\<Before (Left)\>\"", ",", "site", ",", 
                  RowBox[{
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "site", "]"}], "]"}], ".", "canon"}], ",", 
                  "energy"}], "]"}]}]}]}], "]"}], ";", "\[IndentingNewLine]", 
            
            RowBox[{"success", "=", "False"}], ";", "\[IndentingNewLine]", 
            RowBox[{"While", "[", 
             RowBox[{
              RowBox[{"!", "success"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"energy", ",", "new", ",", "info"}], "}"}], "=", 
                RowBox[{"FindGroundMPSSite", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "site", "]"}], "]"}], ".", "canon"}], ",", 
                  RowBox[{"interactionsL", "[", 
                   RowBox[{"site", "-", "1"}], "]"}], ",", 
                  RowBox[{"interactionsR", "[", 
                   RowBox[{"site", "+", "1"}], "]"}], ",", 
                  RowBox[{"fieldL", "[", 
                   RowBox[{"site", "-", "1"}], "]"}], ",", 
                  RowBox[{"fieldR", "[", 
                   RowBox[{"site", "+", "1"}], "]"}], ",", 
                  RowBox[{"operatorsL", "[", 
                   RowBox[{"site", "-", "1"}], "]"}], ",", 
                  RowBox[{"operatorsR", "[", 
                   RowBox[{"site", "+", "1"}], "]"}], ",", 
                  RowBox[{"HMatrix", "[", 
                   RowBox[{"[", 
                    RowBox[{"All", ",", 
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{"1", ",", 
                    RowBox[{"site", "-", "IntRange"}]}], "]"}], ";;", 
                    "site"}], ",", 
                    RowBox[{
                    RowBox[{"Max", "[", 
                    RowBox[{"1", ",", 
                    RowBox[{"site", "-", "IntRange"}]}], "]"}], ";;", 
                    RowBox[{"Min", "[", 
                    RowBox[{"numTensors", ",", 
                    RowBox[{"site", "+", "IntRange"}]}], "]"}]}]}], "]"}], 
                   "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{"ForceUseInternalRoutine", ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"success", "=", "True"}], ";"}], ",", 
                 "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"success", "=", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"IsLinkActive", "[", "]"}], "===", "1"}], ")"}]}],
                   ";", "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"!", "success"}], ",", 
                    RowBox[{
                    RowBox[{"Print", "[", "\"\<Fallen link...\>\"", "]"}], 
                    ";", 
                    RowBox[{"ClearLink", "[", "link", "]"}], ";", 
                    RowBox[{"EstablishLink", "[", "link", "]"}], ";", 
                    RowBox[{
                    "Print", "[", "\"\<And we're back.\>\"", "]"}]}]}], "]"}],
                   ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
             "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"mps", "[", 
              RowBox[{"[", "site", "]"}], "]"}], "=", 
             RowBox[{"MPSCanonizeSite", "[", 
              RowBox[{"new", ",", "canon", ",", 
               RowBox[{"UseMatrix", "\[Rule]", "False"}]}], "]"}]}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"monitorenergy", ",", 
              RowBox[{"energyList", "=", 
               RowBox[{"energyList", "~", "Join", "~", 
                RowBox[{"{", 
                 RowBox[{"{", 
                  RowBox[{
                   RowBox[{"energy", "/", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Conjugate", "[", 
                    RowBox[{"Flatten", "[", "new", "]"}], "]"}], ".", 
                    RowBox[{"Flatten", "[", "new", "]"}]}], ")"}]}], ",", 
                   "info"}], "}"}], "}"}]}]}]}], "]"}], ";", 
            "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{"debug", ",", 
              RowBox[{"debuglist", "=", 
               RowBox[{"debuglist", "~", "Join", "~", 
                RowBox[{"debugMSG", "[", 
                 RowBox[{"\"\<After (Left)\>\"", ",", "site", ",", 
                  RowBox[{
                   RowBox[{"mps", "[", 
                    RowBox[{"[", "site", "]"}], "]"}], ".", "canon"}], ",", 
                  RowBox[{"energy", "/", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"Conjugate", "[", 
                    RowBox[{"Flatten", "[", "new", "]"}], "]"}], ".", 
                    RowBox[{"Flatten", "[", "new", "]"}]}], ")"}]}]}], 
                 "]"}]}]}]}], "]"}], ";"}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"site", ",", "numTensors", ",", "1", ",", 
             RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
         RowBox[{"sweep", "+=", "0.5"}], ";", "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"energy", "-", "prevEnergy"}], ")"}], "/", "energy"}], 
             "]"}], "<", "tol"}], ",", 
           RowBox[{"stillconverging", "=", "False"}], ",", 
           RowBox[{"prevEnergy", "=", "energy"}]}], "]"}], ";"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"verbose", ",", 
        RowBox[{"NotebookDelete", "[", "message", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Total", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "]"}], "&"}], "/@", 
           "energyList"}], "]"}], ">", "0"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Print", "[", "\"\<Arpack error reported:\>\"", "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"Print", "[", 
          RowBox[{"Cases", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "&"}], "/@", "energyList"}], 
            ",", 
            RowBox[{"Except", "[", "0", "]"}]}], "]"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"ClearAll", "[", 
       RowBox[{
       "energy", ",", "prevEnergy", ",", "sweeps", ",", "sweep", ",", 
        "IntRange", ",", "tol", ",", "L", ",", "R", ",", "fieldL", ",", 
        "fieldR", ",", "operatorsR", ",", "operatorsL", ",", "interactionsL", 
        ",", "interactionsR", ",", "Heff", ",", "numTensors", ",", 
        "defineRight", ",", "defineLeft", ",", "\[Chi]R", ",", "\[Chi]L", ",",
         "new", ",", "canon", ",", "stillconverging", ",", "verbose", ",", 
        "message", ",", "info", ",", "success"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"debug", ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", "1", "]"}], "]"}], "&"}], "/@", "energyList"}], ",",
           "debuglist"}], "}"}], ",", 
        RowBox[{"If", "[", 
         RowBox[{"monitorenergy", ",", 
          RowBox[{"Chop", "[", "energyList", "]"}], ",", 
          RowBox[{"Chop", "[", 
           RowBox[{"Last", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "&"}], "/@", "energyList"}], 
            "]"}], " ", "]"}]}], " ", "]"}]}], " ", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.47038593506258*^9, 3.4703860207303953`*^9}, {
   3.470386057081822*^9, 3.470386062010556*^9}, {3.470386151018937*^9, 
   3.470386241368249*^9}, {3.470386294813274*^9, 3.470386429970378*^9}, {
   3.470387435906084*^9, 3.47038746393287*^9}, {3.470387508120489*^9, 
   3.470387544758547*^9}, {3.4703876758461037`*^9, 3.47038801247714*^9}, {
   3.470388172807126*^9, 3.4703881935609627`*^9}, {3.4703882897220182`*^9, 
   3.470388455114801*^9}, {3.470388546438138*^9, 3.4703886133465233`*^9}, {
   3.4703888680827093`*^9, 3.470388948952372*^9}, {3.470389105772489*^9, 
   3.470389258965246*^9}, {3.470389373126343*^9, 3.470389454352173*^9}, 
   3.470389505757477*^9, {3.470389539599318*^9, 3.470389601047052*^9}, {
   3.470392648836461*^9, 3.470392661934046*^9}, {3.470392699761063*^9, 
   3.470392742709111*^9}, {3.470392811600292*^9, 3.470392828324542*^9}, {
   3.470392871787092*^9, 3.470393019929364*^9}, {3.470393131207349*^9, 
   3.470393183533696*^9}, {3.470393292970574*^9, 3.470393360585235*^9}, 
   3.470393422709688*^9, {3.470393614980279*^9, 3.470393627942342*^9}, {
   3.470394350002935*^9, 3.4703943505251637`*^9}, {3.470395649058576*^9, 
   3.470395652432088*^9}, {3.470396013002264*^9, 3.470396347540533*^9}, {
   3.4704000703048286`*^9, 3.470400074971488*^9}, {3.4704033058522797`*^9, 
   3.4704033245761623`*^9}, {3.4705654266399403`*^9, 
   3.4705654312465897`*^9}, {3.470566322346311*^9, 3.470566325779192*^9}, {
   3.470569490173929*^9, 3.470569500906703*^9}, {3.4723031103419228`*^9, 
   3.472303296424461*^9}, {3.4723033300918694`*^9, 3.472303657629505*^9}, {
   3.472360937959846*^9, 3.472360977009429*^9}, {3.472361178983973*^9, 
   3.472361213453759*^9}, {3.472361245617113*^9, 3.4723612511684723`*^9}, {
   3.4723613650601597`*^9, 3.4723613705802937`*^9}, {3.472361401877096*^9, 
   3.4723614076143513`*^9}, {3.47236176950142*^9, 3.472361773412737*^9}, {
   3.472361826746674*^9, 3.472361860132859*^9}, {3.472362123214497*^9, 
   3.472362124495801*^9}, {3.472362680747666*^9, 3.4723626814495373`*^9}, {
   3.4723627166647367`*^9, 3.472362823213214*^9}, {3.4723683592287188`*^9, 
   3.472368404863302*^9}, {3.472466790436739*^9, 3.4724668262958612`*^9}, {
   3.472468746065551*^9, 3.472468822012092*^9}, {3.4724688661129827`*^9, 
   3.472468909532505*^9}, {3.4724690599235573`*^9, 3.472469065140422*^9}, {
   3.47246959058676*^9, 3.4724696200312977`*^9}, {3.472469659527313*^9, 
   3.4724697230656776`*^9}, {3.472540851304552*^9, 3.47254086827559*^9}, {
   3.472540904189877*^9, 3.472540918416424*^9}, {3.472541151871336*^9, 
   3.472541303455452*^9}, {3.472541392498581*^9, 3.472541398467976*^9}, {
   3.4725415474551992`*^9, 3.4725415681822987`*^9}, {3.47254186786652*^9, 
   3.472541868517377*^9}, {3.472815165067711*^9, 3.4728151772132607`*^9}, {
   3.472815228174883*^9, 3.4728153067325697`*^9}, {3.472815341855158*^9, 
   3.47281536225593*^9}, {3.472908791611905*^9, 3.472908837371066*^9}, {
   3.472908885243223*^9, 3.472908992425804*^9}, {3.472973779241678*^9, 
   3.472973782653754*^9}, {3.472973878639957*^9, 3.4729738891269617`*^9}, {
   3.472973957619637*^9, 3.472973965790495*^9}, {3.472974042091576*^9, 
   3.47297405500149*^9}, {3.472974913867194*^9, 3.472974926777885*^9}, {
   3.4729770886767073`*^9, 3.472977108985909*^9}, {3.472977156022111*^9, 
   3.4729771828966017`*^9}, {3.4730555409988947`*^9, 3.473055550669602*^9}, {
   3.473055917310964*^9, 3.473056052054275*^9}, {3.4730560989082127`*^9, 
   3.473056137462349*^9}, {3.4730562354780817`*^9, 3.473056235901026*^9}, {
   3.473061246338748*^9, 3.473061251345203*^9}, {3.473062794231395*^9, 
   3.473062810154553*^9}, {3.47306284282691*^9, 3.473062909809984*^9}, {
   3.473072134180212*^9, 3.473072137369479*^9}, {3.473079853790618*^9, 
   3.473079863126197*^9}, {3.47313864159649*^9, 3.473138710508428*^9}, {
   3.4731405068257217`*^9, 3.473140584245392*^9}, 3.473140626671767*^9, {
   3.4731406932936077`*^9, 3.473140696473377*^9}, {3.473158777556841*^9, 
   3.473158849483766*^9}, {3.47315889878648*^9, 3.4731589255783033`*^9}, {
   3.473163757290359*^9, 3.473163778894885*^9}, {3.473664281816229*^9, 
   3.4736642988374567`*^9}, {3.473664579704258*^9, 3.4736646086794643`*^9}, {
   3.4736655032836637`*^9, 3.4736655117481337`*^9}, {3.4736656728945427`*^9, 
   3.473665810624337*^9}, 3.473684853803295*^9, {3.473685226775989*^9, 
   3.473685232275241*^9}, {3.473686353932741*^9, 3.473686434119752*^9}, {
   3.47368648936101*^9, 3.473686527340711*^9}, 3.473686620974968*^9, {
   3.4736869704445057`*^9, 3.473686977042104*^9}, 3.4736874113544273`*^9, {
   3.473688834538589*^9, 3.473688870581648*^9}, {3.4737487499640713`*^9, 
   3.4737487521199503`*^9}, {3.473749014698008*^9, 3.4737490377270603`*^9}, {
   3.474266197297518*^9, 3.4742661994487534`*^9}, {3.474266230481839*^9, 
   3.474266233213602*^9}, {3.474287436065987*^9, 3.474287436410521*^9}, {
   3.474287677849069*^9, 3.474287681351087*^9}, {3.4742899760716343`*^9, 
   3.4742900040976143`*^9}, {3.4743675873242893`*^9, 3.474367606597677*^9}, {
   3.474367644116585*^9, 3.474367699916924*^9}, {3.4743677333263597`*^9, 
   3.474367960593758*^9}, {3.474368073217375*^9, 3.474368073314631*^9}, {
   3.474368138862409*^9, 3.474368140059416*^9}, {3.474368233961954*^9, 
   3.474368234440123*^9}, {3.474368548001101*^9, 3.474368653746101*^9}, {
   3.4743699739217157`*^9, 3.474370021711238*^9}, {3.474370341813692*^9, 
   3.4743703557555723`*^9}, {3.474370442702972*^9, 3.474370487357164*^9}, {
   3.477993327888171*^9, 3.4779933347619762`*^9}, {3.478275351817935*^9, 
   3.478275386061162*^9}, {3.478275420841116*^9, 3.4782754514200163`*^9}, {
   3.478281582323044*^9, 3.4782815838796864`*^9}, {3.478941710138761*^9, 
   3.478941726947761*^9}, {3.4789417649177094`*^9, 3.47894187089723*^9}, {
   3.4789419436326923`*^9, 3.47894209975813*^9}, {3.478942492247805*^9, 
   3.4789425237009783`*^9}, {3.4789688860072203`*^9, 3.478968961676791*^9}, {
   3.478969009804345*^9, 3.4789690300536633`*^9}, {3.478969061655991*^9, 
   3.4789691083717747`*^9}, {3.478969205662258*^9, 3.478969746718951*^9}, {
   3.47896988122686*^9, 3.478969910907045*^9}, {3.478970358937948*^9, 
   3.478970367182109*^9}, {3.478972786262786*^9, 3.478972789967381*^9}, {
   3.478972872221642*^9, 3.478972874389616*^9}, {3.4892343237352962`*^9, 
   3.489234380819088*^9}, {3.48923452515304*^9, 3.4892345275655527`*^9}, {
   3.489236654529242*^9, 3.489236667814723*^9}, 3.489236731036437*^9, {
   3.489236942192624*^9, 3.489236969429068*^9}, {3.489237048867465*^9, 
   3.489237115819777*^9}, {3.489237544417131*^9, 3.4892375472515697`*^9}, {
   3.489305059677371*^9, 3.4893051705619307`*^9}, {3.489305309299806*^9, 
   3.48930536021852*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Site energy minimization and MathLink", "Subsection",
 CellChangeTimes->{{3.470385841671874*^9, 3.470385848926193*^9}, {
  3.4718568024743013`*^9, 3.471856803158327*^9}, {3.472908746133456*^9, 
  3.47290875011621*^9}, {3.473752535170722*^9, 3.473752542792688*^9}, {
  3.489305393065928*^9, 3.489305396110572*^9}}],

   RowBox[{"sigma", "[", "0", "]"}]}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"y", ",", "1", ",", "intrangeR"}], "}"}]}], "]"}], ",", 
         RowBox[{"{,

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"Define", " ", "internal", " ", "versions"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ClearAll", "[", "MPSEffectiveSingleHam", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"MPSEffectiveSingleHam", ",", "HoldAll"}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"MPSEffectiveSingleHam", "[", 
      RowBox[{"L_", ",", "R_", ",", "op_"}], "]"}], ":=", 
     RowBox[{"(*", 
      RowBox[{"KroneckerProduct", "[", 
       RowBox[{"op", ",", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"{", "L", "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"3", ",", "1", ",", "2"}], "}"}]}], "]"}], ".", 
            RowBox[{"{", "R", "}"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"4", ",", "1"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"3", ",", "2"}], "}"}]}], "}"}]}], "]"}], "]"}]}], 
       " "}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"KroneckerProduct", "[", 
      RowBox[{"op", ",", "L", ",", 
       RowBox[{"Transpose", "[", "R", "]"}]}], "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->True],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "MPSEffectiveHam", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSEffectiveHam", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSEffectiveHam", "[", 
    RowBox[{
    "interactionsL_", ",", "interactionsR_", ",", "fieldL_", ",", "fieldR_", 
     ",", "operatorsL_", ",", "operatorsR_", ",", "Hmatrix_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"Htemp", "=", "0"}], ",", "\[Chi]L", ",", "\[Chi]R", ",", 
       "intrangeL", ",", "intrangeR", ",", "L", ",", "R"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Preparation", " ", "of", " ", "internal", " ", "matrices", " ", "and", 
       " ", "constants"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"intrangeL", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"operatorsL", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"intrangeR", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"operatorsR", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"\[Chi]L", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"fieldL", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"\[Chi]R", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"fieldR", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"L", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"IdentityMatrix", "[", "\[Chi]L", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"R", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"IdentityMatrix", "[", "\[Chi]R", "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "First", " ", "compute", " ", "the", " ", "contribution", " ", "from", 
        " ", "the", " ", "fields", " ", "h"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Htemp", "=", " ", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"MPSEffectiveSingleHam", "[", 
          RowBox[{"L", ",", 
           RowBox[{"fieldR", "[", 
            RowBox[{"[", "\[Alpha]", "]"}], "]"}], ",", 
           RowBox[{"sigma", "[", "0", "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Htemp", "+=", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"MPSEffectiveSingleHam", "[", 
          RowBox[{
           RowBox[{"fieldL", "[", 
            RowBox[{"[", "\[Alpha]", "]"}], "]"}], ",", "R", ",", 
           RowBox[{"sigma", "[", "0", "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Now", " ", "compute", " ", "the", " ", "contribution", " ", "from", 
        " ", "the", " ", "interactions", " ", "contained", " ", "in", " ", 
        "the", " ", "right", " ", "and", " ", "left", " ", "blocks"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Htemp", "+=", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"MPSEffectiveSingleHam", "[", 
          RowBox[{
           RowBox[{"interactionsL", "[", 
            RowBox[{"[", "\[Alpha]", "]"}], "]"}], ",", "R", ",", 
           RowBox[{"sigma", "[", "0", "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Htemp", "+=", " ", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"MPSEffectiveSingleHam", "[", 
          RowBox[{"L", ",", 
           RowBox[{"interactionsR", "[", 
            RowBox[{"[", "\[Alpha]", "]"}], "]"}], ",", 
           RowBox[{"sigma", "[", "0", "]"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Now", " ", "compute", " ", "the", " ", "interactions", " ", "between",
         " ", "the", " ", "left", " ", "and", " ", "right", " ", "blocks", 
        " ", "that", " ", "do", " ", "not", " ", "involve", " ", "the", " ", 
        "spin", " ", "at", " ", "the", " ", "site"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Htemp", "+=", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{"MPSEffectiveSingleHam", "[", 
              RowBox[{
               RowBox[{"operatorsL", "[", 
                RowBox[{"[", 
                 RowBox[{"\[Alpha]", ",", "x"}], "]"}], "]"}], ",", 
               RowBox[{"operatorsR", "[", 
                RowBox[{"[", 
                 RowBox[{"\[Alpha]", ",", "y"}], "]"}], "]"}], ",", 
               RowBox[{
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{"x", "+", "y", "-", "1"}], ")"}], "<", 
                   RowBox[{"Max", "[", 
                    RowBox[{"intrangeL", ",", "intrangeR"}], "]"}]}], ",", 
                  RowBox[{"Hmatrix", "[", 
                   RowBox[{"[", 
                    RowBox[{"\[Alpha]", ",", 
                    RowBox[{"intrangeL", "+", "1", "-", "x"}], ",", 
                    RowBox[{"intrangeL", "+", "1", "+", "y"}]}], "]"}], "]"}],
                   ",", "0"}], "]"}], 
                RowBox[{"sigma", "[", "0", "]"}]}]}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"y", ",", "1", ",", "intrangeR"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "1", ",", "intrangeL"}], "}"}]}], "]"}]}], ";", 
      " ", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Now", " ", "add", " ", "the", " ", "term", " ", "with", " ", "the", 
        " ", "field", " ", "at", " ", "the", " ", "site"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Htemp", "+=", " ", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"MPSEffectiveSingleHam", "[", 
          RowBox[{"L", ",", "R", ",", 
           RowBox[{
            RowBox[{"Hmatrix", "[", 
             RowBox[{"[", 
              RowBox[{"\[Alpha]", ",", 
               RowBox[{"intrangeL", "+", "1"}], ",", 
               RowBox[{"intrangeL", "+", "1"}]}], "]"}], "]"}], 
            RowBox[{"sigma", "[", "\[Alpha]", "]"}]}]}], " ", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Finally", ",", " ", 
        RowBox[{
        "the", " ", "interactions", " ", "between", " ", "the", " ", "site", 
         " ", "and", " ", "the", " ", "left", " ", "and", " ", "right", " ", 
         "blocks"}]}], " ", "*)"}], " ", 
      RowBox[{"Htemp", "+=", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{"MPSEffectiveSingleHam", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"operatorsL", "[", 
               RowBox[{"[", 
                RowBox[{"\[Alpha]", ",", "x"}], "]"}], "]"}], 
              RowBox[{"Hmatrix", "[", 
               RowBox[{"[", 
                RowBox[{"\[Alpha]", ",", 
                 RowBox[{"intrangeL", "+", "1", "-", "x"}], ",", 
                 RowBox[{"intrangeL", "+", "1"}]}], "]"}], "]"}]}], ",", "R", 
             ",", 
             RowBox[{"sigma", "[", "\[Alpha]", "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "1", ",", "intrangeL"}], "}"}]}], "]"}]}], ";", 
      " ", "\[IndentingNewLine]", 
      RowBox[{"Htemp", "+=", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{"MPSEffectiveSingleHam", "[", 
            RowBox[{"L", ",", 
             RowBox[{"operatorsR", "[", 
              RowBox[{"[", 
               RowBox[{"\[Alpha]", ",", "x"}], "]"}], "]"}], ",", 
             RowBox[{
              RowBox[{"Hmatrix", "[", 
               RowBox[{"[", 
                RowBox[{"\[Alpha]", ",", 
                 RowBox[{"intrangeL", "+", "1"}], ",", 
                 RowBox[{"intrangeL", "+", "1", "+", "x"}]}], "]"}], "]"}], 
              RowBox[{"sigma", "[", "\[Alpha]", "]"}]}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"x", ",", "1", ",", "intrangeR"}], "}"}]}], "]"}]}], ";", 
      " ", "\[IndentingNewLine]", 
      RowBox[{"Return", "[", "Htemp", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4742900638465767`*^9, 3.474290064534865*^9}, {
  3.478267732179843*^9, 3.478267748412756*^9}, {3.478267806661269*^9, 
  3.478267951123698*^9}, {3.478268335544097*^9, 3.47826837223724*^9}, {
  3.47827471538873*^9, 3.478274719743976*^9}, {3.4782748106562757`*^9, 
  3.478274899925156*^9}, {3.478275044705249*^9, 3.47827506017914*^9}, {
  3.4782751782799892`*^9, 3.4782752005442953`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "FindGroundMPSSiteManual", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"FindGroundMPSSiteManual", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FindGroundMPSSiteManual", "[", 
    RowBox[{
    "A_", ",", "DLeft_", ",", "DRight_", ",", "hLeft_", ",", "hRight_", ",", 
     "vLeft_", ",", "vRight_", ",", "Ham_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"H", ",", "sol", ",", "\[Chi]L", ",", "\[Chi]R", ",", "spin"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "Print", "[", 
        "\"\<Link could not be established, reverting to internal routines...\
\>\"", "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"H", "=", 
       RowBox[{"MPSEffectiveHam", "[", 
        RowBox[{
        "DLeft", ",", "DRight", ",", "hLeft", ",", "hRight", ",", "vLeft", 
         ",", "vRight", ",", "Ham"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"sol", "=", 
       RowBox[{"Eigensystem", "[", 
        RowBox[{
         RowBox[{"-", "H"}], ",", "1", ",", 
         RowBox[{"Method", "\[Rule]", 
          RowBox[{"{", 
           RowBox[{"\"\<Arnoldi\>\"", ",", 
            RowBox[{"MaxIterations", "\[Rule]", 
             RowBox[{"10", "^", "5"}]}], ",", 
            RowBox[{"Criteria", "\[Rule]", "RealPart"}]}], "}"}]}]}], "]"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"spin", ",", "\[Chi]L", ",", "\[Chi]R"}], "}"}], "=", 
       RowBox[{"Dimensions", "[", "A", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"Chop", "[", 
         RowBox[{"-", 
          RowBox[{"sol", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"Chop", "[", 
         RowBox[{"-", 
          RowBox[{"Partition", "[", 
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"sol", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", "\[Chi]R"}], 
             "]"}], ",", "\[Chi]L"}], "]"}]}], "]"}], ",", "0"}], "}"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.47429096464469*^9, 3.474290983810234*^9}, {
  3.474368872492733*^9, 3.474368893065156*^9}, {3.475841777887886*^9, 
  3.4758417889046307`*^9}, {3.477992855901083*^9, 3.477992857862541*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "This", " ", "clears", " ", "a", " ", "link", " ", "and", " ", 
    "associated", " ", "variables"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ClearLink", "[", "LINK_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Uninstall", "[", "LINK", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"ClearAll", "[", 
        RowBox[{"FindGroundMPSSite", ",", "IsLinkActive"}], "]"}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.472283648133987*^9, 3.472283648239442*^9}, {
   3.4722964690046663`*^9, 3.472296470200568*^9}, {3.472296891500771*^9, 
   3.47229691532302*^9}, {3.472296948747177*^9, 3.4722969701401978`*^9}, {
   3.4722970263362513`*^9, 3.472297149702573*^9}, 3.472297189939457*^9, {
   3.47229722593467*^9, 3.472297226145657*^9}, {3.472297273080632*^9, 
   3.472297444885537*^9}, {3.4722974915230923`*^9, 3.4722976125808764`*^9}, {
   3.472297699461952*^9, 3.472297798995695*^9}, {3.472297836785907*^9, 
   3.4722978598552103`*^9}, {3.4722985364450817`*^9, 3.472298540230344*^9}, {
   3.472298660714017*^9, 3.4722986943667603`*^9}, {3.4723029938196507`*^9, 
   3.47230299600224*^9}, {3.472304117933058*^9, 3.472304127990782*^9}, 
   3.472304237320222*^9, {3.4723042816820087`*^9, 3.472304305288521*^9}, {
   3.4723044854593163`*^9, 3.472304485637308*^9}, {3.472364913985564*^9, 
   3.472364982185463*^9}, {3.472365015783205*^9, 3.472365019842458*^9}, {
   3.472365059698649*^9, 3.472365123291648*^9}, {3.472365164940565*^9, 
   3.472365168947329*^9}, {3.472365500572953*^9, 3.4723655007746964`*^9}, {
   3.4723655325154448`*^9, 3.472365534186139*^9}, {3.472365576021791*^9, 
   3.472365597798259*^9}, {3.472368413776658*^9, 3.472368484623026*^9}, {
   3.472383471213027*^9, 3.4723835270570374`*^9}, {3.472383564815086*^9, 
   3.472383607504404*^9}, {3.472383674898131*^9, 3.472383679423938*^9}, 
   3.472383723221787*^9, {3.472446800477441*^9, 3.472446866739683*^9}, {
   3.4724476215414248`*^9, 3.4724476835933743`*^9}, {3.472447791179535*^9, 
   3.47244783866899*^9}, {3.472447949410535*^9, 3.472447955573964*^9}, {
   3.472461946876603*^9, 3.472461988003725*^9}, {3.4724622250272627`*^9, 
   3.472462229347892*^9}, {3.472462668406865*^9, 3.4724626811775017`*^9}, {
   3.4724632525473957`*^9, 3.472463255047127*^9}, {3.472463302876422*^9, 
   3.4724633419543343`*^9}, {3.472463443599822*^9, 3.4724634458274403`*^9}, 
   3.472465096792375*^9, 3.472465491973991*^9, {3.472465791544579*^9, 
   3.472465792958304*^9}, 3.472465856639831*^9, {3.4724662571654787`*^9, 
   3.4724662614260187`*^9}, {3.472466359910165*^9, 3.472466362868636*^9}, {
   3.472466417053977*^9, 3.472466421960165*^9}, {3.472466469125894*^9, 
   3.472466471882043*^9}, {3.472466527979617*^9, 3.472466531733891*^9}, 
   3.472466617746731*^9, {3.472540819288031*^9, 3.472540826443898*^9}, {
   3.473061267297624*^9, 3.4730613124011602`*^9}, {3.473061345179956*^9, 
   3.4730614433798933`*^9}, {3.473061728706752*^9, 3.4730617316225*^9}, {
   3.473081491692821*^9, 3.473081644269205*^9}, {3.473164369526013*^9, 
   3.473164423765148*^9}, {3.4731645455285673`*^9, 3.473164570619987*^9}, {
   3.473423901289851*^9, 3.473424071040435*^9}, {3.4734241486325274`*^9, 
   3.4734241491233187`*^9}, 3.4734245373771353`*^9, {3.473424813945838*^9, 
   3.473424818017078*^9}, {3.473424908641181*^9, 3.473424944264028*^9}, {
   3.473617377068969*^9, 3.47361740167651*^9}, 3.473617440128517*^9, {
   3.473620472262801*^9, 3.473620478720886*^9}, {3.473620759473565*^9, 
   3.473620764034751*^9}, {3.473620880190831*^9, 3.473620883070045*^9}, {
   3.473620920716528*^9, 3.473620927383193*^9}, {3.473664630130528*^9, 
   3.473664630422398*^9}, {3.473669679638002*^9, 3.4736697587400208`*^9}, {
   3.473669838523678*^9, 3.473669848866706*^9}, {3.473669911297258*^9, 
   3.47366991139924*^9}, {3.4736720532828617`*^9, 3.47367205384171*^9}, {
   3.473672152365259*^9, 3.4736721527825623`*^9}, {3.473677310400638*^9, 
   3.473677312190044*^9}, {3.473683932504662*^9, 3.4736839326400843`*^9}, {
   3.47368553729045*^9, 3.473685537794588*^9}, 3.4737704098622913`*^9, {
   3.474198108167946*^9, 3.474198130482132*^9}, {3.474264645224831*^9, 
   3.4742646753433847`*^9}, {3.474290056860362*^9, 3.4742900583419228`*^9}, {
   3.474290903615163*^9, 3.474290950496068*^9}, {3.4742910265255423`*^9, 
   3.4742910798673267`*^9}, {3.474291334180623*^9, 3.4742913347375603`*^9}, {
   3.474370106093246*^9, 3.4743701091834993`*^9}, {3.4779928514314013`*^9, 
   3.477992851948978*^9}, {3.489237253386888*^9, 3.489237253873165*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Now", " ", "try", " ", "to", " ", "establish", " ", "the", " ", "link"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"EstablishLink", "[", "LINK_", "]"}], ":=", 
    RowBox[{"(", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ClearLink", "[", "LINK", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"ClearAll", "[", 
       RowBox[{"FindGroundMPSSite", ",", "IsLinkActive"}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", 
          RowBox[{"Links", "[", "\"\<*arpackformps\>\"", "]"}], "]"}], "==", 
         "0"}], ",", 
        RowBox[{"LINK", "=", 
         RowBox[{"Install", "[", 
          RowBox[{"\"\<arpackformps_\>\"", "<>", "$SystemID"}], "]"}]}]}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"LINK", "===", "$Failed"}], "||", 
         "ForceUseInternalRoutine"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"SetAttributes", "[", 
          RowBox[{"FindGroundMPSSite", ",", "HoldAll"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"FindGroundMPSSite", "[", 
           RowBox[{
           "A_", ",", "DLeft_", ",", "DRight_", ",", "hLeft_", ",", "hRight_",
             ",", "vLeft_", ",", "vRight_", ",", "Ham_"}], "]"}], ":=", 
          RowBox[{"FindGroundMPSSiteManual", "[", 
           RowBox[{
           "A", ",", "DLeft", ",", "DRight", ",", "hLeft", ",", "hRight", ",",
             "vLeft", ",", "vRight", ",", "Ham"}], "]"}]}]}]}], 
       "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", ")"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.4743048932237263`*^9, {3.477910156136441*^9, 3.477910159383781*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"!", "ForceUseInternalRoutine"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"EstablishLink", "[", "link", "]"}], ";"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ClearAll", "[", "FindGroundMPSSite", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"SetAttributes", "[", 
      RowBox[{"FindGroundMPSSite", ",", "HoldAll"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"FindGroundMPSSite", "[", 
       RowBox[{
       "A_", ",", "DLeft_", ",", "DRight_", ",", "hLeft_", ",", "hRight_", 
        ",", "vLeft_", ",", "vRight_", ",", "Ham_"}], "]"}], ":=", 
      RowBox[{"FindGroundMPSSiteManual", "[", 
       RowBox[{
       "A", ",", "DLeft", ",", "DRight", ",", "hLeft", ",", "hRight", ",", 
        "vLeft", ",", "vRight", ",", "Ham"}], "]"}]}]}]}], 
   "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.474291280485429*^9, 3.474291288105788*^9}, {
  3.489237262199449*^9, 3.489237282103612*^9}, {3.489237373102049*^9, 
  3.4892373858168*^9}}],

Cell[CellGroupData[{

otEqual]", "dims2"}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<Hamiltonian seems to be ,

formed. Please restart it\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"length", "=", "dims1"}], ";", "\[IndentingNewLine]
}, Open  ]],

Cell[CellGroupData[{

RowBox[{
        RowBox[{
         RowBox[{"1", ">", "site1"}], "||", 
         RowBox[{"site1", ">", "length"}], "||", 
    ,

  RowBox[{"1", ">", "site2"}], "||", 
         RowBox[{"site2", ">", "length"}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", "\"\<Site needs to be between 1 and Length.\>\"", 
          "]"}], ";", 
    
}, Open  ]],

eturn", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{"site1", "-", "site2"}], "]"}], ">", "intRange"}], ",", 
        RowBox[{
         RowBox[{"Ham", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "=", 
         RowBox[{"Abs", "[", 
          RowBox[{"site1", "-", "si
}, Open  ]],

Cell[CellGroupData[{

 "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Ham", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "axis", ",", "site1,

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSInitHamiltonian", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MPSInitHamiltonian", "[", "length_", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"{", 
    RowBox[{"0", ",", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{"0.0", ",", 
         RowBox[{"{", 
          RowBox[{"n", ",", "1", ",", "length"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"m", ",", "1", ",", "length"}], "}"}]}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"\[Alpha]", ",", "1", ",", "3"}], "}"}]}], "]"}]}], "}"}], 
   ")"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487504963291223*^9, 3.487504983583084*^9}, {
   3.489234685071151*^9, 3.489234697592998*^9}, {3.4892348699158907`*^9, 
   3.489234898833209*^9}, 3.4892349570378723`*^9, {3.489236534986526*^9, 
   3.489236539945809*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MPSHamiltonianAdd", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MPSHamiltonianAdd", "[", 
    RowBox[{"Ham_", ",", "axis_", ",", "strength_", ",", "site_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "length", ",", "dims1", ",", "dims2", ",", "Numaxes", ",", "components",
        ",", "intRange"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"components", "=", 
       RowBox[{"Length", "[", "Ham", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"components", "!=", "2"}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<Hamiltonian seems to be malformed. Please restart it\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"intRange", "=", 
       RowBox[{"Ham", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"Numaxes", ",", "dims1", ",", "dims2"}], "}"}], "=", 
       RowBox[{"Dimensions", "[", 
        RowBox[{"Ham", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"length", "=", "dims1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Numaxes", "\[NotEqual]", "3"}], "||", 
         RowBox[{"dims1", "\[NotEqual]", "dims2"}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<Hamiltonian seems to be malformed. Please restart it\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"1", ">", "site"}], "||", 
         RowBox[{"site", ">", "length"}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", "\"\<Site needs to be between 1 and Length.\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Ham", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "axis", ",", "site", ",", "site"}], "]"}], "]"}], 
        "=", "strength"}], ")"}]}]}], "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498409725955*^9, 3.487498520916314*^9}, {
  3.487498551262932*^9, 3.4874985758748426`*^9}, {3.4874986667194357`*^9, 
  3.4874986722635403`*^9}, {3.489234704463614*^9, 3.489234704669962*^9}, {
  3.48923478693493*^9, 3.489234823562299*^9}, {3.489234913573173*^9, 
  3.4892350273080387`*^9}, {3.48923507529417*^9, 3.489235322017806*^9}, {
  3.489235414790785*^9, 3.489235445387767*^9}, {3.4892354822852163`*^9, 
  3.489235530043385*^9}, {3.489235837424284*^9, 3.4892358375354767`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MPSHamiltonianAdd", "[", 
    RowBox[{
    "Ham_", ",", "axis_", ",", "strength_", ",", "site1_", ",", "site2_"}], 
    "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "length", ",", "dims1", ",", "dims2", ",", "Numaxes", ",", "components",
        ",", "intRange"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"components", "=", 
       RowBox[{"Length", "[", "Ham", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"components", "!=", "2"}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<Hamiltonian seems to be malformed. Please restart it\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"intRange", "=", 
       RowBox[{"Ham", "[", 
        RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"Numaxes", ",", "dims1", ",", "dims2"}], "}"}], "=", 
       RowBox[{"Dimensions", "[", 
        RowBox[{"Ham", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Numaxes", "\[NotEqual]", "3"}], "||", 
         RowBox[{"dims1", "\[NotEqual]", "dims2"}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<Hamiltonian seems to be malformed. Please restart it\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"length", "=", "dims1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"1", ">", "site1"}], "||", 
         RowBox[{"site1", ">", "length"}], "||", 
         RowBox[{"1", ">", "site2"}], "||", 
         RowBox[{"site2", ">", "length"}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", "\"\<Site needs to be between 1 and Length.\>\"", 
          "]"}], ";", 
         RowBox[{"Return", "[", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Abs", "[", 
          RowBox[{"site1", "-", "site2"}], "]"}], ">", "intRange"}], ",", 
        RowBox[{
         RowBox[{"Ham", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "=", 
         RowBox[{"Abs", "[", 
          RowBox[{"site1", "-", "site2"}], "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Ham", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "axis", ",", "site1", ",", "site2"}], "]"}], 
         "]"}], "=", "strength"}], ")"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Ham", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "axis", ",", "site2", ",", "site1"}], "]"}], 
         "]"}], "=", "strength"}], ")"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.489235361120946*^9, 3.4892354103275642`*^9}, {
  3.4892354546806583`*^9, 3.489235468004641*^9}, {3.489235511933302*^9, 
  3.489235584107862*^9}}]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

`*^9, 
  3.464932648839385*^9}, {3.4649327048784857`*^9, 3.464932737660335*^9}, {
  3.46494713030661,

Cell[CellGroupData[{

9}, {3.4649536582215843`*^9, 
  3.46495365853689*^9}, {3.46511648052164*^9, 3.465116504740196*^9},

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"TOLERANCE", "=", 
    RowBox[{"10", "^", 
     RowBox[{"(", 
      RowBox[{"-", "10"}], ")"}]}]}], ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{
   "This", " ", "is", " ", "the", " ", "tolerance", " ", "of", " ", 
    "PseudoInverse"}], " ", "*)"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465216915963977*^9, 3.465216923954493*^9}, {
  3.465217628312253*^9, 3.465217628440948*^9}, {3.4652176924388733`*^9, 
  3.465217692719139*^9}, {3.465217817356654*^9, 3.465217830146367*^9}}]
}, Open  ]],

Cell[CellGroupData[{

 RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[",

Cell[CellGroupData[{

 "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Length",,

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "TEBDProductState", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Spin", "\[Rule]", "2"}], ",", 
     RowBox[{"BondDimension", "\[Rule]", "20"}], ",", 
     RowBox[{"Type", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"\"\<Random\>\"", ",", 
        RowBox[{"{", "}"}]}], "}"}]}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDProductState", "[", 
   RowBox[{"numSites_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\[CapitalGamma]", "=", 
       RowBox[{"Array", "[", 
        RowBox[{
         RowBox[{"0", "&"}], ",", 
         RowBox[{"{", "numSites", "}"}]}], "]"}]}], ",", 
      RowBox[{"\[Lambda]", "=", 
       RowBox[{"Array", "[", 
        RowBox[{
         RowBox[{"0", "&"}], ",", 
         RowBox[{"{", "numSites", "}"}]}], "]"}]}], ",", 
      RowBox[{"tempType", "=", 
       RowBox[{"OptionValue", "[", "Type", "]"}]}], ",", "type", ",", 
      "phaseList", ",", 
      RowBox[{"spin", "=", 
       RowBox[{"OptionValue", "[", "Spin", "]"}]}], ",", 
      RowBox[{"\[Chi]", "=", 
       RowBox[{"OptionValue", "[", "BondDimension", "]"}]}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"type", ",", "phaseList"}], "}"}], "=", "tempType"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Switch", "[", 
      RowBox[{
      "type", ",", "\[IndentingNewLine]", "\"\<Specified\>\"", ",", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "phaseList", "]"}], "\[NotEqual]", 
          RowBox[{"{", 
           RowBox[{"numSites", ",", "2"}], "}"}]}], ",", 
         RowBox[{
          RowBox[{
          "Print", "[", 
           "\"\<TEBDProductState called with wrong list of phases.\>\"", 
           "]"}], ";", 
          RowBox[{"Abort", "[", "]"}]}]}], "]"}], ",", "\[IndentingNewLine]", 
       "\"\<Identity\>\"", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"phaseList", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"0.0", ",", "0.0"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"k", ",", "1", ",", "numSites"}], "}"}]}], "]"}]}], ";"}],
        ",", "\[IndentingNewLine]", "\"\<Random\>\"", ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"phaseList", "=", 
         RowBox[{"RandomReal", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"0", ",", 
             RowBox[{"2", "\[Pi]"}]}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"numSites", ",", "2"}], "}"}]}], "]"}]}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"i_", ",", "j_"}], "}"}], "/;", 
                RowBox[{"(", 
                 RowBox[{"i", "\[Equal]", "j", "\[Equal]", "1"}], ")"}]}], 
               "\[Rule]", 
               RowBox[{"Chop", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"2", "-", "n"}], ")"}], 
                  RowBox[{"Cos", "[", 
                   RowBox[{"1.0", " ", 
                    RowBox[{"phaseList", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "1"}], "]"}], "]"}]}], "]"}]}], "+", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"n", "-", "1"}], ")"}], 
                  RowBox[{"Exp", "[", 
                   RowBox[{"I", " ", 
                    RowBox[{"phaseList", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "2"}], "]"}], "]"}]}], "]"}], 
                  RowBox[{"Sin", "[", 
                   RowBox[{"1.0", " ", 
                    RowBox[{"phaseList", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "1"}], "]"}], "]"}]}], "]"}]}]}], 
                "]"}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"n", ",", "1", ",", "spin"}], "}"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"{", "i_", "}"}], "/;", 
             RowBox[{"i", "\[LessEqual]", "1"}]}], "\[Rule]", "1.0"}], " ", 
           ",", 
           RowBox[{"{", "\[Chi]", "}"}]}], "]"}]}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"k", ",", "1", ",", "numSites"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4649297764777737`*^9, 3.464929804283819*^9}, {
  3.464929840941298*^9, 3.4649301764404593`*^9}, {3.464930211602632*^9, 
  3.46493030342353*^9}, {3.464930371022574*^9, 3.4649305563091908`*^9}, {
  3.464930620865512*^9, 3.4649306455791817`*^9}, {3.464930794048572*^9, 
  3.464930917403995*^9}, {3.464931010551736*^9, 3.4649310134949293`*^9}, {
  3.464932413918706*^9, 3.464932487575295*^9}, {3.4649325934077673`*^9, 
  3.464932648839385*^9}, {3.4649327048784857`*^9, 3.464932737660335*^9}, {
  3.464947130306617*^9, 3.464947193144691*^9}, {3.4649536582215843`*^9, 
  3.46495365853689*^9}, {3.46511648052164*^9, 3.465116504740196*^9}, {
  3.465148070991588*^9, 3.465148105153586*^9}, {3.4651481415921097`*^9, 
  3.4651481597273407`*^9}, {3.465573425714925*^9, 3.465573427357082*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDSave", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDSave", "[", 
   RowBox[{"TEBD_", ",", "filename_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"numSites", ",", "spin", ",", "\[Chi]"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Export", "[", 
      RowBox[{
       RowBox[{"filename", "<>", "\"\<.info\>\""}], ",", 
       RowBox[{"{", 
        RowBox[{"numSites", ",", "spin", ",", "\[Chi]"}], "}"}], ",", 
       "\"\<Table\>\""}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Export", "[", 
           RowBox[{
            RowBox[{"filename", "<>", "\"\<.G.\>\"", "<>", 
             RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
             RowBox[{"ToString", "[", "s", "]"}], "<>", "\"\<.dat\>\""}], ",", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"n", ",", "1", ",", "s"}], "]"}], "]"}], ",", 
            "\"\<Table\>\""}], "]"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"filename", "<>", "\"\<.L.\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.dat\>\""}], ",", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", "\"\<Table\>\""}], 
         "]"}], ";"}], "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", "numSites"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465272381315712*^9, 3.465272466935622*^9}, {
  3.465274872039486*^9, 3.465275077441268*^9}, {3.46527516315172*^9, 
  3.4652751816887493`*^9}, {3.4652753073560953`*^9, 3.465275331904854*^9}, {
  3.465275685829495*^9, 3.465275757088855*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDRead", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDRead", "[", 
   RowBox[{"TEBD_", ",", "filename_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"numSites", ",", "spin", ",", "\[Chi]", ",", "info"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"info", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"Import", "[", 
        RowBox[{
         RowBox[{"filename", "<>", "\"\<.info\>\""}], ",", "\"\<Table\>\""}], 
        "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"numSites", ",", "spin", ",", "\[Chi]"}], "}"}], "=", "info"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"TEBD", "=", 
      RowBox[{"TEBDProductState", "[", 
       RowBox[{"numSites", ",", 
        RowBox[{"Spin", "\[Rule]", "spin"}], ",", 
        RowBox[{"BondDimension", "\[Rule]", "\[Chi]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"TEBD", "[", 
          RowBox[{"[", 
           RowBox[{"n", ",", "1"}], "]"}], "]"}], "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Import", "[", 
             RowBox[{
              RowBox[{"filename", "<>", "\"\<.G.\>\"", "<>", 
               RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
               RowBox[{"ToString", "[", "s", "]"}], "<>", "\"\<.dat\>\""}], 
              ",", "\"\<Table\>\""}], "]"}], "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"TEBD", "[", 
          RowBox[{"[", 
           RowBox[{"n", ",", "2"}], "]"}], "]"}], "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"Import", "[", 
            RowBox[{
             RowBox[{"filename", "<>", "\"\<.L.\>\"", "<>", 
              RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.dat\>\""}], 
             ",", "\"\<Table\>\""}], "]"}], "]"}], "]"}]}], ";"}], 
       "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", "numSites"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465272381315712*^9, 3.465272466935622*^9}, {
   3.465274872039486*^9, 3.465275077441268*^9}, {3.46527516315172*^9, 
   3.4652751816887493`*^9}, {3.4652753073560953`*^9, 3.465275331904854*^9}, {
   3.465275367081286*^9, 3.465275465554977*^9}, {3.465275606648999*^9, 
   3.465275625558902*^9}, 3.465275692829726*^9, {3.465275812721534*^9, 
   3.465275817605616*^9}, {3.465275893836484*^9, 3.4652759156339073`*^9}, {
   3.4652759744600067`*^9, 3.465275992702661*^9}, {3.465276042057399*^9, 
   3.465276066453537*^9}, {3.465276127582642*^9, 3.465276134162496*^9}, {
   3.4652762037779922`*^9, 3.4652762076892776`*^9}}]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

ox[{"{", "4", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3"}], "}"}]}], "}",

Cell[BoxData[
 RowBox[{
  RowBox[{"Swap", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "1", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"0", ",", "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], 
  ";"}]], "Input",
 InitializationCell->True],

Cell[CellGroupData[{

ine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
 ,

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBD2QGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBD2QGate", "[", 
   RowBox[{"TEBD_", ",", "leftSite_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Chi]", ",", "\[Chi]R", ",", "\[Chi]L", ",", "Hint", ",", 
      "\[Lambda]LD", ",", "\[Lambda]CD", ",", "\[Lambda]RD", ",", 
      "\[CapitalSigma]", ",", "X", ",", "YT", ",", "\[Lambda]temp", ",", 
      "\[Lambda]RDi", ",", "\[Lambda]LDi", ",", "norm", ",", "numSites", ",", 
      "rightSite", ",", "spin"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", "   ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"step", "=", "0.1"}], ",", "\[Lambda]L", ",", "\[Lambda]C", 
        ",", "\[Lambda]R"}], "]"}], ";", " ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"rightSite", "=", 
      RowBox[{"leftSite", "+", "1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "<=", "leftSite", "<", "numSites"}], ")"}], 
        "\[NotEqual]", "True"}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", "\"\<TEBD2QGate called with wrong site parameter.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spin", ",", "\[Chi]L", ",", "\[Chi]R"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Max", "[", 
       RowBox[{"\[Chi]R", ",", "\[Chi]L"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "2"}], ",", 
          RowBox[{"spin", "^", "2"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBD2QGate called with wrong operator dimensions.\>\"", "]"}], 
        ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Hint", "=", 
      RowBox[{"(", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", "H"}], ")"}], 
       ")"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"leftSite", "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]LD", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"i_", ",", "j_"}], "}"}], "/;", 
             RowBox[{"i", "\[Equal]", "j", "==", "1"}]}], "\[Rule]", "1.0"}], 
           " ", ",", 
           RowBox[{"{", 
            RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]LD", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"leftSite", "-", "1"}], ",", "2"}], "]"}], "]"}], "]"}],
           "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"rightSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 2-1,\>\"", "]"}]}], ";", 
       RowBox[{"Print", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
         RowBox[{"{", 
          RowBox[{"\[Lambda]RD", ",", "\[Lambda]CD", ",", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], ",", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"rightSite", ",", "1"}], "]"}], "]"}]}], "}"}]}], "]"}], 
       ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]CD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"rightSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "4", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3"}], "}"}]}], "}"}]}], "]"}], ".", "Hint"}],
         ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "2"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Check 2-1B: \>\"", "<>", 
          RowBox[{"ToString", "[", "leftSite", "]"}], "<>", "\"\<, \>\"", "<>", 
          RowBox[{"ToString", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}]}], "]"}]}],
          "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{"(", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ",", "\[Chi]"}], 
        "]"}], ")"}]}], ";", " ", "\[IndentingNewLine]", 
     RowBox[{"norm", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]CD", "^", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]CD", "/", 
       RowBox[{"Sqrt", "[", "norm", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 2-2\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], ",", 
         RowBox[{"Tolerance", "\[Rule]", "TOLERANCE"}]}], "]"}], "]"}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 2-3\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Check 2-3 B: site \>\"", "<>", 
          RowBox[{"ToString", "[", "rightSite", "]"}], "<>", "\"\<, \>\"", "<>", 
          RowBox[{"ToString", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"YT", ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"Transpose", "[", 
                 RowBox[{"{", 
                  RowBox[{"PadRight", "[", 
                   RowBox[{
                    RowBox[{"Conjugate", "[", "#", "]"}], ",", "\[Chi]"}], 
                   "]"}], "}"}], "]"}], "&"}], "/@", "YT"}]}], "}"}]}], 
           "]"}]}], "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"rightSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"1", "-", "norm"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",\

 InitializationCell->True,
 CellChangeTimes->{{3.443359214968994*^9, 3.44335940640832*^9}, {
   3.4433594365521812`*^9, 3.4433594526198673`*^9}, {3.443359639971109*^9, 
   3.443359654429758*^9}, {3.4434419723038263`*^9, 3.44344208062729*^9}, {
   3.443442118177108*^9, 3.44344232908633*^9}, {3.443442421471139*^9, 
   3.4434428630623083`*^9}, {3.4434470199400263`*^9, 
   3.4434470254556313`*^9}, {3.443510172660636*^9, 3.443510180222643*^9}, {
   3.443510244992063*^9, 3.4435102869332523`*^9}, {3.443510317448319*^9, 
   3.4435103257487507`*^9}, {3.443510360644993*^9, 3.443510747127743*^9}, {
   3.443510785457789*^9, 3.4435108122098093`*^9}, {3.4435108609689207`*^9, 
   3.443510966823202*^9}, {3.4435110080512114`*^9, 3.443511058761353*^9}, 
   3.443511148010591*^9, {3.443511540700561*^9, 3.443511563345602*^9}, {
   3.443511597072886*^9, 3.443511597738432*^9}, 3.443511648402638*^9, {
   3.4435119385942087`*^9, 3.4435120628499403`*^9}, {3.4435121656389008`*^9, 
   3.443512467962412*^9}, {3.4435126349195127`*^9, 3.443512780239728*^9}, {
   3.443512830719163*^9, 3.443512837762377*^9}, {3.443513013899762*^9, 
   3.4435130256595993`*^9}, {3.443513684983494*^9, 3.4435136895071*^9}, {
   3.443513765075243*^9, 3.443513768454974*^9}, {3.443513849880643*^9, 
   3.443513853051955*^9}, {3.443513946018778*^9, 3.4435139666254797`*^9}, {
   3.443516806125209*^9, 3.443516832165584*^9}, {3.443516869594656*^9, 
   3.4435168940555277`*^9}, {3.443516993513563*^9, 3.443517021425654*^9}, {
   3.443517536257066*^9, 3.4435175506812077`*^9}, {3.443517714046372*^9, 
   3.4435177881238003`*^9}, {3.4435178182612543`*^9, 
   3.4435181253146257`*^9}, {3.4435273405404387`*^9, 3.443527382663971*^9}, {
   3.443528278145529*^9, 3.443528281264477*^9}, {3.4435290028092012`*^9, 
   3.4435290177649307`*^9}, {3.443529054272295*^9, 3.4435290626084547`*^9}, {
   3.4435292028793917`*^9, 3.443529309613722*^9}, {3.443529354865958*^9, 
   3.4435293650828753`*^9}, {3.443602104671269*^9, 3.443602151593223*^9}, {
   3.4436022086604156`*^9, 3.443602209014091*^9}, {3.4436022601060762`*^9, 
   3.443602271978656*^9}, {3.44360231653098*^9, 3.443602384186523*^9}, {
   3.443602573361184*^9, 3.4436025782002277`*^9}, {3.443780435165977*^9, 
   3.443780435912643*^9}, {3.443780557537169*^9, 3.4437805581875153`*^9}, {
   3.443781398666946*^9, 3.4437814021658373`*^9}, {3.443781497077993*^9, 
   3.443781506849025*^9}, {3.443790818430187*^9, 3.4437909285357113`*^9}, {
   3.443790967002638*^9, 3.443791001621365*^9}, {3.443791120654482*^9, 
   3.443791143867103*^9}, {3.443791175707457*^9, 3.443791225739861*^9}, {
   3.4437912679533443`*^9, 3.443791283837797*^9}, {3.443791739843855*^9, 
   3.443791747857483*^9}, {3.443791794870331*^9, 3.443791797984334*^9}, {
   3.443852864961628*^9, 3.443852873950439*^9}, {3.4438529875552483`*^9, 
   3.443852996047879*^9}, {3.449135969709622*^9, 3.449135969819179*^9}, {
   3.449137318631754*^9, 3.4491373525300293`*^9}, {3.449137450686569*^9, 
   3.449137472003034*^9}, {3.44914051622239*^9, 3.449140590322256*^9}, {
   3.449140626422885*^9, 3.449140696157218*^9}, {3.449140821145731*^9, 
   3.4491409702379913`*^9}, {3.44914222530058*^9, 3.4491423164738827`*^9}, {
   3.4491423533102903`*^9, 3.4491425329994707`*^9}, {3.44914256934028*^9, 
   3.449142592036716*^9}, {3.449142824125408*^9, 3.449142846005625*^9}, 
   3.449171308249566*^9, {3.4491721366101017`*^9, 3.449172144061658*^9}, {
   3.449173415024889*^9, 3.4491734274714327`*^9}, {3.44917346986064*^9, 
   3.4491734781865597`*^9}, {3.4491735394851837`*^9, 3.449173565777207*^9}, {
   3.449173702526167*^9, 3.4491737101866617`*^9}, {3.4491746718992987`*^9, 
   3.4491746767002277`*^9}, {3.449174791588271*^9, 3.449174798744239*^9}, {
   3.449176543578514*^9, 3.4491765439412394`*^9}, {3.451137903147464*^9, 
   3.4511379143466463`*^9}, {3.451137972480033*^9, 3.451137995253192*^9}, {
   3.4511380253829317`*^9, 3.451138044750457*^9}, {3.451138111610551*^9, 
   3.451138253881445*^9}, {3.4511382886149797`*^9, 3.4511384115398397`*^9}, {
   3.451138646788807*^9, 3.45113864701968*^9}, {3.45165180384595*^9, 
   3.451651805048472*^9}, {3.451651856466001*^9, 3.4516518601126957`*^9}, {
   3.451652399037507*^9, 3.451652451046364*^9}, {3.4516525766273937`*^9, 
   3.451652618443089*^9}, {3.451673133953622*^9, 3.451673170182315*^9}, {
   3.4578708714715033`*^9, 3.457870882500148*^9}, {3.464946541746253*^9, 
   3.464946782304781*^9}, {3.4649473012682877`*^9, 3.464947391849074*^9}, {
   3.464947422951128*^9, 3.4649474966415358`*^9}, {3.4649479094317207`*^9, 
   3.46494793901512*^9}, 3.4649502957657003`*^9, {3.464950504170223*^9, 
   3.464950519417398*^9}, {3.464952747917552*^9, 3.46495275169718*^9}, {
   3.464953249246697*^9, 3.464953360356801*^9}, {3.464953589892911*^9, 
   3.464953592204599*^9}, {3.464953683901133*^9, 3.464953685351132*^9}, {
   3.46495374475084*^9, 3.464953779365415*^9}, {3.464954005517185*^9, 
   3.46495404859733*^9}, {3.4651174389513817`*^9, 3.4651174435055227`*^9}, {
   3.465117662057515*^9, 3.4651176660221148`*^9}, 3.46512093614182*^9, {
   3.465124496405686*^9, 3.4651245399767437`*^9}, {3.465124646045375*^9, 
   3.465124708301429*^9}, {3.465124764231389*^9, 3.465124772991962*^9}, {
   3.465124871565215*^9, 3.465124942788371*^9}, {3.465125356052272*^9, 
   3.4651253933219013`*^9}, {3.465125758554215*^9, 3.4651258137241907`*^9}, 
   3.465125943564025*^9, {3.4651262166278048`*^9, 3.465126270706972*^9}, {
   3.465126368755143*^9, 3.465126368907205*^9}, {3.4651490023883142`*^9, 
   3.46514900468364*^9}, {3.465149037115671*^9, 3.4651490636316023`*^9}, 
   3.465149696349391*^9, {3.465149758223654*^9, 3.465149758488887*^9}, {
   3.4651498041146517`*^9, 3.465149804382587*^9}, {3.4652095478020277`*^9, 
   3.4652095541061783`*^9}, {3.465209588624544*^9, 3.4652096150573883`*^9}, {
   3.465216861031766*^9, 3.4652168748391533`*^9}, {3.487491097108287*^9, 
   3.4874911675505457`*^9}, {3.487491216326186*^9, 3.4874913815747128`*^9}, {
   3.4874914145814877`*^9, 3.487491544474697*^9}, {3.487491586464923*^9, 
   3.4874916080960827`*^9}, {3.487491641856079*^9, 3.4874916480171432`*^9}, {
   3.487491695847526*^9, 3.487491905672369*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDGate", "[", 
   RowBox[{"TEBD_", ",", "SiteOperator_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "error", ",", "numSites", ",", "numOfSwaps", ",", "ActualLeft", ",", 
      "ActualRight", ",", "leftSite", ",", "rightSite", ",", "H"}], "}"}], 
    ",", "\[IndentingNewLine]", 
    RowBox[{"(*", "   ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"step", "=", "0.1"}], ",", "\[Lambda]L", ",", "\[Lambda]C", 
        ",", "\[Lambda]R"}], "]"}], ";", " ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"H", "=", 
      RowBox[{"SiteOperator", "[", 
       RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"leftSite", "=", 
      RowBox[{"SiteOperator", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"rightSite", "=", 
      RowBox[{"SiteOperator", "[", 
       RowBox[{"[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"!", 
         RowBox[{"(", 
          RowBox[{"1", "<=", "leftSite", "<=", "numSites"}], ")"}]}], "||", 
        RowBox[{"!", 
         RowBox[{"(", 
          RowBox[{"1", "<=", "rightSite", "<=", "numSites"}], ")"}]}]}], ",", 
       
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{
         "\"\<TEBDGate[left,right] called with wrong site parameter:\>\"", 
          ",", "leftSite", ",", "\"\<,\>\"", ",", "rightSite"}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"leftSite", "\[Equal]", "rightSite"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"Equal", " ", "sites"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"error", "=", 
         RowBox[{"TEBD1QGate", "[", 
          RowBox[{"TEBD", ",", "leftSite", ",", "H"}], "]"}]}], ";"}], 
       "\[IndentingNewLine]", ",", " ", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"Different", " ", "sites"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ActualLeft", "=", 
         RowBox[{"Min", "[", 
          RowBox[{"leftSite", ",", "rightSite"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ActualRight", "=", 
         RowBox[{"Max", "[", 
          RowBox[{"leftSite", ",", "rightSite"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"numOfSwaps", "=", 
         RowBox[{"ActualRight", "-", "ActualLeft", "-", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"leftSite", "<", "rightSite"}], ",", "1", ",", "0"}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{"error", "+=", 
           RowBox[{"TEBD2QGate", "[", 
            RowBox[{"TEBD", ",", 
             RowBox[{"ActualRight", "-", "n"}], ",", "Swap"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "1", ",", "numOfSwaps", ",", "1"}], "}"}]}], 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "ActualLeft", ",", "H"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{"error", "+=", 
           RowBox[{"TEBD2QGate", "[", 
            RowBox[{"TEBD", ",", 
             RowBox[{"ActualRight", "-", "n"}], ",", "Swap"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "numOfSwaps", ",", "1", ",", 
            RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", "error"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498909043089*^9, 3.487498909192683*^9}, {
  3.487498942009706*^9, 3.4874989423222513`*^9}, {3.4874991400553493`*^9, 
  3.487499247290147*^9}, {3.487499314581312*^9, 3.4874993938968573`*^9}, {
  3.487526594145541*^9, 3.487526693657701*^9}, {3.489300044950975*^9, 
  3.489300072470018*^9}, {3.489300260345621*^9, 3.489300267502264*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Box[{"{", "1", "}"}], ",", 
             RowBox[{"{", "5", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3", ",", "4"}], "}"}]}], "}"}]}], "]"}], ".",
  ,

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBD3QGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBD3QGate", "[", 
   RowBox[{"TEBD_", ",", "centerSite_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "spin", ",", "\[Chi]", ",", "\[Chi]R", ",", "\[Chi]L", ",", 
      "\[Lambda]LD", ",", "\[Lambda]1D", ",", "\[Lambda]2D", ",", 
      "\[Lambda]RD", ",", "\[CapitalSigma]", ",", "X", ",", "YT", ",", 
      "\[Lambda]temp", ",", "\[Lambda]RDi", ",", "\[Lambda]LDi", ",", 
      "\[Lambda]1Di", ",", "norm1", ",", "norm2", ",", "numSites", ",", 
      "Hint", ",", "leftSite", ",", "rightSite"}], "}"}], ",", 
    "\[IndentingNewLine]", " ", 
    RowBox[{"(*", "  ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{"step", "=", "0"}], "]"}], ";", "  ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"leftSite", "=", 
      RowBox[{"centerSite", "-", "1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"rightSite", "=", 
      RowBox[{"centerSite", "+", "1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "<", "centerSite", "<", "numSites"}], ")"}], 
        "\[NotEqual]", "True"}], ",", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"\"\<TEBD3QGate called with wrong site,\>\"", "<>", 
          RowBox[{"ToString", "[", "centerSite", "]"}]}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spin", ",", "\[Chi]L", ",", "\[Chi]R"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Max", "[", 
       RowBox[{"\[Chi]R", ",", "\[Chi]L"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "3"}], ",", 
          RowBox[{"spin", "^", "3"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBD3QGate called with wrong operator dimensions.\>\"", "]"}], 
        ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Hint", "=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", "H"}], ")"}]}], 
       ")"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"leftSite", "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]LD", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"i_", ",", "j_"}], "}"}], "/;", 
             RowBox[{"i", "\[Equal]", "j", "==", "1"}]}], "\[Rule]", "1.0"}], 
           " ", ",", 
           RowBox[{"{", 
            RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]LD", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"leftSite", "-", "1"}], ",", "2"}], "]"}], "]"}], "]"}],
           "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"centerSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"rightSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-1\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"First", " ", "make", " ", "3", " ", "spin", " ", "matrix"}], 
      "  ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]1D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"centerSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]2D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"rightSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "5", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3", ",", "4"}], "}"}]}], "}"}]}], "]"}], ".",
          "Hint"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "5", ",", "2"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{
       "Perform", " ", "SVD", " ", "of", " ", "the", " ", "three", " ", 
        "spin", " ", "matrix", " ", "as", " ", "1"}], "-", 
       RowBox[{"2", " ", "spins"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{"(", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ",", "\[Chi]"}], 
        "]"}], ")"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm1", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm1", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "the", " ", "tensors", " ", "of", " ", "the", " ", 
       "left", " ", "spin"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-2\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
        "Now", " ", "rearrange", " ", "right", " ", "matrix", " ", "to", " ", 
         "represent", " ", "2", " ", "spins", " ", "as", " ", "1"}], "-", 
        "1"}], ",", " ", 
       RowBox[{
       "multiplying", " ", "before", " ", "by", " ", "the", " ", "new", " ", 
        "\[Lambda]1"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-3\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]1D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", "spin"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "1", ",", "4"}], "}"}]}], "]"}]}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"ToString", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
           RowBox[{"{", 
            RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}]}], "]"}], 
         "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{"(", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ",", "\[Chi]"}], 
        "]"}], ")"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm2", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"centerSite", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm2", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]1D", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-4\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"centerSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]1Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "right", " ", "tensor", " ", "needs", " ", "the", " ", 
       "inverse", " ", "right", " ", "lambda", " ", "to", " ", "fit"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-5\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Check 3-5 B: site \>\"", "<>", 
          RowBox[{"ToString", "[", "rightSite", "]"}], "<>", "\"\<, \>\"", "<>", 
          RowBox[{"ToString", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"YT", ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"Transpose", "[", 
                 RowBox[{"{", 
                  RowBox[{"PadRight", "[", 
                   RowBox[{
                    RowBox[{"Conjugate", "[", "#", "]"}], ",", "\[Chi]"}], 
                   "]"}], "}"}], "]"}], "&"}], "/@", "YT"}]}], "}"}]}], 
           "]"}]}], "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"rightSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"2", "-", "norm1", "-", "norm2"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.464934070362854*^9, 3.464934116319593*^9}, {
   3.464934518538512*^9, 3.4649345211524477`*^9}, {3.464934555899847*^9, 
   3.464934584939793*^9}, {3.464934662231352*^9, 3.464934702460699*^9}, {
   3.464934753352345*^9, 3.464934755271762*^9}, {3.464934937829904*^9, 
   3.464934938634347*^9}, {3.464935013414278*^9, 3.46493514223295*^9}, 
   3.464935172974012*^9, {3.464946082524336*^9, 3.464946175430277*^9}, {
   3.464946243178331*^9, 3.46494625217043*^9}, {3.4649463095226307`*^9, 
   3.464946328698124*^9}, {3.464946383203953*^9, 3.4649464246236*^9}, {
   3.464954131083453*^9, 3.4649541514072313`*^9}, {3.465116917346902*^9, 
   3.465116923979826*^9}, {3.46511728719028*^9, 3.465117317900653*^9}, {
   3.465117360370763*^9, 3.465117368030986*^9}, {3.465117549209631*^9, 
   3.465117616479165*^9}, {3.4651176470984383`*^9, 3.465117651023459*^9}, {
   3.4651177078854218`*^9, 3.4651177164608994`*^9}, {3.465117819345254*^9, 
   3.465117854873598*^9}, {3.465119603020979*^9, 3.4651196299968233`*^9}, {
   3.4651208359639893`*^9, 3.465120849351202*^9}, 3.4651209126355553`*^9, {
   3.465121222198867*^9, 3.4651212720074263`*^9}, {3.46512347454152*^9, 
   3.465123478061789*^9}, {3.465123936386245*^9, 3.465123950586635*^9}, {
   3.465124327195331*^9, 3.46512434944878*^9}, {3.465124460953643*^9, 
   3.4651244780492973`*^9}, {3.4651254121553802`*^9, 3.465125438921418*^9}, {
   3.465126302633801*^9, 3.46512630741492*^9}, {3.465126340862627*^9, 
   3.465126341006613*^9}, {3.46514907382867*^9, 3.465149166222949*^9}, {
   3.465149661848701*^9, 3.465149683383398*^9}, {3.465149758598386*^9, 
   3.465149758988866*^9}, {3.465149803393134*^9, 3.465149803785709*^9}, {
   3.4652096218797827`*^9, 3.465209634248837*^9}, {3.465216880990182*^9, 
   3.465216897175312*^9}}]
}, Open  ]],

Cell[CellGroupData[{

       RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]2D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
     ,

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBD4QGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBD4QGate", "[", 
   RowBox[{"TEBD_", ",", "leftSite_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "spin", ",", "\[Chi]", ",", "\[Chi]R", ",", "\[Chi]L", ",", 
      "\[Lambda]LD", ",", "\[Lambda]1D", ",", "\[Lambda]2D", ",", 
      "\[Lambda]3D", ",", "\[Lambda]2Di", ",", "\[Lambda]RD", ",", 
      "\[CapitalSigma]", ",", "X", ",", "YT", ",", "\[Lambda]temp", ",", 
      "\[Lambda]RDi", ",", "\[Lambda]LDi", ",", "\[Lambda]1Di", ",", "norm1", 
      ",", "norm2", ",", "norm3", ",", "numSites", ",", "Hint", ",", 
      "centerSite1", ",", "centerSite2", ",", "rightSite"}], "}"}], ",", 
    "\[IndentingNewLine]", " ", 
    RowBox[{"(*", "  ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{"step", "=", "0"}], "]"}], ";", "  ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"centerSite1", "=", 
      RowBox[{"leftSite", "+", "1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"centerSite2", "=", 
      RowBox[{"leftSite", "+", "2"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"rightSite", "=", 
      RowBox[{"leftSite", "+", "3"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "<=", "leftSite", "<", "rightSite", "<=", "numSites"}], 
         ")"}], "\[NotEqual]", "True"}], ",", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"\"\<TEBD4QGate called with wrong site,\>\"", "<>", 
          RowBox[{"ToString", "[", "leftSite", "]"}]}], "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spin", ",", "\[Chi]", ",", "\[Chi]R"}], "}"}], "=", 
      RowBox[{"Dimensions", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"centerSite1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "4"}], ",", 
          RowBox[{"spin", "^", "4"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBD4QGate called with wrong operator dimensions.\>\"", "]"}], 
        ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Hint", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Partition", "[", 
         RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", "H"}], ")"}]}], 
        ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"leftSite", "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]LD", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"i_", ",", "j_"}], "}"}], "/;", 
             RowBox[{"i", "\[Equal]", "j", "==", "1"}]}], "\[Rule]", "1.0"}], 
           " ", ",", 
           RowBox[{"{", 
            RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]LD", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"leftSite", "-", "1"}], ",", "2"}], "]"}], "]"}], "]"}],
           "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"centerSite1", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]3D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"centerSite2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"rightSite", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-1\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"First", " ", "make", " ", "3", " ", "spin", " ", "matrix"}], 
      "  ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]1D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"centerSite1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]2D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"centerSite2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]3D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{"rightSite", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "6", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3", ",", "4", ",", "5"}], "}"}]}], "}"}]}], 
          "]"}], ".", "Hint"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "5", ",", "2"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{
       "Perform", " ", "SVD", " ", "of", " ", "the", " ", "three", " ", 
        "spin", " ", "matrix", " ", "as", " ", "1"}], "-", 
       RowBox[{"2", " ", "spins"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{"(", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ",", "\[Chi]"}], 
        "]"}], ")"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm1", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm1", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"leftSite", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "the", " ", "tensors", " ", "of", " ", "the", " ", 
       "left", " ", "spin"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-2\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"leftSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
        "Now", " ", "rearrange", " ", "right", " ", "matrix", " ", "to", " ", 
         "represent", " ", "2", " ", "spins", " ", "as", " ", "1"}], "-", 
        "1"}], ",", " ", 
       RowBox[{
       "multiplying", " ", "before", " ", "by", " ", "the", " ", "new", " ", 
        "\[Lambda]1"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-3\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]1D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Chi]", ",", 
                  RowBox[{
                   RowBox[{"spin", "^", "2"}], " ", "\[Chi]"}]}], "}"}]}], 
               "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", "spin"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", "3", "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"ToString", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
           RowBox[{"{", 
            RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}]}], "]"}], 
         "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{"(", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ",", "\[Chi]"}], 
        "]"}], ")"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm2", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"centerSite1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm2", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]1D", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-4\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"centerSite1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]1Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "right", " ", "tensor", " ", "needs", " ", "the", " ", 
       "inverse", " ", "right", " ", "lambda", " ", "to", " ", "fit"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-5\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Check 3-5 B: site \>\"", "<>", 
          RowBox[{"ToString", "[", "rightSite", "]"}], "<>", "\"\<, \>\"", "<>", 
          RowBox[{"ToString", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"YT", ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"Transpose", "[", 
                 RowBox[{"{", 
                  RowBox[{"PadRight", "[", 
                   RowBox[{
                    RowBox[{"Conjugate", "[", "#", "]"}], ",", "\[Chi]"}], 
                   "]"}], "}"}], "]"}], "&"}], "/@", "YT"}]}], "}"}]}], 
           "]"}]}], "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]2D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", "spin"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "1", ",", "4"}], "}"}]}], "]"}]}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"ToString", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
           RowBox[{"{", 
            RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}]}], "]"}], 
         "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{"(", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ",", "\[Chi]"}], 
        "]"}], ")"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm3", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"centerSite2", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm2", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]2D", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-4\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"centerSite2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]2Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "right", " ", "tensor", " ", "needs", " ", "the", " ", 
       "inverse", " ", "right", " ", "lambda", " ", "to", " ", "fit"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", "\"\<Check 3-5\>\"", "]"}]}], ";", "DD"}], 
      "**)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"*", "O", " ", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Check 3-5 B: site \>\"", "<>", 
          RowBox[{"ToString", "[", "rightSite", "]"}], "<>", "\"\<, \>\"", "<>", 
          RowBox[{"ToString", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
            RowBox[{"{", 
             RowBox[{"YT", ",", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"Partition", "[", 
                 RowBox[{
                  RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}], ",", 
              RowBox[{
               RowBox[{
                RowBox[{"Transpose", "[", 
                 RowBox[{"{", 
                  RowBox[{"PadRight", "[", 
                   RowBox[{
                    RowBox[{"Conjugate", "[", "#", "]"}], ",", "\[Chi]"}], 
                   "]"}], "}"}], "]"}], "&"}], "/@", "YT"}]}], "}"}]}], 
           "]"}]}], "]"}]}], ";", "DD"}], "**)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{
         RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], ",", 
         RowBox[{"Tolerance", "->", "TOLERANCE"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"rightSite", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"3", "-", "norm1", "-", "norm2", "-", "norm3"}]}]}], 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.464934070362854*^9, 3.464934116319593*^9}, {
   3.464934518538512*^9, 3.4649345211524477`*^9}, {3.464934555899847*^9, 
   3.464934584939793*^9}, {3.464934662231352*^9, 3.464934702460699*^9}, {
   3.464934753352345*^9, 3.464934755271762*^9}, {3.464934937829904*^9, 
   3.464934938634347*^9}, {3.464935013414278*^9, 3.46493514223295*^9}, 
   3.464935172974012*^9, {3.464946082524336*^9, 3.464946175430277*^9}, {
   3.464946243178331*^9, 3.46494625217043*^9}, {3.4649463095226307`*^9, 
   3.464946328698124*^9}, {3.464946383203953*^9, 3.4649464246236*^9}, {
   3.464954131083453*^9, 3.4649541514072313`*^9}, {3.465116917346902*^9, 
   3.465116923979826*^9}, {3.46511728719028*^9, 3.465117317900653*^9}, {
   3.465117360370763*^9, 3.465117368030986*^9}, {3.465117549209631*^9, 
   3.465117616479165*^9}, {3.4651176470984383`*^9, 3.465117651023459*^9}, {
   3.4651177078854218`*^9, 3.4651177164608994`*^9}, {3.465117819345254*^9, 
   3.465117854873598*^9}, {3.465119603020979*^9, 3.4651196299968233`*^9}, {
   3.4651208359639893`*^9, 3.465120849351202*^9}, 3.4651209126355553`*^9, {
   3.465121222198867*^9, 3.4651212720074263`*^9}, {3.46512347454152*^9, 
   3.465123478061789*^9}, {3.465123936386245*^9, 3.465123950586635*^9}, {
   3.465124327195331*^9, 3.46512434944878*^9}, {3.465124460953643*^9, 
   3.4651244780492973`*^9}, {3.4651254121553802`*^9, 3.465125438921418*^9}, {
   3.465126302633801*^9, 3.46512630741492*^9}, {3.465126340862627*^9, 
   3.465126341006613*^9}, {3.46514907382867*^9, 3.465149166222949*^9}, {
   3.465149661848701*^9, 3.465149683383398*^9}, {3.465149758598386*^9, 
   3.465149758988866*^9}, {3.465149803393134*^9, 3.465149803785709*^9}, {
   3.4652096218797827`*^9, 3.465209634248837*^9}, {3.465216880990182*^9, 
   3.465216897175312*^9}, {3.466057495972681*^9, 3.466057670555315*^9}, {
   3.466057703089312*^9, 3.466057712863101*^9}, {3.466058582879929*^9, 
   3.466058592616539*^9}, {3.466058664896639*^9, 3.466058731578209*^9}, {
   3.466058817624442*^9, 3.4660588212386017`*^9}, {3.466060315165066*^9, 
   3.4660603473496523`*^9}, {3.466060415044003*^9, 3.4660605120084877`*^9}, {
   3.466061540190502*^9, 3.466061588071632*^9}}]
}, Open  ]],

Cell[CellGroupData[{

 "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBD1QGate", ",", "HoldFirst"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBD1QGate", "[", 
   RowBox[{"TEBD_", ",", "site_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "<=", "site", "<=", "numSites"}], ")"}], "\[NotEqual]", 
        "True"}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", "\"\<TEBD1QGate called with wrong site.\>\"", "]"}], 
        ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"site", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{"spin", ",", "spin"}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBD3QGate called with wrong operator dimensions.\>\"", "]"}], 
        ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"TEBD", "[", 
       RowBox[{"[", 
        RowBox[{"site", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"H", ".", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"site", ",", "1"}], "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "0"}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",\

 InitializationCell->True,
 CellChangeTimes->{{3.45165191555215*^9, 3.451651971115922*^9}, {
  3.451653276404819*^9, 3.451653281633542*^9}, {3.451653488934196*^9, 
  3.451653495796842*^9}, {3.451668975049211*^9, 3.4516689857526207`*^9}, {
  3.46495409681851*^9, 3.4649541130906973`*^9}, {3.464954197494541*^9, 
  3.464954330375037*^9}}]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

ingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", ,

Cell[CellGroupData[{

s", "-", "2"}], ",", "U"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      ",

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDEvolve", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "TEBDEvolve", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"Verbose", "\[Rule]", "False"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvolve", "[", 
   RowBox[{"TEBD_", ",", "OperatorList_", ",", 
    RowBox[{"steps_:", "1"}], ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", 
      RowBox[{"verbose", "=", 
       RowBox[{"OptionValue", "[", "Verbose", "]"}]}], ",", "message"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"verbose", ",", 
       RowBox[{"message", "=", 
        RowBox[{"PrintTemporary", "[", "\"\<Starting up.\>\"", "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{"verbose", ",", 
          RowBox[{
           RowBox[{"NotebookDelete", "[", "message", "]"}], ";", 
           RowBox[{"message", "=", 
            RowBox[{"PrintTemporary", "[", 
             RowBox[{"\"\<Evolving step \>\"", "<>", 
              RowBox[{"ToString", "[", "m", "]"}], "<>", "\"\< of \>\"", "<>", 
              RowBox[{"ToString", "[", "steps", "]"}]}], "]"}]}]}]}], "]"}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"error", "+=", 
            RowBox[{"TEBDGate", "[", 
             RowBox[{"TEBD", ",", 
              RowBox[{"OperatorList", "[", 
               RowBox[{"[", "n", "]"}], "]"}]}], "]"}]}], ";"}], 
          "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "1", ",", 
            RowBox[{"Length", "[", "OperatorList", "]"}], ",", "1"}], "}"}]}],
          "]"}], ";"}], "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"m", ",", "1", ",", "steps"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"verbose", ",", 
       RowBox[{"NotebookDelete", "[", "message", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]"}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498774776301*^9, 3.4874988614251003`*^9}, {
   3.4874994409681253`*^9, 3.487499559764955*^9}, {3.487499648226359*^9, 
   3.487499653002314*^9}, {3.489297135293562*^9, 3.4892971437139587`*^9}, {
   3.4893001734853067`*^9, 3.489300221489045*^9}, 3.489300298671566*^9, {
   3.489300344264732*^9, 3.4893004214462337`*^9}, {3.4893005361181297`*^9, 
   3.48930062502568*^9}, {3.489300753207473*^9, 3.489300765217803*^9}}]
}, Closed]],

Cell[CellGroupData[{

, "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        R,

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBDEvol3BodyPBC", ",", "HoldAll"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvol3BodyPBC", "[", 
   RowBox[{"TEBD_", ",", "H_", ",", "\[Tau]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin", ",", "U", ",", "Uedge"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "3"}], ",", 
          RowBox[{"spin", "^", "3"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDEvol3BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"U", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", 
        RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Uedge", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", "\[Tau]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "do", " ", "the", " ", "bulk", " ", "evolutions"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "4", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Now", " ", "the", " ", "edge", " ", "interactions", " ", "are", " ", 
       "made", " ", "through", " ", 
       RowBox[{"swaps", ".", " ", "Sites"}], " ", "1", " ", "and", " ", "2", 
       " ", "are", " ", "taken", " ", "to", " ", "the", " ", "right", " ", 
       "end"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", 
           RowBox[{"n", "+", "1"}], ",", "Swap"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Swap"}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "2"}]}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "2"}], ",", "U"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Up", " ", "to", " ", "here", " ", "is", " ", "one", " ", "evolution", 
       " ", "operator", " ", "for", " ", "half", " ", "the", " ", 
       RowBox[{"time", ".", " ", "Now"}], " ", "do", " ", "the", " ", 
       "central"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "1"}], ",", "Uedge"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "From", " ", "here", " ", "do", " ", "the", " ", "same", " ", 
       "transposed"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "2"}], ",", "U"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Swap", " ", "back", " ", "into", " ", "position"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Swap"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", 
           RowBox[{"n", "+", "1"}], ",", "Swap"}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", 
         RowBox[{"numSites", "-", "2"}], ",", "1", ",", 
         RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Do", " ", "the", " ", "bulk", " ", "again"}], " ", "*)"}], " ",
      "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "4", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465100771595151*^9, 3.4651008164611607`*^9}, {
   3.465100861576912*^9, 3.46510090076712*^9}, {3.465100942510742*^9, 
   3.465100947186409*^9}, {3.465101007084166*^9, 3.465101017212122*^9}, {
   3.465101079645039*^9, 3.465101308193961*^9}, {3.465101339728163*^9, 
   3.465101542113772*^9}, {3.465101574980167*^9, 3.4651015959368677`*^9}, {
   3.4651123577447157`*^9, 3.4651123981344633`*^9}, {3.465115686078024*^9, 
   3.4651159255440817`*^9}, 3.465115962043404*^9, {3.4651169939531927`*^9, 
   3.465116994554381*^9}, {3.4651171174977427`*^9, 3.465117132115423*^9}, {
   3.4651179243090773`*^9, 3.465117974953124*^9}, {3.465118028334262*^9, 
   3.465118033293911*^9}, {3.465149757117627*^9, 3.4651497581193657`*^9}, {
   3.4651498038920193`*^9, 3.465149804021372*^9}, {3.4651499310325403`*^9, 
   3.465149931853634*^9}, {3.487498737913488*^9, 3.487498740115356*^9}}],

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBDEvol3BodyPBCDisorder", ",", "HoldAll"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvol3BodyPBCDisorder", "[", 
   RowBox[{"TEBD_", ",", "H_", ",", "\[Tau]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{"numSites", ",", 
          RowBox[{"spin", "^", "3"}], ",", 
          RowBox[{"spin", "^", "3"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDEvol3BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "do", " ", "the", " ", "bulk", " ", "evolutions"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "4", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Now", " ", "the", " ", "edge", " ", "interactions", " ", "are", " ", 
       "made", " ", "through", " ", 
       RowBox[{"swaps", ".", " ", "Sites"}], " ", "1", " ", "and", " ", "2", 
       " ", "are", " ", "taken", " ", "to", " ", "the", " ", "right", " ", 
       "end"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", 
           RowBox[{"n", "+", "1"}], ",", "Swap"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Swap"}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "2"}]}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "2"}], ",", 
        RowBox[{"MatrixExp", "[", 
         RowBox[{
          RowBox[{"-", "I"}], " ", 
          RowBox[{"H", " ", "[", 
           RowBox[{"[", 
            RowBox[{"numSites", "-", "2"}], "]"}], "]"}], 
          RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Up", " ", "to", " ", "here", " ", "is", " ", "one", " ", "evolution", 
       " ", "operator", " ", "for", " ", "half", " ", "the", " ", 
       RowBox[{"time", ".", " ", "Now"}], " ", "do", " ", "the", " ", 
       "central"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "1"}], ",", 
        RowBox[{"MatrixExp", "[", 
         RowBox[{
          RowBox[{"-", "I"}], " ", 
          RowBox[{"H", " ", "[", 
           RowBox[{"[", 
            RowBox[{"numSites", "-", "1"}], "]"}], "]"}], "\[Tau]"}], "]"}]}],
        "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "From", " ", "here", " ", "do", " ", "the", " ", "same", " ", 
       "transposed"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD3QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "2"}], ",", 
        RowBox[{"MatrixExp", "[", 
         RowBox[{
          RowBox[{"-", "I"}], " ", 
          RowBox[{"H", " ", "[", 
           RowBox[{"[", 
            RowBox[{"numSites", "-", "2"}], "]"}], "]"}], 
          RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Swap", " ", "back", " ", "into", " ", "position"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Swap"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", 
           RowBox[{"n", "+", "1"}], ",", "Swap"}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", 
         RowBox[{"numSites", "-", "2"}], ",", "1", ",", 
         RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Do", " ", "the", " ", "bulk", " ", "again"}], " ", "*)"}], " ",
      "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "4", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465116278359849*^9, 3.465116386900627*^9}, {
  3.465149910591278*^9, 3.465149911474909*^9}, {3.465219360612968*^9, 
  3.465219376072695*^9}}],

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBDEvol3BodyOBC", ",", "HoldAll"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvol3BodyOBC", "[", 
   RowBox[{"TEBD_", ",", "H_", ",", "\[Tau]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin", ",", "U", ",", "Uedge"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "3"}], ",", 
          RowBox[{"spin", "^", "3"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDEvol3BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"U", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", 
        RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Uedge", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", "\[Tau]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "do", " ", "the", " ", "bulk", " ", "evolutions"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Uedge"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "4", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465203655402729*^9, 3.465203686513536*^9}, 
   3.465203738730357*^9}],

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBDEvol3BodyOBCDisorder", ",", "HoldAll"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvol3BodyOBCDisorder", "[", 
   RowBox[{"TEBD_", ",", "H_", ",", "\[Tau]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{"numSites", ",", 
          RowBox[{"spin", "^", "3"}], ",", 
          RowBox[{"spin", "^", "3"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDEvol3BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "do", " ", "the", " ", "bulk", " ", "evolutions"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], "\[Tau]"}], "]"}]}], "]"}]}], 
        ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "4", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "3", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD3QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", 
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"-", "I"}], " ", 
             RowBox[{"H", " ", "[", 
              RowBox[{"[", "n", "]"}], "]"}], 
             RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "3"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

, "[", 
         "\"\<TEBDEvol3BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";,

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBDEvol2BodyPBC", ",", "HoldAll"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvol2BodyPBC", "[", 
   RowBox[{"TEBD_", ",", "H_", ",", "\[Tau]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin", ",", "U", ",", "Uedge"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "2"}], ",", 
          RowBox[{"spin", "^", "2"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDEvol2BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"U", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", 
        RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Uedge", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", "\[Tau]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "do", " ", "the", " ", "bulk", " ", "evolutions"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Now", " ", "the", " ", "edge", " ", "interactions", " ", "are", " ", 
       "made", " ", "through", " ", 
       RowBox[{"swaps", "."}]}], "  ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Swap"}], "]"}]}], ";"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "1"}]}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Up", " ", "to", " ", "here", " ", "is", " ", "one", " ", "evolution", 
       " ", "operator", " ", "for", " ", "half", " ", "the", " ", 
       RowBox[{"time", ".", " ", "Now"}], " ", "do", " ", "the", " ", 
       "central"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"TEBD2QGate", "[", 
       RowBox[{"TEBD", ",", 
        RowBox[{"numSites", "-", "1"}], ",", "Uedge"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "From", " ", "here", " ", "do", " ", "the", " ", "same", " ", 
       "transposed"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Swap", " ", "back", " ", "into", " ", "position"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "Swap"}], "]"}]}], ";"}], 
       "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "1", ",", 
         RowBox[{"-", "1"}]}], "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Do", " ", "the", " ", "bulk", " ", "again"}], " ", "*)"}], " ",
      "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"error", "+=", 
         RowBox[{"TEBD2QGate", "[", 
          RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ";"}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.46515521704694*^9, 3.465155227613367*^9}, {
  3.465155258907736*^9, 3.465155406552537*^9}, {3.4874848043138638`*^9, 
  3.487484804807372*^9}}],

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"TEBDEvol2BodyOBC", ",", "HoldAll"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvol2BodyOBC", "[", 
   RowBox[{"TEBD_", ",", "H_", ",", "\[Tau]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"error", ",", "numSites", ",", "spin", ",", "U", ",", "Uedge"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "H", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "2"}], ",", 
          RowBox[{"spin", "^", "2"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDEvol3BodyPBC called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"U", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", 
        RowBox[{"\[Tau]", "/", "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Uedge", "=", 
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "H", " ", "\[Tau]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "do", " ", "the", " ", "bulk", " ", "evolutions"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"error", "+=", 
        RowBox[{"TEBD2QGate", "[", 
         RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"*", 
         RowBox[{"OPrint", "[", 
          RowBox[{"\"\<n\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}]}], "]"}]}], ";", "DD"}], 
       "**)"}], 
      RowBox[{
       RowBox[{"error", "+=", 
        RowBox[{"TEBD2QGate", "[", 
         RowBox[{"TEBD", ",", "n", ",", "Uedge"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "2", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"error", "+=", 
        RowBox[{"TEBD2QGate", "[", 
         RowBox[{"TEBD", ",", "n", ",", "U"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", 
         RowBox[{"numSites", "-", "1"}], ",", "2"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465186213634976*^9, 3.465186275295484*^9}}]
}, Closed]]
}, Closed]],

Cell[CellGroupData[{


         RowBox[{
         "1", "\[LessEqual]", "siteL", "<", "siteR", "<=", "numSites"}], 
         ")",

Cell[CellGroupData[{

}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDExpectation2OList called with wrong site parameter.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"},

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDExpectation", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDExpectation", "[", 
   RowBox[{"TEBD_", ",", "site_", ",", "Operator_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "Mdown", ",", "Mup", ",", "value", ",", "numSites", ",", "\[Lambda]L", 
      ",", "\[Lambda]R", ",", "spin"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"value", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "\[LessEqual]", "site", "<=", "numSites"}], ")"}], 
        "\[NotEqual]", "True"}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDExpectation1O called with wrong site parameter.\>\"", "]"}],
         ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"site", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "Operator", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{"spin", ",", "spin"}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDExpectation1O called with wrong operator dimensions.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"site", "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]L", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"numSites", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
        ";"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]L", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"site", "-", "1"}], ",", "2"}], "]"}], "]"}], "]"}], 
          "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]R", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"site", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Mup", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"\[Lambda]L", ".", 
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{"Operator", ".", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"site", ",", "1"}], "]"}], "]"}]}], ")"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
        "\[Lambda]R"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Mdown", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"\[Lambda]L", ".", 
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{"Conjugate", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"site", ",", "1"}], "]"}], "]"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
        "\[Lambda]R"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Chop", "[", 
      RowBox[{"Mdown", ".", "Mup"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->CompressedData["
1:eJwd0Gkog3EAx/HH4xgKL3hBrimZ5ChNbZrjP5aMpE17QTlWaqKGEmu5i0KO
NyP2ypk3SzPnCwnlaFvshSstL5A/WTlzFc/vefHt8/4bp9WralmGYaK54LXv
WcSNlRJ38ZUQTsUov+DQTMIPtB3OBt5yvj01xcORydMByOp8BqHebLJAn0nz
EtSu3/5CpsrDy+o1kXec8ny1CIqTjSkwVVkqhea6zxzIZvfmws2jMCW89MiL
oCpJoIYxLxpem8NSDZ3SnRpYPhxUD0vdc81wSylshXv9Bl7ThcIIG4vuu2BP
6EYvs0xJRvs7r3ysYrPORon/omQPOne9nuwrlERbdgMcnO44XTp0PUvF8EE4
eliySsmAndhh1KNRcs450fcqgw0p3sHda5RkThfzlndW5l0fU5IwflMAv8vC
W2CbddsAWY27HSpGXzvgvLhwEAb79S9Cv9gMQ+4J92vB2gFlNud+iIsSgTHr
AKZ/fIjS/ihZ0mkT4T/7AQXs
  "]]
}, Closed]],

Cell[CellGroupData[{

Cell["Two qubit expectation values return a correlation List.", \
"Subsubsection",
 CellChangeTimes->{{3.450111436694368*^9, 3.450111450732808*^9}, {
  3.4516523129440727`*^9, 3.4516523170839376`*^9}, {3.4516537649570837`*^9, 
  3.451653766163197*^9}, {3.464955721022832*^9, 3.464955739464076*^9}, {
  3.464955796279434*^9, 3.464955804486486*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDExpectationList", ",", "HoldAll"}], "]"}], ";", 
  RowBox[{
   RowBox[{"TEBDExpectationList", "[", 
    RowBox[{
    "TEBD_", ",", "site1_", ",", "site2_", ",", "OperatorL_", ",", 
     "OperatorR_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "numSites", ",", "M", ",", "temp", ",", "spin", ",", "\[Lambda]L", ",", 
       "siteL", ",", "siteR"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numSites", "=", 
       RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"siteL", ",", "siteR"}], "}"}], "=", 
       RowBox[{"Sort", "[", 
        RowBox[{"{", 
         RowBox[{"site1", ",", "site2"}], "}"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
          "1", "\[LessEqual]", "siteL", "<", "siteR", "<=", "numSites"}], 
          ")"}], "\[NotEqual]", "True"}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<TEBDExpectation2OList called with wrong site parameter.\>\"", 
          "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"spin", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"siteL", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "OperatorL", "]"}], "\[NotEqual]", 
          RowBox[{"{", 
           RowBox[{"spin", ",", "spin"}], "}"}]}], "||", 
         RowBox[{
          RowBox[{"Dimensions", "[", "OperatorR", "]"}], "\[NotEqual]", 
          RowBox[{"{", 
           RowBox[{"spin", ",", "spin"}], "}"}]}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<TEBDExpectation1O called with wrong operator dimensions.\>\"", 
          "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"siteL", "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Lambda]L", "=", 
          RowBox[{"SparseArray", "[", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"numSites", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
         ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Lambda]L", "=", 
          RowBox[{"SparseArray", "[", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"siteL", "-", "1"}], ",", "2"}], "]"}], "]"}], "]"}], 
           "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "This", " ", "will", " ", "do", " ", "a", " ", "loop", " ", "over", 
        " ", "the", " ", "different", " ", "tensors", " ", "in", " ", "the", 
        " ", "TEBD"}], " ", "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "First", " ", "prepare", " ", "the", " ", "initial", " ", "matrix", 
        " ", "with", " ", "the", " ", "action", " ", "of", " ", "the", " ", 
        "Operator1", " ", "on", " ", "the", " ", "starting", " ", "tensor"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"siteL", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
        RowBox[{"Sum", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConjugateTranspose", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"siteL", ",", "1", ",", "i"}], "]"}], "]"}], "]"}], ".", 
           RowBox[{"(", 
            RowBox[{"\[Lambda]L", "^", "2"}], ")"}], ".", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"OperatorL", ".", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{"siteL", ",", "1"}], "]"}], "]"}]}], ")"}], "[", 
             RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"siteL", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "The", " ", "expectation", " ", "value", " ", "is", " ", "added", " ", 
        "a", " ", "table", " ", "as", " ", "a", " ", "function", " ", "of", 
        " ", "distance"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"dist", ",", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "First", " ", "we", " ", "calculate", " ", "the", " ", 
            "expectation", " ", "value", " ", "using", " ", "Operator2"}], 
           " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"temp", "=", 
            RowBox[{"Tr", "[", 
             RowBox[{
              RowBox[{"SparseArray", "[", 
               RowBox[{"DiagonalMatrix", "[", 
                RowBox[{"TEBD", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"siteL", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
                "]"}], "]"}], ".", 
              RowBox[{"Sum", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"ConjugateTranspose", "[", 
                  RowBox[{"TEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"siteL", "+", "dist"}], ",", "1", ",", "i"}], 
                    "]"}], "]"}], "]"}], ".", "M", ".", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{"OperatorR", ".", 
                    RowBox[{"TEBD", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"siteL", "+", "dist"}], ",", "1"}], "]"}], 
                    "]"}]}], ")"}], "[", 
                   RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
              RowBox[{"SparseArray", "[", 
               RowBox[{"DiagonalMatrix", "[", 
                RowBox[{"TEBD", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"siteL", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
                "]"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "Now", " ", "almost", " ", "the", " ", "same", " ", 
              "computation", " ", "but", " ", "for", " ", "the", " ", 
              "following", " ", "iteration"}], ",", " ", 
             RowBox[{
              RowBox[{"without", " ", "the", " ", 
               RowBox[{"Operator2", ".", " ", "The"}], " ", "last", " ", 
               "computation", " ", "is", " ", "useless"}], "..."}]}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"M", "=", 
            RowBox[{
             RowBox[{"SparseArray", "[", 
              RowBox[{"DiagonalMatrix", "[", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"siteL", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
               "]"}], "]"}], ".", 
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", 
                 RowBox[{"TEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{
                    RowBox[{"siteL", "+", "dist"}], ",", "1", ",", "i"}], 
                   "]"}], "]"}], "]"}], ".", "M", ".", 
                RowBox[{"TEBD", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"siteL", "+", "dist"}], ",", "1", ",", "i"}], 
                  "]"}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
             RowBox[{"SparseArray", "[", 
              RowBox[{"DiagonalMatrix", "[", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"siteL", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
               "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"Chop", "[", "temp", "]"}]}]}], "\[IndentingNewLine]", 
         "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"dist", ",", "1", ",", 
          RowBox[{"siteR", "-", "siteL"}]}], "}"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{
  3.489297324263692*^9, {3.489297363704648*^9, 3.489297365481489*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDExpectation", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDExpectation", "[", 
   RowBox[{
   "TEBD_", ",", "siteL_", ",", "siteR_", ",", "OperatorL_", ",", 
    "OperatorR_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"Last", "[", 
    RowBox[{"TEBDExpectationList", "[", 
     RowBox[{
     "TEBD", ",", "siteL", ",", "siteR", ",", "OperatorL", ",", "OperatorR"}],
      "]"}], "]"}], "[", 
   RowBox[{"[", "2", "]"}], "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.45050873136408*^9, 3.4505087972512503`*^9}, {
   3.450508831075302*^9, 3.450508853306519*^9}, {3.450509151084873*^9, 
   3.450509175942548*^9}, {3.4505092808396597`*^9, 3.450509298782295*^9}, {
   3.450509587829466*^9, 3.450509703474001*^9}, {3.4505097487305317`*^9, 
   3.450509996302004*^9}, {3.4505102863956337`*^9, 3.450510359953023*^9}, {
   3.450510396395653*^9, 3.450510469887895*^9}, {3.450510506578932*^9, 
   3.450510519464325*^9}, {3.4505105495340242`*^9, 3.45051055740023*^9}, {
   3.450510591377123*^9, 3.450510701237884*^9}, {3.45051086847309*^9, 
   3.450510871682789*^9}, {3.4505489187011843`*^9, 3.450548918928994*^9}, {
   3.450548960296475*^9, 3.450548962389139*^9}, {3.450548992557152*^9, 
   3.450549015434885*^9}, {3.450553433557428*^9, 3.450553450955553*^9}, {
   3.450553501261423*^9, 3.450553511855302*^9}, {3.4505537399331083`*^9, 
   3.450553766320888*^9}, {3.4505541368873663`*^9, 3.45055413847324*^9}, {
   3.4505542885151033`*^9, 3.450554295554166*^9}, {3.4505543332053957`*^9, 
   3.450554416525758*^9}, 3.450554971530918*^9, {3.450555010644158*^9, 
   3.450555053360941*^9}, {3.45055512449356*^9, 3.4505552327067757`*^9}, {
   3.450555293095409*^9, 3.450555297705481*^9}, {3.4505553916363773`*^9, 
   3.450555500596787*^9}, {3.450555533964933*^9, 3.450555544268778*^9}, {
   3.4505556128992043`*^9, 3.450555665551342*^9}, {3.450555700384555*^9, 
   3.4505557652795467`*^9}, {3.45055584668754*^9, 3.450555889181555*^9}, {
   3.4505559199522533`*^9, 3.450556081741782*^9}, {3.450556194468031*^9, 
   3.450556277286108*^9}, {3.4505563324339437`*^9, 3.450556486841494*^9}, {
   3.450556537578225*^9, 3.450556541702141*^9}, {3.450589287746997*^9, 
   3.450589292317965*^9}, {3.450589384447165*^9, 3.450589394151169*^9}, {
   3.451306495260172*^9, 3.451306499384297*^9}, {3.4513065418855543`*^9, 
   3.451306554919969*^9}, {3.464955757934806*^9, 3.46495576373641*^9}, {
   3.4649558191814823`*^9, 3.46495599189754*^9}, {3.464956065673009*^9, 
   3.464956110525055*^9}, {3.46495614068148*^9, 3.464956295347547*^9}, {
   3.464956478894449*^9, 3.464956497029312*^9}, {3.464956527159288*^9, 
   3.464956714249592*^9}, {3.4649567501483994`*^9, 3.4649568110123987`*^9}, {
   3.4650217981091633`*^9, 3.4650218004306793`*^9}, {3.465099341907205*^9, 
   3.465099349419525*^9}, {3.465151524150386*^9, 3.465151526680869*^9}, {
   3.465564032129361*^9, 3.465564048944642*^9}, {3.465576010923204*^9, 
   3.465576013610662*^9}, {3.489233224593123*^9, 3.489233233407682*^9}, {
   3.4892972820515223`*^9, 3.489297321148403*^9}, 3.489297371812711*^9}]
}, Closed]],

Cell[CellGroupData[{

Cell["Three qubit expectation value", "Subsubsection",
 CellChangeTimes->{{3.465098982392621*^9, 3.465098988111363*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDExpectation3O", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TEBDExpectation", "[", 
    RowBox[{
    "TEBD_", ",", "site1_", ",", "site2_", ",", "site3_", ",", "OperatorL_", 
     ",", "OperatorC_", ",", "OperatorR_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "numSites", ",", "M", ",", "temp", ",", "spin", ",", "\[Lambda]L", ",", 
       "siteL", ",", "siteC", ",", "siteR"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numSites", "=", 
       RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"siteL", ",", "siteC", ",", "siteR"}], "}"}], "=", 
       RowBox[{"Sort", "[", 
        RowBox[{"{", 
         RowBox[{"site1", ",", "site2", ",", "site3"}], "}"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          RowBox[{
          "1", "\[LessEqual]", "siteL", "<", "siteC", "<", "siteR", "<=", 
           "numSites"}], ")"}], "\[NotEqual]", "True"}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<TEBDExpectation3O called with wrong site parameter.\>\"", 
          "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"spin", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"TEBD", "[", 
         RowBox[{"[", 
          RowBox[{"siteL", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Dimensions", "[", "OperatorL", "]"}], "\[NotEqual]", 
          RowBox[{"{", 
           RowBox[{"spin", ",", "spin"}], "}"}]}], "||", 
         RowBox[{
          RowBox[{"Dimensions", "[", "OperatorC", "]"}], "\[NotEqual]", 
          RowBox[{"{", 
           RowBox[{"spin", ",", "spin"}], "}"}]}], "||", 
         RowBox[{
          RowBox[{"Dimensions", "[", "OperatorR", "]"}], "\[NotEqual]", 
          RowBox[{"{", 
           RowBox[{"spin", ",", "spin"}], "}"}]}]}], ",", 
        RowBox[{
         RowBox[{
         "Print", "[", 
          "\"\<TEBDExpectation1O called with wrong operator dimensions.\>\"", 
          "]"}], ";", 
         RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"siteL", "\[Equal]", "1"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Lambda]L", "=", 
          RowBox[{"SparseArray", "[", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"numSites", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
         ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"\[Lambda]L", "=", 
          RowBox[{"SparseArray", "[", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"siteL", "-", "1"}], ",", "2"}], "]"}], "]"}], "]"}], 
           "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "First", " ", "prepare", " ", "the", " ", "initial", " ", "matrix", 
        " ", "with", " ", "the", " ", "action", " ", "of", " ", "the", " ", 
        "OperatorL", " ", "on", " ", "the", " ", "starting", " ", "tensor"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"siteL", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
        RowBox[{"Sum", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConjugateTranspose", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"siteL", ",", "1", ",", "i"}], "]"}], "]"}], "]"}], ".", 
           RowBox[{"(", 
            RowBox[{"\[Lambda]L", "^", "2"}], ")"}], ".", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"OperatorL", ".", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{"siteL", ",", "1"}], "]"}], "]"}]}], ")"}], "[", 
             RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"siteL", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Now", " ", "eat", " ", "tensors", " ", "away", " ", "until", " ", 
        "the", " ", "center", " ", "site", " ", "siteC"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"M", "=", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{"DiagonalMatrix", "[", 
             RowBox[{"TEBD", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"siteL", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
             "]"}], "]"}], ".", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"ConjugateTranspose", "[", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"siteL", "+", "dist"}], ",", "1", ",", "i"}], "]"}],
                 "]"}], "]"}], ".", "M", ".", 
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"siteL", "+", "dist"}], ",", "1", ",", "i"}], "]"}], 
               "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"DiagonalMatrix", "[", 
             RowBox[{"TEBD", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"siteL", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
             "]"}], "]"}]}]}], ";"}], ",", 
        RowBox[{"{", 
         RowBox[{"dist", ",", "1", ",", 
          RowBox[{"siteC", "-", "1", "-", "siteL"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Now", " ", "eat", " ", "the", " ", "center", " ", "tensor"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"M", "=", 
       RowBox[{
        RowBox[{"SparseArray", "[", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"siteC", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
        RowBox[{"Sum", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"ConjugateTranspose", "[", 
            RowBox[{"TEBD", "[", 
             RowBox[{"[", 
              RowBox[{"siteC", ",", "1", ",", "i"}], "]"}], "]"}], "]"}], ".",
            "M", ".", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"OperatorR", ".", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{"siteC", ",", "1"}], "]"}], "]"}]}], ")"}], "[", 
             RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"siteC", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "And", " ", "keep", " ", "on", " ", "going", " ", "until", " ", "we", 
        " ", "reach", " ", "the", " ", "last", " ", "tensor"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"M", "=", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{"DiagonalMatrix", "[", 
             RowBox[{"TEBD", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"siteC", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
             "]"}], "]"}], ".", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"ConjugateTranspose", "[", 
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"siteC", "+", "dist"}], ",", "1", ",", "i"}], "]"}],
                 "]"}], "]"}], ".", "M", ".", 
              RowBox[{"TEBD", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"siteC", "+", "dist"}], ",", "1", ",", "i"}], "]"}], 
               "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"DiagonalMatrix", "[", 
             RowBox[{"TEBD", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"siteC", "+", "dist"}], ",", "2"}], "]"}], "]"}], 
             "]"}], "]"}]}]}], ";"}], ",", 
        RowBox[{"{", 
         RowBox[{"dist", ",", "1", ",", 
          RowBox[{"siteR", "-", "1", "-", "siteC"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Return", " ", "expectation", " ", "value"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Chop", "[", 
       RowBox[{"Tr", "[", 
        RowBox[{
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"siteR", ",", "2"}], "]"}], "]"}], "]"}], "]"}], ".", 
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"ConjugateTranspose", "[", 
             RowBox[{"TEBD", "[", 
              RowBox[{"[", 
               RowBox[{"siteR", ",", "1", ",", "i"}], "]"}], "]"}], "]"}], 
            ".", "M", ".", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"(", 
               RowBox[{"OperatorR", ".", 
                RowBox[{"TEBD", "[", 
                 RowBox[{"[", 
                  RowBox[{"siteR", ",", "1"}], "]"}], "]"}]}], ")"}], "[", 
              RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"i", ",", "1", ",", "spin"}], "}"}]}], "]"}], ".", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"siteR", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], "]"}],
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDExpectation3O", "[", 
   RowBox[{"TEBD_", ",", "site_", ",", "Operator_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "numSites", ",", "M", ",", "temp", ",", "spin", ",", "\[Lambda]L"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "<", "site", "<", "numSites"}], ")"}], "\[NotEqual]", 
        "True"}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDExpectation3O (B) called with wrong site parameter.\>\"", 
         "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"site", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Dimensions", "[", "Operator", "]"}], "\[NotEqual]", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"spin", "^", "3"}], ",", 
          RowBox[{"spin", "^", "3"}]}], "}"}]}], ",", 
       RowBox[{
        RowBox[{
        "Print", "[", 
         "\"\<TEBDExpectation1O(B) called with wrong operator \
dimensions.\>\"", "]"}], ";", 
        RowBox[{"Abort", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"site", "\[Equal]", "2"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]L", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"numSites", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], 
        ";"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\[Lambda]L", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"DiagonalMatrix", "[", 
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{
              RowBox[{"site", "-", "2"}], ",", "2"}], "]"}], "]"}], "]"}], 
          "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "First", " ", "prepare", " ", "the", " ", "initial", " ", "matrix", " ",
        "with", " ", "the", " ", "action", " ", "of", " ", "the", " ", 
       "OperatorL", " ", "on", " ", "the", " ", "starting", " ", "tensor"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"M", "=", 
      RowBox[{
       RowBox[{"SparseArray", "[", 
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"TEBD", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"site", "+", "1"}], ",", "2"}], "]"}], "]"}], "]"}], 
        "]"}], ".", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ConjugateTranspose", "[", 
           RowBox[{
            RowBox[{"Flatten", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"TEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"site", "-", "1"}], ",", "1"}], "]"}], "]"}], ".", 
               RowBox[{"SparseArray", "[", 
                RowBox[{"DiagonalMatrix", "[", 
                 RowBox[{"TEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{
                    RowBox[{"site", "-", "1"}], ",", "2"}], "]"}], "]"}], 
                 "]"}], "]"}], ".", 
               RowBox[{"Transpose", "[", 
                RowBox[{
                 RowBox[{"TEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{"site", ",", "1"}], "]"}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
               RowBox[{"SparseArray", "[", 
                RowBox[{"DiagonalMatrix", "[", 
                 RowBox[{"TEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{"site", ",", "2"}], "]"}], "]"}], "]"}], "]"}], 
               ".", 
               RowBox[{"Transpose", "[", 
                RowBox[{
                 RowBox[{"TEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{
                    RowBox[{"site", "+", "1"}], ",", "1"}], "]"}], "]"}], ",", 
                 RowBox[{"{", 
                  RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"1", ",", "3", ",", "4"}], "}"}], ",", 
                RowBox[{"{", "2", "}"}], ",", 
                RowBox[{"{", "5", "}"}]}], "}"}]}], "]"}], "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}], ".", 
          RowBox[{"(", 
           RowBox[{"\[Lambda]L", "^", "2"}], ")"}], ".", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Operator", ".", 
             RowBox[{"Flatten", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"TEBD", "[", 
                 RowBox[{"[", 
                  RowBox[{
                   RowBox[{"site", "-", "1"}], ",", "1"}], "]"}], "]"}], ".", 
                
                RowBox[{"SparseArray", "[", 
                 RowBox[{"DiagonalMatrix", "[", 
                  RowBox[{"TEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"site", "-", "1"}], ",", "2"}], "]"}], "]"}], 
                  "]"}], "]"}], ".", 
                RowBox[{"Transpose", "[", 
                 RowBox[{
                  RowBox[{"TEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{"site", ",", "1"}], "]"}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
                RowBox[{"SparseArray", "[", 
                 RowBox[{"DiagonalMatrix", "[", 
                  RowBox[{"TEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{"site", ",", "2"}], "]"}], "]"}], "]"}], "]"}], 
                ".", 
                RowBox[{"Transpose", "[", 
                 RowBox[{
                  RowBox[{"TEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"site", "+", "1"}], ",", "1"}], "]"}], "]"}], ",", 
                  RowBox[{"{", 
                   RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"1", ",", "3", ",", "4"}], "}"}], ",", 
                 RowBox[{"{", "2", "}"}], ",", 
                 RowBox[{"{", "5", "}"}]}], "}"}]}], "]"}]}], 
            "\[IndentingNewLine]", ")"}], "[", 
           RowBox[{"[", "i", "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", 
           RowBox[{"spin", "^", "3"}]}], "}"}]}], "]"}], ".", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"TEBD", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"site", "+", "1"}], ",", "2"}], "]"}], "]"}], "]"}], 
        "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Chop", "[", 
      RowBox[{"Tr", "[", "M", "]"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.45050873136408*^9, 3.4505087972512503`*^9}, {
   3.450508831075302*^9, 3.450508853306519*^9}, {3.450509151084873*^9, 
   3.450509175942548*^9}, {3.4505092808396597`*^9, 3.450509298782295*^9}, {
   3.450509587829466*^9, 3.450509703474001*^9}, {3.4505097487305317`*^9, 
   3.450509996302004*^9}, {3.4505102863956337`*^9, 3.450510359953023*^9}, {
   3.450510396395653*^9, 3.450510469887895*^9}, {3.450510506578932*^9, 
   3.450510519464325*^9}, {3.4505105495340242`*^9, 3.45051055740023*^9}, {
   3.450510591377123*^9, 3.450510701237884*^9}, {3.45051086847309*^9, 
   3.450510871682789*^9}, {3.4505489187011843`*^9, 3.450548918928994*^9}, {
   3.450548960296475*^9, 3.450548962389139*^9}, {3.450548992557152*^9, 
   3.450549015434885*^9}, {3.450553433557428*^9, 3.450553450955553*^9}, {
   3.450553501261423*^9, 3.450553511855302*^9}, {3.4505537399331083`*^9, 
   3.450553766320888*^9}, {3.4505541368873663`*^9, 3.45055413847324*^9}, {
   3.4505542885151033`*^9, 3.450554295554166*^9}, {3.4505543332053957`*^9, 
   3.450554416525758*^9}, 3.450554971530918*^9, {3.450555010644158*^9, 
   3.450555053360941*^9}, {3.45055512449356*^9, 3.4505552327067757`*^9}, {
   3.450555293095409*^9, 3.450555297705481*^9}, {3.4505553916363773`*^9, 
   3.450555500596787*^9}, {3.450555533964933*^9, 3.450555544268778*^9}, {
   3.4505556128992043`*^9, 3.450555665551342*^9}, {3.450555700384555*^9, 
   3.4505557652795467`*^9}, {3.45055584668754*^9, 3.450555889181555*^9}, {
   3.4505559199522533`*^9, 3.450556081741782*^9}, {3.450556194468031*^9, 
   3.450556277286108*^9}, {3.4505563324339437`*^9, 3.450556486841494*^9}, {
   3.450556537578225*^9, 3.450556541702141*^9}, {3.450589287746997*^9, 
   3.450589292317965*^9}, {3.450589384447165*^9, 3.450589394151169*^9}, {
   3.451306495260172*^9, 3.451306499384297*^9}, {3.4513065418855543`*^9, 
   3.451306554919969*^9}, {3.464955757934806*^9, 3.46495576373641*^9}, {
   3.4649558191814823`*^9, 3.46495599189754*^9}, {3.464956065673009*^9, 
   3.464956110525055*^9}, {3.46495614068148*^9, 3.464956295347547*^9}, {
   3.464956478894449*^9, 3.464956497029312*^9}, {3.464956527159288*^9, 
   3.464956714249592*^9}, {3.4649567501483994`*^9, 3.4649568110123987`*^9}, {
   3.4650217981091633`*^9, 3.4650218004306793`*^9}, {3.4650989923459*^9, 
   3.4650991238974457`*^9}, {3.465099159411948*^9, 3.465099242546809*^9}, {
   3.4650993631851997`*^9, 3.465099366626742*^9}, {3.465099414475485*^9, 
   3.465099491120695*^9}, {3.465099525688613*^9, 3.465099561637034*^9}, 
   3.465151554143464*^9, {3.4652041519456663`*^9, 3.465204288573807*^9}, {
   3.465204337868471*^9, 3.465204370458914*^9}, {3.465204462185686*^9, 
   3.465204463494526*^9}, {3.465204646113821*^9, 3.465204655058152*^9}, {
   3.4652046989034233`*^9, 3.4652046996477013`*^9}, {3.4652047942633533`*^9, 
   3.465204891040166*^9}, {3.465205001412037*^9, 3.4652050904274673`*^9}, {
   3.465205211713393*^9, 3.465205232082553*^9}, {3.46521790762715*^9, 
   3.465217967575268*^9}, 3.465218147845744*^9, {3.465563880068088*^9, 
   3.4655639128877077`*^9}, {3.465563958747155*^9, 3.465563983549556*^9}, {
   3.465576020479024*^9, 3.465576033419207*^9}, {3.489233238679781*^9, 
   3.489233238829254*^9}}]
}, Closed]],

Cell["Overlap", "Subsubsection",
 CellChangeTimes->{{3.489301012166276*^9, 3.4893010137965727`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

",", "1", ",", "i"}], "]"}], 
               "]"}], "]"}], ".", "M", ".", 
             RowBox[{"TEBD", "[",

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"TEBDEntropy", "[", "\[Lambda]_", "]"}], ":=", 
   RowBox[{"-", 
    RowBox[{"Sum", "[", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"\[Lambda]", "[", 
          RowBox[{"[", "n", "]"}], "]"}], ">", "0"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"\[Lambda]", "[", 
           RowBox[{"[", "n", "]"}], "]"}], "^", "2"}], 
         RowBox[{"Log", "[", 
          RowBox[{"2", ",", 
           RowBox[{
            RowBox[{"\[Lambda]", "[", 
             RowBox[{"[", "n", "]"}], "]"}], "^", "2"}]}], "]"}]}], ",", 
        "0"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"n", ",", "1", ",", 
        RowBox[{"Length", "[", "\[Lambda]", "]"}]}], "}"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEntropyList", "[", "TEBD_", "]"}], ":=", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", ",", 
      RowBox[{"TEBDEntropy", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"n", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"n", ",", "1", ",", 
      RowBox[{
       RowBox[{"Length", "[", "TEBD", "]"}], "-", "1"}]}], "}"}]}], 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4652244551823683`*^9, 3.4652245136053658`*^9}, {
  3.4652245502549553`*^9, 3.465224729787477*^9}, {3.465224865508807*^9, 
  3.46522487840442*^9}, {3.465552220126238*^9, 3.465552228073814*^9}, {
  3.465552263568542*^9, 3.465552264288406*^9}, {3.4655538602400513`*^9, 
  3.4655538655738773`*^9}, {3.489301692626824*^9, 3.4893016969454117`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Hamiltonians and evolution operator for TEBDs", "Subsection",
 CellChangeTimes->{{3.487498395551654*^9, 3.487498401453321*^9}, {
  3.4892959899146137`*^9, 3.489295993072933*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDInitHamiltonian", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDInitHamiltonian", "[", "Ham_", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"{", "}"}], ")"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487504963291223*^9, 3.487504983583084*^9}, 
   3.489236563009506*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDHamiltonianAdd", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDHamiltonianAdd", "[", 
   RowBox[{"Ham_", ",", "operator_", ",", "site1_", ",", "site2_"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"Ham", "=", 
    RowBox[{"(", 
     RowBox[{"Ham", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"operator", ",", "site1", ",", "site2"}], "}"}], "}"}]}], 
     ")"}]}], ")"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498409725955*^9, 3.487498520916314*^9}, {
  3.487498551262932*^9, 3.4874985758748426`*^9}, {3.4874986667194357`*^9, 
  3.4874986722635403`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDHamiltonianAdd", "[", 
   RowBox[{
   "Ham_", ",", "operator1_", ",", "site1_", ",", "operator2_", ",", 
    "site2_"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"Ham", "=", 
    RowBox[{"(", 
     RowBox[{"Ham", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"KroneckerProduct", "[", 
          RowBox[{"operator1", ",", "operator2"}], "]"}], ",", "site1", ",", 
         "site2"}], "}"}], "}"}]}], ")"}]}], ")"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4892336958393927`*^9, 3.489233720406843*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDHamiltonianAdd", "[", 
   RowBox[{"Ham_", ",", "operator_", ",", "site_"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"Ham", "=", 
    RowBox[{"(", 
     RowBox[{"Ham", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"operator", ",", "site", ",", "site"}], "}"}], "}"}]}], 
     ")"}]}], ")"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4874990993614807`*^9, 3.487499106344589*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDEvolutionFromHamiltonian", "[", 
   RowBox[{"Ham_", ",", "time_"}], "]"}], ":=", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"MatrixExp", "[", 
       RowBox[{
        RowBox[{"-", "I"}], " ", "time", " ", 
        RowBox[{"Ham", "[", 
         RowBox[{"[", 
          RowBox[{"n", ",", "1"}], "]"}], "]"}]}], "]"}], ",", 
      RowBox[{"Ham", "[", 
       RowBox[{"[", 
        RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", 
      RowBox[{"Ham", "[", 
       RowBox[{"[", 
        RowBox[{"n", ",", "3"}], "]"}], "]"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"n", ",", "1", ",", 
      RowBox[{"Length", "[", "Ham", "]"}]}], "}"}]}], "]"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498585484786*^9, 3.48749865769564*^9}, {
  3.489296112458693*^9, 3.4892961167029047`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDInitEvolution", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDInitEvolution", "[", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"{", "}"}], ")"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487504963291223*^9, 3.487504983583084*^9}, 
   3.489236563009506*^9, {3.489296004828991*^9, 3.489296016269425*^9}, {
   3.4892964823661127`*^9, 3.489296482499692*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"TEBDEvolutionAddGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TEBDEvolutionAddGate", "[", 
   RowBox[{"U_", ",", "operator_", ",", "site1_", ",", "site2_"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"U", "=", 
    RowBox[{"(", 
     RowBox[{"U", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"operator", ",", "site1", ",", "site2"}], "}"}], "}"}]}], 
     ")"}]}], ")"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.487498409725955*^9, 3.487498520916314*^9}, {
  3.487498551262932*^9, 3.4874985758748426`*^9}, {3.4874986667194357`*^9, 
  3.4874986722635403`*^9}, {3.489296026915558*^9, 3.489296051446478*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TEBDEvolutionAddGate", "[", 
   RowBox[{"U_", ",", "operator_", ",", "site_"}], "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{"U", "=", 
    RowBox[{"(", 
     RowBox[{"U", "~", "Join", "~", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{"operator", ",", "site", ",", "site"}], "}"}], "}"}]}], 
     ")"}]}], ")"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4874990993614807`*^9, 3.487499106344589*^9}, {
  3.489296048179153*^9, 3.489296060610488*^9}}]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

  RowBox[{"numTensors", "+", "1"}]}], "]"}], "~", "Join", "~", 
         RowBox[{"{", "1", "}"}]},

, "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Rho]2", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"GL", ".", "GR"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", "numTensors"}], "]"}], ",", 
          RowBox[{"Range", "[", 
           RowBox[{
            RowBox[{"numTensors", "+", "1"}], ",", 
            RowBox[{"2", " ", "numTensors"}]}], "]"}]}], "}"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"evs", ",", "egs"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", "\[Rho]1", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"GL", "=", 
      RowBox[{
       RowBox[{"ConjugateTranspose", "[", "egs", "]"}], ".", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"Sqrt", "[", "evs", "]"}], "]"}], ".", "egs"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"evs", ",", "egs"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", 
       RowBox[{"GL", ".", "\[Rho]2", ".", "GL"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"GR", "=", 
      RowBox[{
       RowBox[{"ConjugateTranspose", "[", "egs", "]"}], ".", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"Sqrt", "[", "evs", "]"}], "]"}], ".", "egs"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Tr", "[", "GR", "]"}], "^", "2"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 Evaluatable->False,
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["Finalize private section", "Section",
 CellChangeTimes->{{3.4892326045220337`*^9, 3.489232611887883*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"End", "[", " ", "]"}], "\n"}], "\n", 
 RowBox[{"EndPackage", "[", " ", "]"}]}], "Input",
 InitializationCell->True]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1276, 756},
WindowMargins->{{3, Automatic}, {Automatic, 0}},
ShowSelection->True,
FrontEndVersion->"7.0 for Mac OS X x86 (32-bit) (February 18, 2009)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{
 "Info3479019047-6062902"->{
  Cell[178368, 4025, 225, 4, 42, "Print",
   CellTags->"Info3479019047-6062902"]}
 }
*)
(*CellTagsIndex
CellTagsIndex->{
 {"Info3479019047-6062902", 359960, 8646}
 }
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[567, 22, 389, 5, 76, "Title"],
Cell[CellGroupData[{
Cell[981, 31, 170, 3, 27, "Input"],
Cell[1154, 36, 295, 4, 27, "Output"]
}, Open  ]],
Cell[1464, 43, 173, 3, 27, "Input",
 InitializationCell->True],
Cell[1640, 48, 967, 15, 568, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[2632, 67, 579, 10, 103, "Input",
 InitializationCell->True],
Cell[3214, 79, 726, 10, 103, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[3977, 94, 320, 6, 27, "Input",
 InitializationCell->True],
Cell[4300, 102, 758, 11, 27, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[5095, 118, 280, 6, 27, "Input",
 InitializationCell->True],
Cell[5378, 126, 720, 10, 27, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[6135, 141, 319, 6, 58, "Input",
 InitializationCell->True],
Cell[6457, 149, 765, 11, 58, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[7259, 165, 356, 7, 58, "Input",
 InitializationCell->True],
Cell[7618, 174, 814, 11, 43, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[8469, 190, 308, 7, 43, "Input",
 InitializationCell->True],
Cell[8780, 199, 726, 10, 27, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[9543, 214, 294, 6, 27, "Input",
 InitializationCell->True],
Cell[9840, 222, 743, 10, 27, "Output"]
}, Open  ]],
Cell[10598, 235, 966, 17, 103, "Input",
 InitializationCell->True],
Cell[11567, 254, 871, 14, 58, "Input",
 InitializationCell->True],
Cell[12441, 270, 821, 13, 178, "Input",
 InitializationCell->True],
Cell[13265, 285, 526, 9, 27, "Input",
 InitializationCell->True],
Cell[13794, 296, 1116, 18, 133, "Input",
 InitializationCell->True],
Cell[14913, 316, 807, 13, 163, "Input",
 InitializationCell->True],
Cell[15723, 331, 645, 11, 133, "Input",
 InitializationCell->True],
Cell[16371, 344, 410, 8, 58, "Input",
 InitializationCell->True],
Cell[16784, 354, 361, 8, 43, "Input",
 InitializationCell->True],
Cell[17148, 364, 456, 9, 73, "Input",
 InitializationCell->True],
Cell[17607, 375, 520, 10, 103, "Input",
 InitializationCell->True],
Cell[18130, 387, 405, 8, 43, "Input",
 InitializationCell->True],
Cell[18538, 397, 770, 13, 133, "Input",
 InitializationCell->True],
Cell[19311, 412, 467, 13, 27, "Input",
 InitializationCell->True],
Cell[19781, 427, 687, 12, 103, "Input",
 InitializationCell->True],
Cell[20471, 441, 101, 2, 27, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[20597, 447, 101, 1, 46, "Subtitle"],
Cell[CellGroupData[{
Cell[20723, 452, 99, 1, 67, "Section"],
Cell[CellGroupData[{
Cell[20847, 457, 105, 1, 34, "Subsection"],
Cell[20955, 460, 154, 2, 26, "Text"],
Cell[21112, 464, 3263, 56, 133, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[24412, 525, 109, 1, 34, "Subsection"],
Cell[24524, 528, 2048, 62, 88, "Input",
 InitializationCell->True],
Cell[26575, 592, 1497, 50, 73, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[28109, 647, 105, 1, 26, "Subsection"],
Cell[28217, 650, 11191, 236, 253, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[39445, 891, 117, 1, 26, "Subsection"],
Cell[39565, 894, 3436, 85, 178, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[43038, 984, 216, 3, 26, "Subsection"],
Cell[43257, 989, 3243, 85, 163, "Input",
 InitializationCell->True],
Cell[46503, 1076, 1228, 34, 118, "Input",
 InitializationCell->True],
Cell[47734, 1112, 8145, 199, 433, "Input",
 InitializationCell->True],
Cell[55882, 1313, 5589, 112, 268, "Input",
 InitializationCell->True],
Cell[61474, 1427, 4749, 109, 373, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[66260, 1541, 121, 1, 26, "Subsection"],
Cell[66384, 1544, 968, 27, 58, "Input",
 InitializationCell->True],
Cell[67355, 1573, 2811, 69, 163, "Input",
 InitializationCell->True],
Cell[70169, 1644, 591, 17, 58, "Input",
 InitializationCell->True],
Cell[70763, 1663, 666, 19, 73, "Input",
 InitializationCell->True],
Cell[71432, 1684, 5952, 151, 388, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[77421, 1840, 129, 1, 26, "Subsection"],
Cell[77553, 1843, 21311, 409, 898, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[98901, 2257, 134, 2, 34, "Subsection"],
Cell[99038, 2261, 3035, 68, 223, "Input",
 InitializationCell->True],
Cell[102076, 2331, 5607, 115, 313, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[107720, 2451, 124, 1, 26, "Subsection"],
Cell[CellGroupData[{
Cell[107869, 2456, 182, 4, 24, "Subsubsection"],
Cell[108054, 2462, 46797, 1006, 1753, "Input",
 InitializationCell->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[154900, 3474, 257, 3, 34, "Subsection"],
Cell[155160, 3479, 280, 5, 26, "Text"],
Cell[155443, 3486, 1433, 40, 88, "Input",
 InitializationCell->True],
Cell[156879, 3528, 9707, 232, 433, "Input",
 InitializationCell->True],
Cell[166589, 3762, 2630, 67, 148, "Input",
 InitializationCell->True],
Cell[169222, 3831, 4717, 72, 88, "Input",
 InitializationCell->True],
Cell[173942, 3905, 1898, 47, 163, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[175865, 3956, 1144, 27, 118, "Input",
 InitializationCell->True],
Cell[177012, 3985, 811, 19, 43, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[177860, 4009, 128, 2, 27, "Input"],
Cell[177991, 4013, 212, 3, 27, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[178240, 4021, 125, 2, 27, "Input"],
Cell[178368, 4025, 225, 4, 42, "Print",
 CellTags->"Info3479019047-6062902"]
}, Open  ]],
Cell[178608, 4032, 396, 9, 27, "Input"]
}, Closed]],
Cell[CellGroupData[{
Cell[179041, 4046, 160, 2, 26, "Subsection"],
Cell[179204, 4050, 951, 25, 43, "Input",
 InitializationCell->True],
Cell[180158, 4077, 2992, 75, 163, "Input",
 InitializationCell->True],
Cell[183153, 4154, 3292, 89, 193, "Inp
}, Closed]],

Cell[CellGroupData[{

osed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[186494, 4249, 100, 1, 67, "Section"],
Cell[CellGroupData[{
Cell[1,

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"End", "[", " ", "]"}], "\n"}], "\n", 
 RowBox[{"EndPackage", "[", " ", "]"}]}], "Input"],

Cell[BoxData["\<\"MathMPS`Private`\"\>"], "Output",
 CellChangeTimes->{3.489295377961136*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1276, 756},
WindowMargins->{{-12, Automatic}, {Automatic, 85}},
ShowSelection->True,
FrontEndVersion->"7.0 for Mac OS X x86 (32-bit) (February 18, 2009)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{
 "Info3479019047-6062902"->{
  Cell[174138, 3930, 225, 4, 42, "Print",
   CellTags->"Info3479019047-6062902"]}
 }
*)
(*CellTagsIndex
CellTagsIndex->{
 {"Info3479019047-6062902", 359318, 8638}
 }
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[567, 22, 389, 5, 76, "Title"],
Cell[CellGroupData[{
Cell[981, 31, 170, 3, 27, "Input"],
Cell[1154, 36, 295, 4, 27, "Output"]
}, Open  ]],
Cell[1464, 43, 146, 2, 27, "Input"],
Cell[1613, 47, 1069, 16, 598, "Input",
 InitializationCell->True],
Cell[2685, 65, 579, 10, 103, "Input",
 InitializationCell->True],
Cell[3267, 77, 320, 6, 27, "Input",
 InitializationCell->True],
Cell[3590, 85, 280, 6, 27, "Input",
 InitializationCell->True],
Cell[3873, 93, 319, 6, 58, "Input",
 InitializationCell->True],
Cell[4195, 101, 356, 7, 58, "Input",
 InitializationCell->True],
Cell[4554, 110, 308, 7, 43, "Input",
 InitializationCell->True],
Cell[4865, 119, 294, 6, 27, "Input",
 InitializationCell->True],
Cell[5162, 127, 966, 17, 103, "Input",
 InitializationCell->True],
Cell[6131, 146, 871, 14, 58, "Input",
 InitializationCell->True],
Cell[7005, 162, 821, 13, 178, "Input",
 InitializationCell->True],
Cell[7829, 177, 526, 9, 27, "Input",
 InitializationCell->True],
Cell[8358, 188, 1116, 18, 133, "Input",
 InitializationCell->True],
Cell[9477, 208, 807, 13, 163, "Input",
 InitializationCell->True],
Cell[10287, 223, 676, 12, 133, "Input",
 InitializationCell->True],
Cell[10966, 237, 433, 8, 58, "Input",
 InitializationCell->True],
Cell[11402, 247, 361, 8, 43, "Input",
 InitializationCell->True],
Cell[11766, 257, 562, 10, 73, "Input",
 InitializationCell->True],
Cell[12331, 269, 429, 9, 88, "Input",
 InitializationCell->True],
Cell[12763, 280, 477, 9, 73, "Input",
 InitializationCell->True],
Cell[13243, 291, 405, 8, 43, "Input",
 InitializationCell->True],
Cell[13651, 301, 284, 6, 43, "Input",
 InitializationCell->True],
Cell[13938, 309, 792, 13, 103, "Input",
 InitializationCell->True],
Cell[14733, 324, 770, 13, 133, "Input",
 InitializationCell->True],
Cell[15506, 339, 774, 13, 103, "Input",
 InitializationCell->True],
Cell[16283, 354, 288, 6, 27, "Input",
 InitializationCell->True],
Cell[16574, 362, 74, 1, 27, "Input"],
Cell[CellGroupData[{
Cell[16673, 367, 101, 1, 46, "Subtitle"],
Cell[CellGroupData[{
Cell[16799, 372, 99, 1, 67, "Section"],
Cell[CellGroupData[{
Cell[16923, 377, 105, 1, 34, "Subsection"],
Cell[17031, 380, 154, 2, 26, "Text"],
Cell[17188, 384, 3454, 58, 133, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[20679, 447, 109, 1, 34, "Subsection"],
Cell[20791, 450, 2048, 62, 88, "Input",
 InitializationCell->True],
Cell[22842, 514, 1497, 50, 73, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[24376, 569, 105, 1, 26, "Subsection"],
Cell[24484, 572, 11191, 236, 253, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[35712, 813, 117, 1, 26, "Subsection"],
Cell[35832, 816, 3436, 85, 178, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[39305, 906, 216, 3, 26, "Subsection"],
Cell[39524, 911, 3243, 85, 163, "Input",
 InitializationCell->True],
Cell[42770, 998, 1228, 34, 118, "Input",
 InitializationCell->True],
Cell[44001, 1034, 8145, 199, 433, "Input",
 InitializationCell->True],
Cell[52149, 1235, 5589, 112, 268, "Input",
 InitializationCell->True],
Cell[57741, 1349, 4749, 109, 373, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[62527, 1463, 121, 1, 26, "Subsection"],
Cell[62651, 1466, 968, 27, 58, "Input",
 InitializationCell->True],
Cell[63622, 1495, 2811, 69, 163, "Input",
 InitializationCell->True],
Cell[66436, 1566, 591, 17, 58, "Input",
 InitializationCell->True],
Cell[67030, 1585, 666, 19, 73, "Input",
 InitializationCell->True],
Cell[67699, 1606, 5952, 151, 388, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[73688, 1762, 129, 1, 26, "Subsection"],
Cell[73820, 1765, 21311, 409, 898, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[95168, 2179, 134, 2, 26, "Subsection"],
Cell[95305, 2183, 3035, 68, 223, "Input",
 InitializationCell->True],
Cell[98343, 2253, 5607, 115, 313, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[103987, 2373, 124, 1, 26, "Subsection"],
Cell[CellGroupData[{
Cell[104136, 2378, 182, 4, 24, "Subsubsection"],
Cell[104321, 2384, 47086, 1012, 1753, "Input",
 InitializationCell->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[151456, 3402, 319, 4, 34, "Subsection"],
Cell[151778, 3408, 280, 5, 26, "Text"],
Cell[152061, 3415, 1433, 40, 88, "Input",
 InitializationCell->True],
Cell[153497, 3457, 9707, 232, 433, "Input",
 InitializationCell->True],
Cell[163207, 3691, 2630, 67, 148, "Input",
 InitializationCell->True],
Cell[165840, 3760, 4717, 72, 88, "Input",
 InitializationCell->True],
Cell[170560, 3834, 1898, 47, 163, "Input",
 InitializationCell->True],
Cell[172461, 3883, 1144, 27, 118, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[173630, 3914, 128, 2, 27, "Input"],
Cell[173761, 3918, 212, 3, 27, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[174010, 3926, 125, 2, 27, "Input"],
Cell[174138, 3930, 225, 4, 42, "Print",
 CellTags->"Info3479019047-6062902"]
}, Open  ]],
Cell[174378, 3937, 396, 9, 27, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[174811, 3951, 160, 2, 34, "Subsection"],
Cell[174974, 3955, 951, 25, 43, "Input",
 InitializationCell->True],
Cell[175928, 3982, 2992, 75, 163, "Input",
 InitializationCell->True],
Cell[178923, 4059, 3292, 89, 193, "Input",
 InitializationCell->True]
}, Closed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[182264, 4154, 100, 1, 67, "Section"],
Cell[CellGroupData[{
Cell[182389, 4159, 97, 1, 34, "Subsection"],
Cell[182489, 4162, 548, 14, 27, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[183074, 4181, 124, 1, 34, "Subsection"],
Cell[CellGroupData[{
Cell[183223, 4186, 173, 2, 24, "Subsubsection"],
Cell[183399, 4190, 5922, 149, 298, "Input",
 InitializationCell->True],
Cell[189324, 4341, 2712, 66, 208, "Input",
 InitializationCell->True],
Cell[192039, 4409, 3160, 73, 193, "Input",
 InitializationCell->True]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[195248, 4488, 105, 1, 26, "Subsection"],
Cell[195356, 4491, 461, 14, 27, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[195842, 4509, 106, 1, 24, "Subsubsection"],
Cell[195951, 4512, 17530, 382, 523, "Input",
 InitializationCell->True],
Cell[213484, 4896, 4762, 113, 388, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[218283, 5014, 180, 2, 24, "Subsubsection"],
Cell[218466, 5018, 18784, 469, 868, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[237287, 5492, 228, 3, 24, "Subsubsection"],
Cell[237518, 5497, 25578, 637, 1108, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[263133, 6139, 110, 1, 24, "Subsubsection"],
Cell[263246, 6142, 2218, 59, 148, "Input",
 InitializationCell->True]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[265513, 6207, 106, 1, 26, "Subsection"],
Cell[CellGroupData[{
Cell[265644, 6212, 119, 1, 24, "Subsubsection"],
Cell[265766, 6215, 2937, 70, 238, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[268740, 6290, 109, 1, 18, "Subsubsection"],
Cell[268852, 6293, 8305, 208, 493, "Input",
 InitializationCell->True],
Cell[277160, 6503, 8660, 224, 463, "Input",
 InitializationCell->True],
Cell[285823, 6729, 4239, 118, 238, "Input",
 InitializationCell->True],
Cell[290065, 6849, 4245, 115, 208, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[294347, 6969, 103, 1, 18, "Subsubsection"],
Cell[294453, 6972, 5737, 150, 403, "Input",
 InitializationCell->True],
Cell[300193, 7124, 3224, 87, 223, "Input",
 InitializationCell->True]
}, Closed]]
}, Closed]],
Cell[CellGroupData[{
Cell[303466, 7217, 105, 1, 26, "Subsection"],
Cell[CellGroupData[{
Cell[303596, 7222, 210, 3, 24, "Subsubsection"],
Cell[303809, 7227, 4452, 115, 253, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[308298, 7347, 347, 5, 18, "Subsubsection"],
Cell[308648, 7354, 9393, 230, 433, "Input",
 InitializationCell->True],
Cell[318044, 7586, 3160, 52, 43, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[321241, 7643, 120, 1, 18, "Subsubsection"],
Cell[321364, 7646, 21733, 518, 763, "Input",
 InitializationCell->True]
}, Closed]],
Cell[343112, 8167, 100, 1, 18, "Subsubsection"]
}, Open  ]],
Cell[CellGroupData[{
Cell[343249, 8173, 107, 1, 34, "Subsection"],
Cell[343359, 8176, 1669, 46, 43, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[345065, 8227, 184, 2, 34, "Subsection"],
Cell[345252, 8231, 400, 11, 43, "Input",
 InitializationCell->True],
Cell[345655, 8244, 726, 19, 43, "Input",
 InitializationCell->True],
Cell[346384, 8265, 608, 17, 27, "Input",
 InitializationCell->True],
Cell[346995, 8284, 467, 13, 27, "Input",
 InitializationCell->True],
Cell[347465, 8299, 880, 25, 27, "Input",
 InitializationCell->True],
Cell[348348, 8326, 486, 12, 43, "Input",
 InitializationCell->True],
Cell[348837, 8340, 770, 19, 43, "Input",
 InitializationCell->True],
Cell[349610, 8361, 512, 14, 27, "Input",
 InitializationCell->True]
}, Closed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[350171, 8381, 97, 1, 67, "Section"],
Cell[350271, 8384, 8242, 220, 463, "Input",
 Evaluatable->False,
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[358550, 8609, 111, 1, 37, "Section"],
Cell[CellGroupData[{
Cell[358686, 8614, 124, 3, 58, "Input"],
Cell[358813, 8619, 93, 1, 27, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

