(* Content-type: application/mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 7.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       145,          7]
NotebookDataLength[    171564,       4206]
NotebookOptionsPosition[    167615,       4069]
NotebookOutlinePosition[    167980,       4085]
CellTagsIndexPosition[    167937,       4082]
WindowFrame->Normal
ContainsDynamic->False*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["iTEBD algorithm w/long range interaction", "Title",
 CellChangeTimes->{{3.443512958642776*^9, 3.4435129629993067`*^9}, {
  3.449135397414262*^9, 3.44913541713166*^9}, {3.451652690823167*^9, 
  3.451652694018517*^9}, {3.467092666947618*^9, 3.467092667744766*^9}}],

Cell[CellGroupData[{

Cell["General Constants", "Section",
 CellChangeTimes->{{3.4435181566169853`*^9, 3.443518159800116*^9}}],

Cell["These are just definitions of basic constants ", "Text",
 CellChangeTimes->{{3.443331673547653*^9, 3.443331701219919*^9}, 
   3.443439520965644*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"DefaultSpinDimension", "=", "2"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MaxBondDimension", "=", "100"}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.44326940161269*^9, 3.4432694141302633`*^9}, {
   3.443269658649675*^9, 3.443269767770135*^9}, {3.4432699395517483`*^9, 
   3.443269970352769*^9}, {3.443270016967918*^9, 3.4432700752015057`*^9}, 
   3.4432701304751787`*^9, {3.4434394225719357`*^9, 3.4434394251994877`*^9}, 
   3.4435174587080097`*^9, 3.443527312242008*^9, {3.443791575987612*^9, 
   3.443791576270411*^9}, {3.443792066219215*^9, 3.443792066277426*^9}, {
   3.443853174724536*^9, 3.443853174868849*^9}, 3.4438560266279373`*^9, 
   3.4438591884989347`*^9, 3.444020522111377*^9, 3.4440409420943604`*^9, 
   3.444041156100191*^9, 3.44404138396012*^9, 3.444118356879141*^9, {
   3.449171434442206*^9, 3.449171434579524*^9}, {3.4491737268655653`*^9, 
   3.449173742368928*^9}, {3.449174000607956*^9, 3.449174003033008*^9}, {
   3.449174043425432*^9, 3.4491740442644167`*^9}, {3.4491743604300823`*^9, 
   3.4491743605117397`*^9}, 3.44917577131911*^9, {3.449177953900272*^9, 
   3.4491779539633303`*^9}, {3.449178357676675*^9, 3.449178359323513*^9}, {
   3.449178525154139*^9, 3.4491785252165194`*^9}, {3.4492124907573423`*^9, 
   3.449212490830147*^9}, {3.4492242733249083`*^9, 3.4492242742231693`*^9}, {
   3.449254636463402*^9, 3.449254637073791*^9}, {3.449255357727364*^9, 
   3.449255357851218*^9}, {3.449314054503016*^9, 3.4493140589097033`*^9}, {
   3.449463636997964*^9, 3.449463637068089*^9}, {3.449464344147833*^9, 
   3.449464344343712*^9}, {3.4500661949248466`*^9, 3.450066194985968*^9}, {
   3.450068238622999*^9, 3.450068239179392*^9}, {3.450070278076972*^9, 
   3.450070285004595*^9}, {3.451024457389194*^9, 3.451024457447751*^9}, {
   3.451189692813745*^9, 3.451189692997411*^9}, {3.451319896072816*^9, 
   3.451319896178259*^9}, 3.451320748006482*^9, {3.45136266938815*^9, 
   3.4513626695105267`*^9}, 3.451386417018498*^9, 3.45139127412681*^9, {
   3.4516301171193867`*^9, 3.451630117182514*^9}, {3.451652699115774*^9, 
   3.4516526994126453`*^9}, {3.467092754740958*^9, 3.467092759615608*^9}, {
   3.4670930064693203`*^9, 3.4670930135738792`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Manipulation of iTEBD", "Section",
 CellChangeTimes->{{3.443518182302825*^9, 3.44351818749667*^9}, {
   3.450685397981221*^9, 3.450685399578746*^9}, {3.451651747575975*^9, 
   3.4516517510912657`*^9}, 3.4670926858763237`*^9}],

Cell["\<\
Define the initial state of the tensors, typically a product state of all \
spins in state 0..\
\>", "Text",
 CellChangeTimes->{{3.443439530467347*^9, 3.4434395321267843`*^9}, {
  3.443441353935924*^9, 3.443441373450337*^9}}],

Cell[CellGroupData[{

Cell["Initialization", "Subsection",
 CellChangeTimes->{{3.44351826405485*^9, 3.443518268266096*^9}, {
  3.451651755846723*^9, 3.451651757482565*^9}}],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.4493127679477158`*^9, 3.449312771070305*^9}, 
   3.450685442482148*^9, 3.467092687667091*^9, 3.467092950677332*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "ConstructProductiTEBD", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "ConstructProductiTEBD", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"Spin", "->", "DefaultSpinDimension"}], ",", 
     RowBox[{"BondDimension", "->", "20"}], ",", 
     RowBox[{"Type", "->", 
      RowBox[{"{", 
       RowBox[{"\"\<Random\>\"", ",", 
        RowBox[{"{", "}"}]}], "}"}]}]}], "}"}]}], ";", 
  RowBox[{
   RowBox[{"ConstructProductiTEBD", "[", 
    RowBox[{"numTensors_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"\[CapitalGamma]", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{"0", "&"}], ",", 
          RowBox[{"{", "numTensors", "}"}]}], "]"}]}], ",", 
       RowBox[{"\[Lambda]", "=", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{"0", "&"}], ",", 
          RowBox[{"{", "numTensors", "}"}]}], "]"}]}], ",", 
       RowBox[{"tempType", "=", 
        RowBox[{"OptionValue", "[", "Type", "]"}]}], ",", "type", ",", 
       "coeffList", ",", 
       RowBox[{"spin", "=", 
        RowBox[{"OptionValue", "[", "Spin", "]"}]}], ",", 
       RowBox[{"\[Chi]", "=", 
        RowBox[{"OptionValue", "[", "BondDimension", "]"}]}]}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"type", ",", "coeffList"}], "}"}], "=", "tempType"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Switch", "[", 
       RowBox[{"type", ",", "\n", "\"\<Specified\>\"", ",", "\n", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Dimensions", "[", "coeffList", "]"}], "!=", 
           RowBox[{"{", 
            RowBox[{"numTensors", ",", "spin"}], "}"}]}], ",", 
          RowBox[{
           RowBox[{
           "Print", "[", 
            "\"\<TEBDProductState called with wrong list of phases.\>\"", 
            "]"}], ";", 
           RowBox[{"Abort", "[", "]"}]}]}], "]"}], ",", "\n", 
        "\"\<Identity\>\"", ",", "\n", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{"0.0", ",", "1.0"}], "}"}], "~", "Join", "~", 
             RowBox[{"Table", "[", 
              RowBox[{"0.0", ",", 
               RowBox[{"{", 
                RowBox[{"m", ",", "1", ",", 
                 RowBox[{"spin", "-", "2"}]}], "}"}]}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}]}], 
         ";"}], ",", "\[IndentingNewLine]", "\"\<Decaying\>\"", ",", "\n", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Normalize", "[", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{"Exp", "[", 
                RowBox[{
                 RowBox[{"-", "0.5"}], " ", 
                 RowBox[{"Log", "[", "20", "]"}], 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"m", "-", "1"}], ")"}], "/", "spin"}]}], "]"}], 
               ",", 
               RowBox[{"{", 
                RowBox[{"m", ",", "1", ",", "spin"}], "}"}]}], "]"}], "]"}], 
            ",", 
            RowBox[{"{", 
             RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}]}], 
         ";"}], ",", "\n", "\"\<Random\>\"", ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"coeffList", "=", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Normalize", "[", 
             RowBox[{"RandomComplex", "[", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{
                  RowBox[{"-", "1"}], "-", "I"}], ",", 
                 RowBox[{"1", "+", "I"}]}], "}"}], ",", "spin"}], "]"}], 
             "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}]}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"{", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"SparseArray", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"i_", ",", "j_"}], "}"}], "/;", 
                 RowBox[{"(", 
                  RowBox[{"i", "\[Equal]", "j", "\[Equal]", "1"}], ")"}]}], 
                "\[Rule]", 
                RowBox[{"coeffList", "[", 
                 RowBox[{"[", 
                  RowBox[{"k", ",", "n"}], "]"}], "]"}]}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"n", ",", "1", ",", "spin"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"SparseArray", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"{", "i_", "}"}], "/;", 
              RowBox[{"i", "\[LessEqual]", "1"}]}], "\[Rule]", "1.0"}], " ", 
            ",", 
            RowBox[{"{", "\[Chi]", "}"}]}], "]"}]}], "}"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"k", ",", "1", ",", "numTensors"}], "}"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.443439537402534*^9, 3.443439639927244*^9}, {
   3.443439857821541*^9, 3.443439906538312*^9}, {3.4434400403401814`*^9, 
   3.443440079148674*^9}, {3.443440644319996*^9, 3.443440796360334*^9}, {
   3.443440830969428*^9, 3.443440834937833*^9}, 3.4435131760710497`*^9, {
   3.4491356898825693`*^9, 3.44913569391879*^9}, {3.449136854700157*^9, 
   3.4491369145900793`*^9}, {3.449173795914415*^9, 3.449173814460408*^9}, {
   3.4491740621434393`*^9, 3.449174070252202*^9}, {3.449178275376667*^9, 
   3.449178334557598*^9}, {3.4491785474157887`*^9, 3.4491785654408903`*^9}, {
   3.449236359094222*^9, 3.44923636708257*^9}, {3.449236398025247*^9, 
   3.449236404166627*^9}, {3.4492375780764313`*^9, 3.4492376036497583`*^9}, {
   3.449237644219357*^9, 3.449237661453532*^9}, {3.44923769587178*^9, 
   3.449237698909216*^9}, {3.4492379945384197`*^9, 3.449237995052356*^9}, {
   3.449238034231538*^9, 3.449238061045824*^9}, {3.449238218499207*^9, 
   3.449238378800868*^9}, {3.44923844288177*^9, 3.449238477639595*^9}, {
   3.449238544541551*^9, 3.449238595688814*^9}, {3.449238630122113*^9, 
   3.449238668286615*^9}, {3.449305367464713*^9, 3.4493053854013643`*^9}, {
   3.4493054254234343`*^9, 3.449305439647161*^9}, {3.44931273666776*^9, 
   3.449312756582868*^9}, {3.450030743177949*^9, 3.450030778802433*^9}, {
   3.450030810782054*^9, 3.4500309284330873`*^9}, {3.450065783029697*^9, 
   3.450065811431054*^9}, {3.450067413418728*^9, 3.45006745687751*^9}, {
   3.450685428372428*^9, 3.450685607968252*^9}, {3.451024004825375*^9, 
   3.4510242874559383`*^9}, {3.451024323295775*^9, 3.451024323456128*^9}, {
   3.4510243618010187`*^9, 3.4510243783362303`*^9}, {3.451189919160843*^9, 
   3.451189922672126*^9}, {3.451305269177762*^9, 3.451305273713153*^9}, {
   3.451305314419791*^9, 3.451305382356247*^9}, {3.451305509306275*^9, 
   3.451305529423973*^9}, {3.4513055864738417`*^9, 3.4513056414551992`*^9}, 
   3.451305703880803*^9, {3.451305857288804*^9, 3.451305884397359*^9}, {
   3.451305980350638*^9, 3.451305986632861*^9}, {3.4516686396473207`*^9, 
   3.4516686457285337`*^9}, 3.4670926886409388`*^9, {3.467092952289914*^9, 
   3.467092953259117*^9}, {3.4670929968129587`*^9, 3.467093000615815*^9}, {
   3.467093041426052*^9, 3.4670930495072536`*^9}, {3.467093086097773*^9, 
   3.4670931753738527`*^9}, {3.4671011866991663`*^9, 3.467101200524783*^9}, {
   3.4671014619435368`*^9, 3.467101566071454*^9}, {3.467101626569606*^9, 
   3.467101829909521*^9}, {3.467101919867951*^9, 3.4671019214659567`*^9}, {
   3.4671019532713737`*^9, 3.467101975752968*^9}, {3.467102048965217*^9, 
   3.467102055294055*^9}, {3.467102089961206*^9, 3.467102146226348*^9}, {
   3.467109502552329*^9, 3.467109503007831*^9}, {3.467109649376165*^9, 
   3.467109660000292*^9}, {3.4684121549766893`*^9, 3.468412268252777*^9}, {
   3.46841302488409*^9, 3.468413052912332*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Expansion of bond dimension", "Subsection",
 CellChangeTimes->{{3.4516517619073668`*^9, 3.451651766595477*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"iTEBDExpandBond", "[", 
   RowBox[{"TEBD_", ",", "new\[Chi]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Print", "[", 
      RowBox[{"\"\<Grow \[Chi] to \>\"", "<>", 
       RowBox[{"ToString", "[", "new\[Chi]", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"PadRight", "[", 
            RowBox[{"#", ",", 
             RowBox[{"{", 
              RowBox[{"new\[Chi]", ",", "new\[Chi]"}], "}"}]}], "]"}], "&"}], 
          "/@", 
          RowBox[{"TEBD", "[", 
           RowBox[{"[", 
            RowBox[{"M", ",", "1"}], "]"}], "]"}]}], ",", 
         RowBox[{"PadRight", "[", 
          RowBox[{
           RowBox[{"TEBD", "[", 
            RowBox[{"[", 
             RowBox[{"M", ",", "2"}], "]"}], "]"}], ",", "new\[Chi]"}], 
          "]"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"M", ",", "1", ",", 
         RowBox[{"Length", "[", "TEBD", "]"}]}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.467114162791239*^9, 3.467114262253087*^9}, {
  3.467114313292901*^9, 3.467114399035953*^9}, {3.467114459159977*^9, 
  3.4671144659409113`*^9}, {3.4671147525729637`*^9, 3.46711476206586*^9}, {
  3.467115359241096*^9, 3.467115432248981*^9}, {3.467531769337514*^9, 
  3.467531772403961*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Canonical forms", "Subsection",
 CellChangeTimes->{{3.456479374571746*^9, 3.456479380807178*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBDSave", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBDSave", "[", 
   RowBox[{"iTEBD_", ",", "filename_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"numSites", ",", "spin", ",", "\[Chi]"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numSites", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Export", "[", 
      RowBox[{
       RowBox[{"filename", "<>", "\"\<.info\>\""}], ",", 
       RowBox[{"{", 
        RowBox[{"numSites", ",", "spin", ",", "\[Chi]"}], "}"}], ",", 
       "\"\<Table\>\""}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Export", "[", 
           RowBox[{
            RowBox[{"filename", "<>", "\"\<.G.\>\"", "<>", 
             RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
             RowBox[{"ToString", "[", "s", "]"}], "<>", "\"\<.dat\>\""}], ",",
             
            RowBox[{"iTEBD", "[", 
             RowBox[{"[", 
              RowBox[{"n", ",", "1", ",", "s"}], "]"}], "]"}], ",", 
            "\"\<Table\>\""}], "]"}], "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Export", "[", 
         RowBox[{
          RowBox[{"filename", "<>", "\"\<.L.\>\"", "<>", 
           RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.dat\>\""}], ",", 
          RowBox[{"iTEBD", "[", 
           RowBox[{"[", 
            RowBox[{"n", ",", "2"}], "]"}], "]"}], ",", "\"\<Table\>\""}], 
         "]"}], ";"}], "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", "numSites"}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465272381315712*^9, 3.465272466935622*^9}, {
  3.465274872039486*^9, 3.465275077441268*^9}, {3.46527516315172*^9, 
  3.4652751816887493`*^9}, {3.4652753073560953`*^9, 3.465275331904854*^9}, {
  3.465275685829495*^9, 3.465275757088855*^9}, {3.468437373340576*^9, 
  3.4684373911993933`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"iTEBDRead", "[", "filename_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "iTEBD", ",", "numSites", ",", "spin", ",", "\[Chi]", ",", "info"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"info", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{"Import", "[", 
        RowBox[{
         RowBox[{"filename", "<>", "\"\<.info\>\""}], ",", "\"\<Table\>\""}], 
        "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"numSites", ",", "spin", ",", "\[Chi]"}], "}"}], "=", "info"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"ConstructProductiTEBD", "[", 
       RowBox[{"numSites", ",", 
        RowBox[{"Spin", "\[Rule]", "spin"}], ",", 
        RowBox[{"BondDimension", "\[Rule]", "\[Chi]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"iTEBD", "[", 
          RowBox[{"[", 
           RowBox[{"n", ",", "1"}], "]"}], "]"}], "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Import", "[", 
             RowBox[{
              RowBox[{"filename", "<>", "\"\<.G.\>\"", "<>", 
               RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.\>\"", "<>", 
               RowBox[{"ToString", "[", "s", "]"}], "<>", "\"\<.dat\>\""}], 
              ",", "\"\<Table\>\""}], "]"}], "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"s", ",", "1", ",", "spin"}], "}"}]}], "]"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"iTEBD", "[", 
          RowBox[{"[", 
           RowBox[{"n", ",", "2"}], "]"}], "]"}], "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"Import", "[", 
            RowBox[{
             RowBox[{"filename", "<>", "\"\<.L.\>\"", "<>", 
              RowBox[{"ToString", "[", "n", "]"}], "<>", "\"\<.dat\>\""}], 
             ",", "\"\<Table\>\""}], "]"}], "]"}], "]"}]}], ";"}], 
       "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"n", ",", "1", ",", "numSites"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "iTEBD"}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.465272381315712*^9, 3.465272466935622*^9}, {
   3.465274872039486*^9, 3.465275077441268*^9}, {3.46527516315172*^9, 
   3.4652751816887493`*^9}, {3.4652753073560953`*^9, 3.465275331904854*^9}, {
   3.465275367081286*^9, 3.465275465554977*^9}, {3.465275606648999*^9, 
   3.465275625558902*^9}, 3.465275692829726*^9, {3.465275812721534*^9, 
   3.465275817605616*^9}, {3.465275893836484*^9, 3.4652759156339073`*^9}, {
   3.4652759744600067`*^9, 3.465275992702661*^9}, {3.465276042057399*^9, 
   3.465276066453537*^9}, {3.465276127582642*^9, 3.465276134162496*^9}, {
   3.4652762037779922`*^9, 3.4652762076892776`*^9}, {3.468437392947875*^9, 
   3.4684374018832207`*^9}, {3.468437441813343*^9, 3.4684374860230494`*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Gates", "Section",
 CellChangeTimes->{{3.443518196286511*^9, 3.443518196824862*^9}, {
  3.444729782940466*^9, 3.444729784560087*^9}}],

Cell[CellGroupData[{

Cell["Two qubit gate", "Subsection",
 CellChangeTimes->{{3.4435182492827873`*^9, 3.443518253209672*^9}, 
   3.444044995664118*^9, 3.4499491762779818`*^9}],

Cell["\<\
This implements a unitary two qubit gate between nearest neighbors, step by \
step as in Vidal\.b4s PRL\
\>", "Text",
 CellChangeTimes->{{3.4433591816981697`*^9, 3.4433592043209963`*^9}, {
  3.443781468051005*^9, 3.4437814928506613`*^9}, {3.44913590075126*^9, 
  3.449135905219448*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBD2QGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD2QGate", "[", 
   RowBox[{"iTEBD_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "spin", ",", "\[Chi]", ",", "Hint", ",", "\[Lambda]LD", ",", 
      "\[Lambda]CD", ",", "\[Lambda]RD", ",", "\[CapitalSigma]", ",", "X", 
      ",", "YT", ",", "\[Lambda]temp", ",", "\[Lambda]RDi", ",", 
      "\[Lambda]LDi", ",", "norm", ",", "numTensors"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", "   ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"step", "=", "0.1"}], ",", "\[Lambda]L", ",", "\[Lambda]C", 
        ",", "\[Lambda]R"}], "]"}], ";", " ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"spin", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Hint", "=", 
      RowBox[{"(", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", "H"}], ")"}], 
       ")"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{
         RowBox[{"step", "=", "1.5"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"Dimensions", "[", "#", "]"}], "&"}], "/@", 
          RowBox[{"{", 
           RowBox[{"\[Lambda]LD", ",", "\[Lambda]CD", ",", "\[Lambda]RD"}], 
           "}"}]}]}], "]"}], ";", "  ", 
       RowBox[{
        RowBox[{"Steps", " ", 
         RowBox[{"(", "i", ")"}], " ", "and", " ", 
         RowBox[{"(", "iii", ")"}]}], ":", " ", 
        RowBox[{"compute", " ", "theta", " ", "tensors"}]}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]CD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "4", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3"}], "}"}]}], "}"}]}], "]"}], ".", "Hint"}],
         ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "2"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "8"}], "]"}], ";", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "viii", ")"}]}], ":", " ", 
        RowBox[{
        "Compute", " ", "SVD", " ", "of", " ", "\[CapitalSigma]"}]}]}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]CD", "^", "2"}], "]"}]}], ";", "\[IndentingNewLine]",
      
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]CD", "/", 
       RowBox[{"Sqrt", "[", "norm", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "9"}], "]"}], ";", " ", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "ix", ")"}]}], ":", " ", 
        RowBox[{
        "Reformat", " ", "P", " ", "and", " ", "Q", " ", "to", " ", "the", 
         " ", "new", " ", "Gammas", " ", "and", " ", "truncate", " ", "to", 
         " ", "\[Chi]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"1", "-", "norm"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",\

 InitializationCell->True,
 CellChangeTimes->{{3.443359214968994*^9, 3.44335940640832*^9}, {
   3.4433594365521812`*^9, 3.4433594526198673`*^9}, {3.443359639971109*^9, 
   3.443359654429758*^9}, {3.4434419723038263`*^9, 3.44344208062729*^9}, {
   3.443442118177108*^9, 3.44344232908633*^9}, {3.443442421471139*^9, 
   3.4434428630623083`*^9}, {3.4434470199400263`*^9, 
   3.4434470254556313`*^9}, {3.443510172660636*^9, 3.443510180222643*^9}, {
   3.443510244992063*^9, 3.4435102869332523`*^9}, {3.443510317448319*^9, 
   3.4435103257487507`*^9}, {3.443510360644993*^9, 3.443510747127743*^9}, {
   3.443510785457789*^9, 3.4435108122098093`*^9}, {3.4435108609689207`*^9, 
   3.443510966823202*^9}, {3.4435110080512114`*^9, 3.443511058761353*^9}, 
   3.443511148010591*^9, {3.443511540700561*^9, 3.443511563345602*^9}, {
   3.443511597072886*^9, 3.443511597738432*^9}, 3.443511648402638*^9, {
   3.4435119385942087`*^9, 3.4435120628499403`*^9}, {3.4435121656389008`*^9, 
   3.443512467962412*^9}, {3.4435126349195127`*^9, 3.443512780239728*^9}, {
   3.443512830719163*^9, 3.443512837762377*^9}, {3.443513013899762*^9, 
   3.4435130256595993`*^9}, {3.443513684983494*^9, 3.4435136895071*^9}, {
   3.443513765075243*^9, 3.443513768454974*^9}, {3.443513849880643*^9, 
   3.443513853051955*^9}, {3.443513946018778*^9, 3.4435139666254797`*^9}, {
   3.443516806125209*^9, 3.443516832165584*^9}, {3.443516869594656*^9, 
   3.4435168940555277`*^9}, {3.443516993513563*^9, 3.443517021425654*^9}, {
   3.443517536257066*^9, 3.4435175506812077`*^9}, {3.443517714046372*^9, 
   3.4435177881238003`*^9}, {3.4435178182612543`*^9, 
   3.4435181253146257`*^9}, {3.4435273405404387`*^9, 3.443527382663971*^9}, {
   3.443528278145529*^9, 3.443528281264477*^9}, {3.4435290028092012`*^9, 
   3.4435290177649307`*^9}, {3.443529054272295*^9, 3.4435290626084547`*^9}, {
   3.4435292028793917`*^9, 3.443529309613722*^9}, {3.443529354865958*^9, 
   3.4435293650828753`*^9}, {3.443602104671269*^9, 3.443602151593223*^9}, {
   3.4436022086604156`*^9, 3.443602209014091*^9}, {3.4436022601060762`*^9, 
   3.443602271978656*^9}, {3.44360231653098*^9, 3.443602384186523*^9}, {
   3.443602573361184*^9, 3.4436025782002277`*^9}, {3.443780435165977*^9, 
   3.443780435912643*^9}, {3.443780557537169*^9, 3.4437805581875153`*^9}, {
   3.443781398666946*^9, 3.4437814021658373`*^9}, {3.443781497077993*^9, 
   3.443781506849025*^9}, {3.443790818430187*^9, 3.4437909285357113`*^9}, {
   3.443790967002638*^9, 3.443791001621365*^9}, {3.443791120654482*^9, 
   3.443791143867103*^9}, {3.443791175707457*^9, 3.443791225739861*^9}, {
   3.4437912679533443`*^9, 3.443791283837797*^9}, {3.443791739843855*^9, 
   3.443791747857483*^9}, {3.443791794870331*^9, 3.443791797984334*^9}, {
   3.443852864961628*^9, 3.443852873950439*^9}, {3.4438529875552483`*^9, 
   3.443852996047879*^9}, {3.449135969709622*^9, 3.449135969819179*^9}, {
   3.449137318631754*^9, 3.4491373525300293`*^9}, {3.449137450686569*^9, 
   3.449137472003034*^9}, {3.44914051622239*^9, 3.449140590322256*^9}, {
   3.449140626422885*^9, 3.449140696157218*^9}, {3.449140821145731*^9, 
   3.4491409702379913`*^9}, {3.44914222530058*^9, 3.4491423164738827`*^9}, {
   3.4491423533102903`*^9, 3.4491425329994707`*^9}, {3.44914256934028*^9, 
   3.449142592036716*^9}, {3.449142824125408*^9, 3.449142846005625*^9}, 
   3.449171308249566*^9, {3.4491721366101017`*^9, 3.449172144061658*^9}, {
   3.449173415024889*^9, 3.4491734274714327`*^9}, {3.44917346986064*^9, 
   3.4491734781865597`*^9}, {3.4491735394851837`*^9, 3.449173565777207*^9}, {
   3.449173702526167*^9, 3.4491737101866617`*^9}, {3.4491746718992987`*^9, 
   3.4491746767002277`*^9}, {3.449174791588271*^9, 3.449174798744239*^9}, {
   3.449176543578514*^9, 3.4491765439412394`*^9}, {3.451137903147464*^9, 
   3.4511379143466463`*^9}, {3.451137972480033*^9, 3.451137995253192*^9}, {
   3.4511380253829317`*^9, 3.451138044750457*^9}, {3.451138111610551*^9, 
   3.451138253881445*^9}, {3.4511382886149797`*^9, 3.4511384115398397`*^9}, {
   3.451138646788807*^9, 3.45113864701968*^9}, {3.45165180384595*^9, 
   3.451651805048472*^9}, {3.451651856466001*^9, 3.4516518601126957`*^9}, {
   3.451652399037507*^9, 3.451652451046364*^9}, {3.4516525766273937`*^9, 
   3.451652618443089*^9}, {3.451673133953622*^9, 3.451673170182315*^9}, {
   3.4578708714715033`*^9, 3.457870882500148*^9}, {3.4670926901700993`*^9, 
   3.467092700057056*^9}, {3.467093228451277*^9, 3.467093228696884*^9}, {
   3.4670932628091373`*^9, 3.4670932740885487`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Auxiliary MPO routines", "Subsection",
 CellChangeTimes->{{3.456811434281746*^9, 3.456811439611232*^9}}],

Cell[CellGroupData[{

Cell["iMPO acting on an iTEBD site", "Subsubsection",
 CellChangeTimes->{{3.456574605242443*^9, 3.45657461174839*^9}, 
   3.467092702834157*^9, {3.475057507067215*^9, 3.4750575085306673`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBDMPO", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBDMPO", "[", 
   RowBox[{"iTEBD_", ",", "iMPO_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "temp", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"Flatten", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Transpose", "[", 
        RowBox[{"iTEBD", ",", 
         RowBox[{"{", 
          RowBox[{"3", ",", "1", ",", "2"}], "}"}]}], "]"}], ".", "iMPO"}], 
      ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", "3", "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"1", ",", "4"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"2", ",", "5"}], "}"}]}], "}"}]}], "]"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.456574618653243*^9, 3.456574668333158*^9}, {
  3.456574720350429*^9, 3.456574796352249*^9}, {3.467092703637128*^9, 
  3.467092710855094*^9}, {3.475057490902495*^9, 3.475057520296574*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Difference of two tensors", "Subsubsection",
 CellChangeTimes->{{3.4568114643756313`*^9, 3.4568114692754803`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"difference", "[", 
    RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{"Sqrt", "[", 
     RowBox[{"Total", "[", 
      RowBox[{
       RowBox[{"Abs", "[", 
        RowBox[{
         RowBox[{"Flatten", "[", "A", "]"}], "-", 
         RowBox[{"Flatten", "[", "B", "]"}]}], "]"}], "^", "2"}], "]"}], 
     "]"}], ")"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.456811473735449*^9, 3.4568114745855837`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Normalized Theta tensor applied to the right and left of a matrix\
\>", "Subsubsection",
 CellChangeTimes->{{3.456811477181714*^9, 3.456811500747528*^9}, {
  3.456811534220441*^9, 3.456811556108045*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"apply", ",", "HoldAll"}], "]"}], ";", 
  RowBox[{
   RowBox[{"apply", "[", 
    RowBox[{"A_", ",", "v_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"r", ",", "temp"}], "}"}], ",", 
     RowBox[{
      RowBox[{"temp", "=", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"A", "[", 
           RowBox[{"[", "i", "]"}], "]"}], ".", "v", ".", 
          RowBox[{"ConjugateTranspose", "[", 
           RowBox[{"A", "[", 
            RowBox[{"[", "i", "]"}], "]"}], "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", 
           RowBox[{"Length", "[", "A", "]"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"temp", "/", 
       RowBox[{"Sqrt", "[", 
        RowBox[{"Total", "[", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"Abs", "[", "temp", "]"}], "^", "2"}], "]"}], "]"}], 
        "]"}]}]}]}], "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.45681152074445*^9, 3.45681152348066*^9}, {
  3.4568122984135323`*^9, 3.45681230230254*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Find maximum eigenvector", "Subsubsection",
 CellChangeTimes->{{3.456811688212508*^9, 3.45681169319641*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MaxEigenvector", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MaxEigenvector", "[", 
   RowBox[{"theta_", ",", 
    RowBox[{"precision_:", 
     RowBox[{"10", "^", 
      RowBox[{"(", 
       RowBox[{"-", "9"}], ")"}]}]}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"vector", ",", 
      RowBox[{"MaxIterations", "=", "20"}]}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"vector", "=", 
      RowBox[{"Array", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"RandomComplex", "[", "]"}], "&"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Length", "[", 
           RowBox[{"theta", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}], ",", 
          RowBox[{"Length", "[", 
           RowBox[{"theta", "[", 
            RowBox[{"[", "1", "]"}], "]"}], "]"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"NestWhile", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"apply", "[", 
         RowBox[{"theta", ",", "#"}], "]"}], "&"}], ",", "vector", ",", 
       RowBox[{
        RowBox[{
         RowBox[{"difference", "[", 
          RowBox[{"#1", ",", "#2"}], "]"}], ">", "precision"}], "&"}], ",", 
       "2", ",", "MaxIterations"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.45681170791896*^9, 3.456811784317945*^9}, {
  3.4568118510991917`*^9, 3.456811918012385*^9}, {3.4568123111272697`*^9, 
  3.4568123153464193`*^9}, {3.456816482649955*^9, 3.456816500837569*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Two qubit iMPO", "Subsection",
 CellChangeTimes->{{3.4435182492827873`*^9, 3.443518253209672*^9}, 
   3.444044995664118*^9, 3.4499491762779818`*^9, {3.456573868244413*^9, 
   3.456573874387505*^9}}],

Cell["\<\
This implements a non-unitary iMPO acting on an iTEBD, step by step as in \
Orus and Vidal PR.\
\>", "Text",
 CellChangeTimes->{{3.4433591816981697`*^9, 3.4433592043209963`*^9}, {
   3.443781468051005*^9, 3.4437814928506613`*^9}, {3.44913590075126*^9, 
   3.449135905219448*^9}, {3.45681128017479*^9, 3.456811322971779*^9}, 
   3.467092715961728*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBD2QMPO", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD2QMPO", "[", 
   RowBox[{"iTEBD_", ",", "iMPO_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Chi]", ",", "\[Chi]D", ",", "\[Lambda]LD", ",", "\[Lambda]CD", ",", 
      "\[Lambda]RD", ",", "\[CapitalSigma]", ",", "X", ",", "YT", ",", "v", 
      ",", "W", ",", "Xi", ",", "YTi", ",", "U", ",", "VD", ",", "V", ",", 
      "\[Lambda]temp", ",", "\[Lambda]RDi", ",", "\[Lambda]LDi", ",", 
      "\[Theta]", ",", "VR", ",", "VL", ",", "norm", ",", "numTensors", ",", 
      "mps", ",", "error"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", "   ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"step", "=", "0.1"}], ",", "\[Lambda]L", ",", "\[Lambda]C", 
        ",", "\[Lambda]R"}], "]"}], ";", " ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Chi]D", "=", 
      RowBox[{"Last", "[", 
       RowBox[{"Dimensions", "[", "iMPO", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Create", " ", "a", " ", "larger", " ", "iTEBD", " ", "including", " ", 
       "the", " ", "iMPO"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"mps", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"iTEBDMPO", "[", 
         RowBox[{
          RowBox[{"iTEBD", "[", 
           RowBox[{"[", 
            RowBox[{"n", ",", "1"}], "]"}], "]"}], ",", 
          RowBox[{"iMPO", "[", 
           RowBox[{"[", "n", "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"n", ",", "1", ",", "numTensors"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"KroneckerProduct", "[", 
       RowBox[{
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"iTEBD", "[", 
          RowBox[{"[", 
           RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], ",", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"IdentityMatrix", "[", "\[Chi]D", "]"}], "]"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{"KroneckerProduct", "[", 
       RowBox[{
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"iTEBD", "[", 
          RowBox[{"[", 
           RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], ",", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"IdentityMatrix", "[", "\[Chi]D", "]"}], "]"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"KroneckerProduct", "[", 
       RowBox[{
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"iTEBD", "[", 
          RowBox[{"[", 
           RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], ",", 
        RowBox[{"SparseArray", "[", 
         RowBox[{"IdentityMatrix", "[", "\[Chi]D", "]"}], "]"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "Construct", " ", "\[Theta]", " ", "matrix", " ", "leaving", " ", 
        "spin", " ", "indices", " ", "in", " ", "the", " ", "middle", " ", 
        "\[Alpha]"}], ",", "i", ",", "j", ",", "\[Beta]"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"\[Theta]", "=", 
      RowBox[{
       RowBox[{"Transpose", "[", 
        RowBox[{
         RowBox[{"mps", "[", 
          RowBox[{"[", "1", "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
       "\[Lambda]CD", ".", 
       RowBox[{"Transpose", "[", 
        RowBox[{
         RowBox[{"mps", "[", 
          RowBox[{"[", "2", "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Find", " ", "left", " ", "and", " ", "right", " ", "eigenvectors", " ",
        "of", " ", "\[Theta]"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"VR", "=", 
      RowBox[{"MaxEigenvector", "[", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"\[Theta]", ".", "\[Lambda]RD"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"2", ",", "3"}], "}"}], ",", 
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"{", "4", "}"}]}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"VL", "=", 
      RowBox[{"MaxEigenvector", "[", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"\[Lambda]LD", ".", "\[Theta]"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"2", ",", "3"}], "}"}], ",", 
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"{", "4", "}"}]}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Now", " ", "find", " ", "decomposition", " ", "of", " ", "VR", " ", 
       "and", " ", "VL", " ", "in", " ", "positive", " ", "matrices"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"v", ",", "W"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", "VR", "]"}]}], ";", " ", 
     RowBox[{"(*", "   ", 
      RowBox[{"VR", "=", 
       RowBox[{
        RowBox[{
         SuperscriptBox["XX", "\[Dagger]"], " ", "Notice", " ", "that", " ", 
         "VR"}], "=", 
        RowBox[{
         RowBox[{"WT", ".", "D", ".", 
          RowBox[{"W", "^"}]}], "*", " ", "in", " ", "Mathematica"}]}]}], " ",
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{"X", "=", 
      RowBox[{
       RowBox[{"Transpose", "[", "W", "]"}], ".", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"Sqrt", "[", "v", "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"v", ",", "W"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", "VL", "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"VL", "=", 
       RowBox[{
        SuperscriptBox["Y", "\[Dagger]"], "Y"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"YT", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"Sqrt", "[", "v", "]"}], "]"}], ".", 
        RowBox[{"Conjugate", "[", "W", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "6"}], "]"}], ";", " ", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "vi", ")"}]}], ":", " ", 
        RowBox[{"Compute", " ", "SVD", " ", "of", " ", 
         RowBox[{"YT", ".", "\[Lambda]R", ".", "X"}]}]}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"Xi", "=", 
      RowBox[{"PseudoInverse", "[", 
       RowBox[{"Normal", "[", 
        RowBox[{"Chop", "[", "X", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"YTi", "=", 
      RowBox[{"PseudoInverse", "[", 
       RowBox[{"Normal", "[", 
        RowBox[{"Chop", "[", "YT", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"U", ",", "\[Lambda]RDi", ",", "VD"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", 
       RowBox[{"YT", ".", "\[Lambda]RD", ".", "X"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"V", "=", 
      RowBox[{"ConjugateTranspose", "[", "VD", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "and", " ", "normalize", " ", "the", " ", "new", " ", 
       "\[Lambda]"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{
       RowBox[{"Diagonal", "[", "\[Lambda]RDi", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"norm", "=", 
      RowBox[{"Sqrt", "[", 
       RowBox[{"Total", "[", 
        RowBox[{"\[Lambda]RDi", "^", "2"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", 
      RowBox[{"1", "-", "norm"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]RDi", "/", "norm"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", "\[Lambda]RD"}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"(*", " ", 
      RowBox[{
      "Prepare", " ", "and", " ", "truncate", " ", "auxiliary", " ", 
       "matrices", " ", "to", " ", "make", " ", "\[CapitalSigma]", " ", 
       "simpler"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"X", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"V", ".", "Xi"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"1", ";;", "\[Chi]"}], ",", "All"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"YT", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"YTi", ".", "U"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{"1", ";;", "\[Chi]"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "Construct", " ", "the", " ", "\[CapitalSigma]", " ", "matrix", " ", 
        "for", " ", "final", " ", "decomposition", " ", "with", " ", 
        "indices", " ", 
        RowBox[{"(", "i\[Alpha]", ")"}]}], ",", 
       RowBox[{"(", "j\[Beta]", ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
        "\[Lambda]LD", ".", "V", ".", "Xi", ".", "\[Theta]", ".", "YTi", ".", 
         "U", ".", "\[Lambda]RD"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "8"}], "]"}], ";", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "viii", ")"}]}], ":", " ", 
        RowBox[{
        "Compute", " ", "SVD", " ", "of", " ", "\[CapitalSigma]"}]}]}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]CD", "^", "2"}], "]"}]}], ";", "\[IndentingNewLine]",
      
     RowBox[{"error", "+=", 
      RowBox[{"1", "-", "norm"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]CD", "/", 
       RowBox[{"Sqrt", "[", "norm", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "9"}], "]"}], ";", " ", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "ix", ")"}]}], ":", " ", 
        RowBox[{
        "Reformat", " ", "X", " ", "and", " ", "YT", " ", "to", " ", "the", 
         " ", "new", " ", "Gammas", " ", "and", " ", "truncate", " ", "to", 
         " ", "\[Chi]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.443359214968994*^9, 3.44335940640832*^9}, {
   3.4433594365521812`*^9, 3.4433594526198673`*^9}, {3.443359639971109*^9, 
   3.443359654429758*^9}, {3.4434419723038263`*^9, 3.44344208062729*^9}, {
   3.443442118177108*^9, 3.44344232908633*^9}, {3.443442421471139*^9, 
   3.4434428630623083`*^9}, {3.4434470199400263`*^9, 
   3.4434470254556313`*^9}, {3.443510172660636*^9, 3.443510180222643*^9}, {
   3.443510244992063*^9, 3.4435102869332523`*^9}, {3.443510317448319*^9, 
   3.4435103257487507`*^9}, {3.443510360644993*^9, 3.443510747127743*^9}, {
   3.443510785457789*^9, 3.4435108122098093`*^9}, {3.4435108609689207`*^9, 
   3.443510966823202*^9}, {3.4435110080512114`*^9, 3.443511058761353*^9}, 
   3.443511148010591*^9, {3.443511540700561*^9, 3.443511563345602*^9}, {
   3.443511597072886*^9, 3.443511597738432*^9}, 3.443511648402638*^9, {
   3.4435119385942087`*^9, 3.4435120628499403`*^9}, {3.4435121656389008`*^9, 
   3.443512467962412*^9}, {3.4435126349195127`*^9, 3.443512780239728*^9}, {
   3.443512830719163*^9, 3.443512837762377*^9}, {3.443513013899762*^9, 
   3.4435130256595993`*^9}, {3.443513684983494*^9, 3.4435136895071*^9}, {
   3.443513765075243*^9, 3.443513768454974*^9}, {3.443513849880643*^9, 
   3.443513853051955*^9}, {3.443513946018778*^9, 3.4435139666254797`*^9}, {
   3.443516806125209*^9, 3.443516832165584*^9}, {3.443516869594656*^9, 
   3.4435168940555277`*^9}, {3.443516993513563*^9, 3.443517021425654*^9}, {
   3.443517536257066*^9, 3.4435175506812077`*^9}, {3.443517714046372*^9, 
   3.4435177881238003`*^9}, {3.4435178182612543`*^9, 
   3.4435181253146257`*^9}, {3.4435273405404387`*^9, 3.443527382663971*^9}, {
   3.443528278145529*^9, 3.443528281264477*^9}, {3.4435290028092012`*^9, 
   3.4435290177649307`*^9}, {3.443529054272295*^9, 3.4435290626084547`*^9}, {
   3.4435292028793917`*^9, 3.443529309613722*^9}, {3.443529354865958*^9, 
   3.4435293650828753`*^9}, {3.443602104671269*^9, 3.443602151593223*^9}, {
   3.4436022086604156`*^9, 3.443602209014091*^9}, {3.4436022601060762`*^9, 
   3.443602271978656*^9}, {3.44360231653098*^9, 3.443602384186523*^9}, {
   3.443602573361184*^9, 3.4436025782002277`*^9}, {3.443780435165977*^9, 
   3.443780435912643*^9}, {3.443780557537169*^9, 3.4437805581875153`*^9}, {
   3.443781398666946*^9, 3.4437814021658373`*^9}, {3.443781497077993*^9, 
   3.443781506849025*^9}, {3.443790818430187*^9, 3.4437909285357113`*^9}, {
   3.443790967002638*^9, 3.443791001621365*^9}, {3.443791120654482*^9, 
   3.443791143867103*^9}, {3.443791175707457*^9, 3.443791225739861*^9}, {
   3.4437912679533443`*^9, 3.443791283837797*^9}, {3.443791739843855*^9, 
   3.443791747857483*^9}, {3.443791794870331*^9, 3.443791797984334*^9}, {
   3.443852864961628*^9, 3.443852873950439*^9}, {3.4438529875552483`*^9, 
   3.443852996047879*^9}, {3.449135969709622*^9, 3.449135969819179*^9}, {
   3.449137318631754*^9, 3.4491373525300293`*^9}, {3.449137450686569*^9, 
   3.449137472003034*^9}, {3.44914051622239*^9, 3.449140590322256*^9}, {
   3.449140626422885*^9, 3.449140696157218*^9}, {3.449140821145731*^9, 
   3.4491409702379913`*^9}, {3.44914222530058*^9, 3.4491423164738827`*^9}, {
   3.4491423533102903`*^9, 3.4491425329994707`*^9}, {3.44914256934028*^9, 
   3.449142592036716*^9}, {3.449142824125408*^9, 3.449142846005625*^9}, 
   3.449171308249566*^9, {3.4491721366101017`*^9, 3.449172144061658*^9}, {
   3.449173415024889*^9, 3.4491734274714327`*^9}, {3.44917346986064*^9, 
   3.4491734781865597`*^9}, {3.4491735394851837`*^9, 3.449173565777207*^9}, {
   3.449173702526167*^9, 3.4491737101866617`*^9}, {3.4491746718992987`*^9, 
   3.4491746767002277`*^9}, {3.449174791588271*^9, 3.449174798744239*^9}, {
   3.449176543578514*^9, 3.4491765439412394`*^9}, {3.451137903147464*^9, 
   3.4511379143466463`*^9}, {3.451137972480033*^9, 3.451137995253192*^9}, {
   3.4511380253829317`*^9, 3.451138044750457*^9}, {3.451138111610551*^9, 
   3.451138253881445*^9}, {3.4511382886149797`*^9, 3.4511384115398397`*^9}, {
   3.451138646788807*^9, 3.45113864701968*^9}, {3.45165180384595*^9, 
   3.451651805048472*^9}, {3.451651856466001*^9, 3.4516518601126957`*^9}, {
   3.451652399037507*^9, 3.451652451046364*^9}, {3.4516525766273937`*^9, 
   3.451652618443089*^9}, {3.451673133953622*^9, 3.451673170182315*^9}, {
   3.4565738834815598`*^9, 3.4565739145502157`*^9}, {3.45657430451362*^9, 
   3.456574345318912*^9}, {3.456574444335568*^9, 3.456574527853307*^9}, {
   3.4565745958784857`*^9, 3.4565745989169283`*^9}, {3.4565748098030863`*^9, 
   3.4565749100749407`*^9}, {3.456574964559164*^9, 3.456574978638047*^9}, {
   3.4565750261225653`*^9, 3.4565750272748833`*^9}, {3.45657507076254*^9, 
   3.456575115676785*^9}, {3.45657532457963*^9, 3.45657534674181*^9}, {
   3.456728444043377*^9, 3.456728518921955*^9}, {3.456729113975614*^9, 
   3.45672916445583*^9}, 3.45681140907332*^9, {3.456811445218069*^9, 
   3.4568114525227137`*^9}, {3.4568116018944397`*^9, 3.45681160470056*^9}, {
   3.456812158595428*^9, 3.456812209484874*^9}, {3.45681226749226*^9, 
   3.456812269855884*^9}, {3.456812386822874*^9, 3.456812593231276*^9}, {
   3.4568127132494802`*^9, 3.456812805555073*^9}, {3.456813278145286*^9, 
   3.4568134556541*^9}, {3.4568134997145653`*^9, 3.4568136441018953`*^9}, {
   3.4568136903814*^9, 3.4568136908976316`*^9}, {3.456813769504179*^9, 
   3.456813769666379*^9}, {3.456813872604292*^9, 3.456813892934598*^9}, {
   3.456813930086494*^9, 3.456813977170389*^9}, {3.456814017879858*^9, 
   3.456814027970552*^9}, {3.4568157190705643`*^9, 3.456815794833571*^9}, {
   3.456815856299663*^9, 3.456815889835216*^9}, {3.456816425587837*^9, 
   3.456816459520413*^9}, {3.456833492781608*^9, 3.4568335323062057`*^9}, {
   3.457870891876728*^9, 3.457870915087741*^9}, {3.467092717625257*^9, 
   3.467092721352572*^9}, 3.4750575430355253`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Two qubit non Unitary gate", "Subsection",
 CellChangeTimes->{{3.4435182492827873`*^9, 3.443518253209672*^9}, 
   3.444044995664118*^9, 3.4499491762779818`*^9, {3.456573868244413*^9, 
   3.456573874387505*^9}, {3.456833118419713*^9, 3.45683312300994*^9}}],

Cell["\<\
This implements a non-unitary evolution operator acting on an iTEBD, step by \
step as in Orus and Vidal PR.\
\>", "Text",
 CellChangeTimes->{{3.4433591816981697`*^9, 3.4433592043209963`*^9}, {
   3.443781468051005*^9, 3.4437814928506613`*^9}, {3.44913590075126*^9, 
   3.449135905219448*^9}, {3.45681128017479*^9, 3.456811322971779*^9}, {
   3.456833130503031*^9, 3.456833135411392*^9}, 3.4670927213584337`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBD2QNUGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD2QNuGate", "[", 
   RowBox[{"iTEBD_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "\[Chi]", ",", "\[Lambda]LD", ",", "Hint", ",", "\[Lambda]CD", ",", 
      "\[Lambda]RD", ",", "\[CapitalSigma]", ",", "X", ",", "YT", ",", "v", 
      ",", "W", ",", "Xi", ",", "YTi", ",", "U", ",", "VD", ",", "V", ",", 
      "\[Lambda]temp", ",", "\[Lambda]RDi", ",", "\[Lambda]LDi", ",", 
      "\[Theta]", ",", "VR", ",", "VL", ",", "norm", ",", "numTensors", ",", 
      "mps", ",", "error"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", "   ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{
        RowBox[{"step", "=", "0.1"}], ",", "\[Lambda]L", ",", "\[Lambda]C", 
        ",", "\[Lambda]R"}], "]"}], ";", " ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"Hint", "=", 
      RowBox[{"(", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", "2"}], "]"}], "&"}], "/@", "H"}], ")"}], ")"}]}],
      ";", "\[IndentingNewLine]", 
     RowBox[{"\[Chi]", "=", 
      RowBox[{"Length", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Create", " ", "a", " ", "larger", " ", "iTEBD", " ", "including", " ", 
       "the", " ", "iMPO"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "Construct", " ", "\[Theta]", " ", "matrix", " ", "leaving", " ", 
        "spin", " ", "indices", " ", "in", " ", "the", " ", "middle", " ", 
        "\[Alpha]"}], ",", "i", ",", "j", ",", "\[Beta]"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"\[Theta]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]CD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "4", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3"}], "}"}]}], "}"}]}], "]"}], ".", "Hint"}],
         ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", "1", "}"}], ",", 
          RowBox[{"{", "3", "}"}], ",", 
          RowBox[{"{", "4", "}"}], ",", 
          RowBox[{"{", "2", "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Find", " ", "left", " ", "and", " ", "right", " ", "eigenvectors", " ",
        "of", " ", "\[Theta]"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"VR", "=", 
      RowBox[{"MaxEigenvector", "[", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"\[Theta]", ".", "\[Lambda]RD"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"2", ",", "3"}], "}"}], ",", 
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"{", "4", "}"}]}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"VL", "=", 
      RowBox[{"MaxEigenvector", "[", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{"\[Lambda]LD", ".", "\[Theta]"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"2", ",", "3"}], "}"}], ",", 
           RowBox[{"{", "1", "}"}], ",", 
           RowBox[{"{", "4", "}"}]}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Now", " ", "find", " ", "decomposition", " ", "of", " ", "VR", " ", 
       "and", " ", "VL", " ", "in", " ", "positive", " ", "matrices"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"v", ",", "W"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", "VR", "]"}]}], ";", " ", 
     RowBox[{"(*", "   ", 
      RowBox[{"VR", "=", 
       RowBox[{
        RowBox[{
         SuperscriptBox["XX", "\[Dagger]"], " ", "Notice", " ", "that", " ", 
         "VR"}], "=", 
        RowBox[{
         RowBox[{"WT", ".", "D", ".", 
          RowBox[{"W", "^"}]}], "*", " ", "in", " ", "Mathematica"}]}]}], " ",
       "*)"}], "\[IndentingNewLine]", 
     RowBox[{"X", "=", 
      RowBox[{
       RowBox[{"Transpose", "[", "W", "]"}], ".", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"Sqrt", "[", "v", "]"}], "]"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"v", ",", "W"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", "VL", "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"VL", "=", 
       RowBox[{
        SuperscriptBox["Y", "\[Dagger]"], "Y"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"YT", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{
        RowBox[{"DiagonalMatrix", "[", 
         RowBox[{"Sqrt", "[", "v", "]"}], "]"}], ".", 
        RowBox[{"Conjugate", "[", "W", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "6"}], "]"}], ";", " ", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "vi", ")"}]}], ":", " ", 
        RowBox[{"Compute", " ", "SVD", " ", "of", " ", 
         RowBox[{"YT", ".", "\[Lambda]R", ".", "X"}]}]}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"Xi", "=", 
      RowBox[{"PseudoInverse", "[", 
       RowBox[{"Normal", "[", 
        RowBox[{"Chop", "[", "X", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"YTi", "=", 
      RowBox[{"PseudoInverse", "[", 
       RowBox[{"Normal", "[", 
        RowBox[{"Chop", "[", "YT", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"U", ",", "\[Lambda]RDi", ",", "VD"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", 
       RowBox[{"YT", ".", "\[Lambda]RD", ".", "X"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"V", "=", 
      RowBox[{"ConjugateTranspose", "[", "VD", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "and", " ", "normalize", " ", "the", " ", "new", " ", 
       "\[Lambda]"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{
       RowBox[{"Diagonal", "[", "\[Lambda]RDi", "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"norm", "=", 
      RowBox[{"Sqrt", "[", 
       RowBox[{"Total", "[", 
        RowBox[{"\[Lambda]RDi", "^", "2"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "=", 
      RowBox[{"1", "-", "norm"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]RDi", "/", "norm"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", "\[Lambda]RD"}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"(*", " ", 
      RowBox[{
      "Prepare", " ", "and", " ", "truncate", " ", "auxiliary", " ", 
       "matrices", " ", "to", " ", "make", " ", "\[CapitalSigma]", " ", 
       "simpler"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"X", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"V", ".", "Xi"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"1", ";;", "\[Chi]"}], ",", "All"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"YT", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"YTi", ".", "U"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", 
         RowBox[{"1", ";;", "\[Chi]"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "Construct", " ", "the", " ", "\[CapitalSigma]", " ", "matrix", " ", 
        "for", " ", "final", " ", "decomposition", " ", "with", " ", 
        "indices", " ", 
        RowBox[{"(", "i\[Alpha]", ")"}]}], ",", 
       RowBox[{"(", "j\[Beta]", ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
        "\[Lambda]LD", ".", "V", ".", "Xi", ".", "\[Theta]", ".", "YTi", ".", 
         "U", ".", "\[Lambda]RD"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "8"}], "]"}], ";", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "viii", ")"}]}], ":", " ", 
        RowBox[{
        "Compute", " ", "SVD", " ", "of", " ", "\[CapitalSigma]"}]}]}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]CD", "^", "2"}], "]"}]}], ";", "\[IndentingNewLine]",
      
     RowBox[{"error", "+=", 
      RowBox[{"1", "-", "norm"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]CD", "/", 
       RowBox[{"Sqrt", "[", "norm", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"step", "=", "9"}], "]"}], ";", " ", 
       RowBox[{
        RowBox[{"Step", " ", 
         RowBox[{"(", "ix", ")"}]}], ":", " ", 
        RowBox[{
        "Reformat", " ", "X", " ", "and", " ", "YT", " ", "to", " ", "the", 
         " ", "new", " ", "Gammas", " ", "and", " ", "truncate", " ", "to", 
         " ", "\[Chi]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.443359214968994*^9, 3.44335940640832*^9}, {
   3.4433594365521812`*^9, 3.4433594526198673`*^9}, {3.443359639971109*^9, 
   3.443359654429758*^9}, {3.4434419723038263`*^9, 3.44344208062729*^9}, {
   3.443442118177108*^9, 3.44344232908633*^9}, {3.443442421471139*^9, 
   3.4434428630623083`*^9}, {3.4434470199400263`*^9, 
   3.4434470254556313`*^9}, {3.443510172660636*^9, 3.443510180222643*^9}, {
   3.443510244992063*^9, 3.4435102869332523`*^9}, {3.443510317448319*^9, 
   3.4435103257487507`*^9}, {3.443510360644993*^9, 3.443510747127743*^9}, {
   3.443510785457789*^9, 3.4435108122098093`*^9}, {3.4435108609689207`*^9, 
   3.443510966823202*^9}, {3.4435110080512114`*^9, 3.443511058761353*^9}, 
   3.443511148010591*^9, {3.443511540700561*^9, 3.443511563345602*^9}, {
   3.443511597072886*^9, 3.443511597738432*^9}, 3.443511648402638*^9, {
   3.4435119385942087`*^9, 3.4435120628499403`*^9}, {3.4435121656389008`*^9, 
   3.443512467962412*^9}, {3.4435126349195127`*^9, 3.443512780239728*^9}, {
   3.443512830719163*^9, 3.443512837762377*^9}, {3.443513013899762*^9, 
   3.4435130256595993`*^9}, {3.443513684983494*^9, 3.4435136895071*^9}, {
   3.443513765075243*^9, 3.443513768454974*^9}, {3.443513849880643*^9, 
   3.443513853051955*^9}, {3.443513946018778*^9, 3.4435139666254797`*^9}, {
   3.443516806125209*^9, 3.443516832165584*^9}, {3.443516869594656*^9, 
   3.4435168940555277`*^9}, {3.443516993513563*^9, 3.443517021425654*^9}, {
   3.443517536257066*^9, 3.4435175506812077`*^9}, {3.443517714046372*^9, 
   3.4435177881238003`*^9}, {3.4435178182612543`*^9, 
   3.4435181253146257`*^9}, {3.4435273405404387`*^9, 3.443527382663971*^9}, {
   3.443528278145529*^9, 3.443528281264477*^9}, {3.4435290028092012`*^9, 
   3.4435290177649307`*^9}, {3.443529054272295*^9, 3.4435290626084547`*^9}, {
   3.4435292028793917`*^9, 3.443529309613722*^9}, {3.443529354865958*^9, 
   3.4435293650828753`*^9}, {3.443602104671269*^9, 3.443602151593223*^9}, {
   3.4436022086604156`*^9, 3.443602209014091*^9}, {3.4436022601060762`*^9, 
   3.443602271978656*^9}, {3.44360231653098*^9, 3.443602384186523*^9}, {
   3.443602573361184*^9, 3.4436025782002277`*^9}, {3.443780435165977*^9, 
   3.443780435912643*^9}, {3.443780557537169*^9, 3.4437805581875153`*^9}, {
   3.443781398666946*^9, 3.4437814021658373`*^9}, {3.443781497077993*^9, 
   3.443781506849025*^9}, {3.443790818430187*^9, 3.4437909285357113`*^9}, {
   3.443790967002638*^9, 3.443791001621365*^9}, {3.443791120654482*^9, 
   3.443791143867103*^9}, {3.443791175707457*^9, 3.443791225739861*^9}, {
   3.4437912679533443`*^9, 3.443791283837797*^9}, {3.443791739843855*^9, 
   3.443791747857483*^9}, {3.443791794870331*^9, 3.443791797984334*^9}, {
   3.443852864961628*^9, 3.443852873950439*^9}, {3.4438529875552483`*^9, 
   3.443852996047879*^9}, {3.449135969709622*^9, 3.449135969819179*^9}, {
   3.449137318631754*^9, 3.4491373525300293`*^9}, {3.449137450686569*^9, 
   3.449137472003034*^9}, {3.44914051622239*^9, 3.449140590322256*^9}, {
   3.449140626422885*^9, 3.449140696157218*^9}, {3.449140821145731*^9, 
   3.4491409702379913`*^9}, {3.44914222530058*^9, 3.4491423164738827`*^9}, {
   3.4491423533102903`*^9, 3.4491425329994707`*^9}, {3.44914256934028*^9, 
   3.449142592036716*^9}, {3.449142824125408*^9, 3.449142846005625*^9}, 
   3.449171308249566*^9, {3.4491721366101017`*^9, 3.449172144061658*^9}, {
   3.449173415024889*^9, 3.4491734274714327`*^9}, {3.44917346986064*^9, 
   3.4491734781865597`*^9}, {3.4491735394851837`*^9, 3.449173565777207*^9}, {
   3.449173702526167*^9, 3.4491737101866617`*^9}, {3.4491746718992987`*^9, 
   3.4491746767002277`*^9}, {3.449174791588271*^9, 3.449174798744239*^9}, {
   3.449176543578514*^9, 3.4491765439412394`*^9}, {3.451137903147464*^9, 
   3.4511379143466463`*^9}, {3.451137972480033*^9, 3.451137995253192*^9}, {
   3.4511380253829317`*^9, 3.451138044750457*^9}, {3.451138111610551*^9, 
   3.451138253881445*^9}, {3.4511382886149797`*^9, 3.4511384115398397`*^9}, {
   3.451138646788807*^9, 3.45113864701968*^9}, {3.45165180384595*^9, 
   3.451651805048472*^9}, {3.451651856466001*^9, 3.4516518601126957`*^9}, {
   3.451652399037507*^9, 3.451652451046364*^9}, {3.4516525766273937`*^9, 
   3.451652618443089*^9}, {3.451673133953622*^9, 3.451673170182315*^9}, {
   3.4565738834815598`*^9, 3.4565739145502157`*^9}, {3.45657430451362*^9, 
   3.456574345318912*^9}, {3.456574444335568*^9, 3.456574527853307*^9}, {
   3.4565745958784857`*^9, 3.4565745989169283`*^9}, {3.4565748098030863`*^9, 
   3.4565749100749407`*^9}, {3.456574964559164*^9, 3.456574978638047*^9}, {
   3.4565750261225653`*^9, 3.4565750272748833`*^9}, {3.45657507076254*^9, 
   3.456575115676785*^9}, {3.45657532457963*^9, 3.45657534674181*^9}, {
   3.456728444043377*^9, 3.456728518921955*^9}, {3.456729113975614*^9, 
   3.45672916445583*^9}, 3.45681140907332*^9, {3.456811445218069*^9, 
   3.4568114525227137`*^9}, {3.4568116018944397`*^9, 3.45681160470056*^9}, {
   3.456812158595428*^9, 3.456812209484874*^9}, {3.45681226749226*^9, 
   3.456812269855884*^9}, {3.456812386822874*^9, 3.456812593231276*^9}, {
   3.4568127132494802`*^9, 3.456812805555073*^9}, {3.456813278145286*^9, 
   3.4568134556541*^9}, {3.4568134997145653`*^9, 3.4568136441018953`*^9}, {
   3.4568136903814*^9, 3.4568136908976316`*^9}, {3.456813769504179*^9, 
   3.456813769666379*^9}, {3.456813872604292*^9, 3.456813892934598*^9}, {
   3.456813930086494*^9, 3.456813977170389*^9}, {3.456814017879858*^9, 
   3.456814027970552*^9}, {3.4568157190705643`*^9, 3.456815794833571*^9}, {
   3.456815856299663*^9, 3.456815889835216*^9}, {3.456816425587837*^9, 
   3.456816459520413*^9}, {3.45683314164502*^9, 3.456833204682516*^9}, {
   3.4568332454767017`*^9, 3.456833266860573*^9}, {3.456833303151537*^9, 
   3.456833326820796*^9}, {3.456833361999462*^9, 3.4568333732406673`*^9}, 
   3.4568335799757223`*^9, {3.4578709194599133`*^9, 3.457870933026353*^9}, {
   3.467092721399303*^9, 3.467092721533618*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Three qubit gate", "Subsection",
 CellChangeTimes->{{3.4499491863933563`*^9, 3.4499492085530376`*^9}, {
  3.451651842730686*^9, 3.451651846468635*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBD3QGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD3QGate", "[", 
   RowBox[{"iTEBD_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "spin", ",", "\[Chi]", ",", "\[Lambda]LD", ",", "\[Lambda]1D", ",", 
      "\[Lambda]2D", ",", "\[Lambda]RD", ",", "\[CapitalSigma]", ",", "X", 
      ",", "YT", ",", "\[Lambda]temp", ",", "\[Lambda]RDi", ",", 
      "\[Lambda]LDi", ",", "\[Lambda]1Di", ",", "norm1", ",", "norm2", ",", 
      "numTensors", ",", "Hint"}], "}"}], ",", "\[IndentingNewLine]", " ", 
    RowBox[{"(*", "  ", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{"step", "=", "0"}], "]"}], ";", "  ", 
      RowBox[{"Preliminary", ":", " ", 
       RowBox[{
       "prepare", " ", "matrices", " ", "for", " ", "fast", " ", 
        "products"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spin", ",", "\[Chi]"}], "}"}], "=", 
      RowBox[{
       RowBox[{"Dimensions", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"Hint", "=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", "H"}], ")"}]}], 
       ")"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"3", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"3", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"First", " ", "make", " ", "3", " ", "spin", " ", "matrix"}], 
      "  ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]1D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]2D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"3", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "5", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3", ",", "4"}], "}"}]}], "}"}]}], "]"}], ".",
          "Hint"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "5", ",", "2"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{
       "Perform", " ", "SVD", " ", "of", " ", "the", " ", "three", " ", 
        "spin", " ", "matrix", " ", "as", " ", "1"}], "-", 
       RowBox[{"2", " ", "spins"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm1", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm1", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "the", " ", "tensors", " ", "of", " ", "the", " ", 
       "left", " ", "spin"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
        "Now", " ", "rearrange", " ", "right", " ", "matrix", " ", "to", " ", 
         "represent", " ", "2", " ", "spins", " ", "as", " ", "1"}], "-", 
        "1"}], ",", " ", 
       RowBox[{
       "multiplying", " ", "before", " ", "by", " ", "the", " ", "new", " ", 
        "\[Lambda]1"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]1D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", "spin"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "1", ",", "4"}], "}"}]}], "]"}]}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm2", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm2", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]1D", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]1Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "right", " ", "tensor", " ", "needs", " ", "the", " ", 
       "inverse", " ", "right", " ", "lambda", " ", "to", " ", "fit"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"3", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"2", "-", "norm1", "-", "norm2"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4491431494991198`*^9, 3.4491431527666407`*^9}, {
   3.449143212112667*^9, 3.449143275839323*^9}, {3.449164546719405*^9, 
   3.449164580972435*^9}, {3.44916461938943*^9, 3.449164668995058*^9}, {
   3.449164729946808*^9, 3.449164739042309*^9}, {3.449164806146693*^9, 
   3.449164820317066*^9}, {3.44917087363531*^9, 3.4491709587544107`*^9}, {
   3.4491709908520203`*^9, 3.4491710043715*^9}, {3.44917103780374*^9, 
   3.449171228495027*^9}, {3.4491712664888153`*^9, 3.449171402561606*^9}, {
   3.449172157031952*^9, 3.449172172217957*^9}, {3.449173376733779*^9, 
   3.449173378616562*^9}, {3.449173716807646*^9, 3.4491737189759283`*^9}, 
   3.44917407645816*^9, 3.4491741880710793`*^9, {3.449177521399815*^9, 
   3.449177525050384*^9}, {3.449177601982314*^9, 3.449177609138399*^9}, {
   3.4493049683917313`*^9, 3.449304984210821*^9}, {3.4493114972087708`*^9, 
   3.449311522015972*^9}, {3.449311700910709*^9, 3.449311760331352*^9}, {
   3.449311800279505*^9, 3.449311863765473*^9}, {3.4493123239076633`*^9, 
   3.4493123490134*^9}, {3.4493124660798693`*^9, 3.449312476077244*^9}, {
   3.449312683242168*^9, 3.4493126866431313`*^9}, {3.451138438534898*^9, 
   3.4511386371075478`*^9}, {3.451138691108492*^9, 3.4511387017622013`*^9}, {
   3.451138744349331*^9, 3.451138849530814*^9}, {3.451648065242742*^9, 
   3.4516481943890257`*^9}, {3.451649082144508*^9, 3.451649133545834*^9}, {
   3.451649184097962*^9, 3.451649249188191*^9}, {3.451649294054953*^9, 
   3.451649332433181*^9}, {3.451651705873355*^9, 3.451651707216448*^9}, {
   3.451651866726055*^9, 3.45165187047049*^9}, {3.4516523933006907`*^9, 
   3.451652393838626*^9}, {3.4516524570336113`*^9, 3.451652504088724*^9}, {
   3.451652768799387*^9, 3.451652775759944*^9}, {3.4578709385440893`*^9, 
   3.4578709553076773`*^9}, {3.4670927215539703`*^9, 
   3.4670927216863194`*^9}, {3.467093310204369*^9, 3.467093313903653*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Three qubit iMPO", "Subsection",
 CellChangeTimes->{{3.4499491863933563`*^9, 3.4499492085530376`*^9}, {
  3.451651842730686*^9, 3.451651846468635*^9}, {3.4567289915297527`*^9, 
  3.456728992263379*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBD3QMPO", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD3QMPO", "[", 
   RowBox[{"iTEBD_", ",", "iMPO_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "spin", ",", "\[Chi]", ",", "\[Lambda]LD", ",", "\[Lambda]1D", ",", 
      "\[Lambda]2D", ",", "\[Lambda]RD", ",", "\[CapitalSigma]", ",", "X", 
      ",", "YT", ",", "\[Lambda]temp", ",", "\[Lambda]RDi", ",", 
      "\[Lambda]LDi", ",", "\[Lambda]1Di", ",", "norm1", ",", "norm2", ",", 
      "numTensors", ",", "Hint"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spin", ",", "\[Chi]"}], "}"}], "=", 
      RowBox[{
       RowBox[{"Dimensions", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"\[Chi]D", "=", 
      RowBox[{"Last", "[", 
       RowBox[{"Dimensions", "[", "iMPO", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Create", " ", "a", " ", "larger", " ", "iTEBD", " ", "including", " ", 
       "the", " ", "iMPO"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"mps", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"MPOTEBD", "[", 
         RowBox[{
          RowBox[{"iTEBD", "[", 
           RowBox[{"[", "n", "]"}], "]"}], ",", 
          RowBox[{"iMPO", "[", 
           RowBox[{"[", "n", "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"n", ",", "1", ",", "numTensors"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"iTEBD", "[", 
           RowBox[{"[", 
            RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Chi]", " ", "\[Chi]D"}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]CD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"iTEBD", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Chi]", " ", "\[Chi]D"}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PadRight", "[", 
        RowBox[{
         RowBox[{"DiagonalMatrix", "[", 
          RowBox[{"iTEBD", "[", 
           RowBox[{"[", 
            RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"\[Chi]", " ", "\[Chi]D"}], "}"}]}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Hint", "=", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{
         RowBox[{"Partition", "[", 
          RowBox[{"#", ",", "2"}], "]"}], "&"}], "/@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"#", ",", "2"}], "]"}], "&"}], "/@", "H"}], ")"}]}], 
       ")"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"3", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"3", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"First", " ", "make", " ", "3", " ", "spin", " ", "matrix"}], 
      "  ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]1D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]2D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"3", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "5", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3", ",", "4"}], "}"}]}], "}"}]}], "]"}], ".",
          "Hint"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "5", ",", "2"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{
       "Perform", " ", "SVD", " ", "of", " ", "the", " ", "three", " ", 
        "spin", " ", "matrix", " ", "as", " ", "1"}], "-", 
       RowBox[{"2", " ", "spins"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm1", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm1", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"DiagonalMatrix", "[", 
       RowBox[{"iTEBD", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "the", " ", "tensors", " ", "of", " ", "the", " ", 
       "left", " ", "spin"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
        RowBox[{
        "Now", " ", "rearrange", " ", "right", " ", "matrix", " ", "to", " ", 
         "represent", " ", "2", " ", "spins", " ", "as", " ", "1"}], "-", 
        "1"}], ",", " ", 
       RowBox[{
       "multiplying", " ", "before", " ", "by", " ", "the", " ", "new", " ", 
        "\[Lambda]1"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]1D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", "spin"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "1", ",", "4"}], "}"}]}], "]"}]}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm2", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"\[Lambda]temp", "/", 
        RowBox[{"Sqrt", "[", "norm2", "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]1D", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]1Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "right", " ", "tensor", " ", "needs", " ", "the", " ", 
       "inverse", " ", "right", " ", "lambda", " ", "to", " ", "fit"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"3", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"2", "-", "norm1", "-", "norm2"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4491431494991198`*^9, 3.4491431527666407`*^9}, {
   3.449143212112667*^9, 3.449143275839323*^9}, {3.449164546719405*^9, 
   3.449164580972435*^9}, {3.44916461938943*^9, 3.449164668995058*^9}, {
   3.449164729946808*^9, 3.449164739042309*^9}, {3.449164806146693*^9, 
   3.449164820317066*^9}, {3.44917087363531*^9, 3.4491709587544107`*^9}, {
   3.4491709908520203`*^9, 3.4491710043715*^9}, {3.44917103780374*^9, 
   3.449171228495027*^9}, {3.4491712664888153`*^9, 3.449171402561606*^9}, {
   3.449172157031952*^9, 3.449172172217957*^9}, {3.449173376733779*^9, 
   3.449173378616562*^9}, {3.449173716807646*^9, 3.4491737189759283`*^9}, 
   3.44917407645816*^9, 3.4491741880710793`*^9, {3.449177521399815*^9, 
   3.449177525050384*^9}, {3.449177601982314*^9, 3.449177609138399*^9}, {
   3.4493049683917313`*^9, 3.449304984210821*^9}, {3.4493114972087708`*^9, 
   3.449311522015972*^9}, {3.449311700910709*^9, 3.449311760331352*^9}, {
   3.449311800279505*^9, 3.449311863765473*^9}, {3.4493123239076633`*^9, 
   3.4493123490134*^9}, {3.4493124660798693`*^9, 3.449312476077244*^9}, {
   3.449312683242168*^9, 3.4493126866431313`*^9}, {3.451138438534898*^9, 
   3.4511386371075478`*^9}, {3.451138691108492*^9, 3.4511387017622013`*^9}, {
   3.451138744349331*^9, 3.451138849530814*^9}, {3.451648065242742*^9, 
   3.4516481943890257`*^9}, {3.451649082144508*^9, 3.451649133545834*^9}, {
   3.451649184097962*^9, 3.451649249188191*^9}, {3.451649294054953*^9, 
   3.451649332433181*^9}, {3.451651705873355*^9, 3.451651707216448*^9}, {
   3.451651866726055*^9, 3.45165187047049*^9}, {3.4516523933006907`*^9, 
   3.451652393838626*^9}, {3.4516524570336113`*^9, 3.451652504088724*^9}, {
   3.451652768799387*^9, 3.451652775759944*^9}, {3.456729035792018*^9, 
   3.4567290962710342`*^9}, {3.457870960774219*^9, 3.457870980117269*^9}, {
   3.467092721709042*^9, 3.467092721915676*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Four qubit Gate", "Subsection",
 CellChangeTimes->{{3.4499491863933563`*^9, 3.4499492085530376`*^9}, {
  3.4499496075039377`*^9, 3.449949614690414*^9}, {3.451651876458849*^9, 
  3.451651879205132*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBD4QGate", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD4QGate", "[", 
   RowBox[{"iTEBD_", ",", "H_"}], "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "spin", ",", "\[Chi]", ",", "\[Lambda]LD", ",", "\[Lambda]1D", ",", 
      "\[Lambda]2D", ",", "\[Lambda]3D", ",", "\[Lambda]RD", ",", 
      "\[CapitalSigma]", ",", "X", ",", "YT", ",", "\[Lambda]temp", ",", 
      "\[Lambda]RDi", ",", "\[Lambda]LDi", ",", "\[Lambda]1Di", ",", 
      "\[Lambda]2Di", ",", "norm1", ",", "norm2", ",", "norm3", ",", "Hint"}],
      "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"{", 
       RowBox[{"spin", ",", "\[Chi]"}], "}"}], "=", 
      RowBox[{
       RowBox[{"Dimensions", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "2"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"Hint", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Partition", "[", 
         RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{
          RowBox[{"Partition", "[", 
           RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{"#", ",", "spin"}], "]"}], "&"}], "/@", "H"}], ")"}]}], 
        ")"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"4", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]3D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"3", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RD", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"4", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "First", " ", "make", " ", "4", " ", "spin", " ", "matrix", "  ", 
        "\[Alpha]ijkl\[Beta]", " ", "HilIL"}], "=", 
       RowBox[{
        RowBox[{"\[Alpha]jk\[Beta]il", " ", "HilIL"}], "=", 
        "\[Alpha]jk\[Beta]IL"}]}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"\[Lambda]LD", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]1D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]2D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"3", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]3D", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{"4", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            "\[Lambda]RD"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", "1", "}"}], ",", 
             RowBox[{"{", "6", "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "3", ",", "4", ",", "5"}], "}"}]}], "}"}]}], 
          "]"}], ".", "Hint"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"3", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"4", ",", "5", ",", "6", ",", "2"}], "}"}]}], "}"}]}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", "  ", 
      RowBox[{
       RowBox[{
       "Perform", " ", "SVD", " ", "of", " ", "the", " ", "three", " ", 
        "spin", " ", "matrix", " ", "as", " ", "1"}], "-", 
       RowBox[{"2", " ", "spins"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm1", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]temp", "/", 
       RowBox[{"Sqrt", "[", "norm1", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Extract", " ", "the", " ", "tensors", " ", "of", " ", "the", " ", 
       "left", " ", "spin"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]LDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]LD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]LDi", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "Now", " ", "rearrange", " ", "right", " ", "matrix", " ", "to", " ", 
        "represent", " ", "3", " ", "spins"}], ",", " ", 
       RowBox[{
       "multiplying", " ", "before", " ", "by", " ", "the", " ", "new", " ", 
        "\[Lambda]1"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]1D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{
              RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"\[Chi]", ",", 
                RowBox[{
                 RowBox[{"SpinDimension", "^", "2"}], " ", "\[Chi]"}]}], 
               "}"}]}], "]"}], "[", 
            RowBox[{"[", 
             RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", "3", "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm2", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]temp", "/", 
       RowBox[{"Sqrt", "[", "norm2", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2D", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]1Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]1D", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]1Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Final", " ", "decomposition"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"\[CapitalSigma]", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"\[Lambda]2D", ".", 
         RowBox[{"Transpose", "[", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Partition", "[", 
               RowBox[{
                RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
              RowBox[{"[", 
               RowBox[{"1", ",", "All"}], "]"}], "]"}], ",", 
             "SpinDimension"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"2", ",", "3", ",", "1", ",", "4"}], "}"}]}], "]"}]}], 
        ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"2", ",", "1"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"3", ",", "4"}], "}"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "And", " ", "get", " ", "the", " ", "SVD", " ", "as", " ", "a", " ", 
       "normal", " ", "case"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"X", ",", "\[Lambda]temp", ",", "YT"}], "}"}], "=", 
      RowBox[{"SingularValueDecomposition", "[", "\[CapitalSigma]", "]"}]}], 
     ";", " ", "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]temp", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Diagonal", "[", "\[Lambda]temp", "]"}], ")"}], "[", 
       RowBox[{"[", 
        RowBox[{"1", ";;", "\[Chi]"}], "]"}], "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Truncated", " ", "values"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"norm3", "=", 
      RowBox[{"Total", "[", 
       RowBox[{"\[Lambda]temp", "^", "2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"3", ",", "2"}], "]"}], "]"}], "=", 
      RowBox[{"\[Lambda]temp", "/", 
       RowBox[{"Sqrt", "[", "norm3", "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "center", " ", "tensor", " ", "we", " ", "obtain", " ", 
       "taking", " ", "out", " ", "\[Lambda]1"}], " ", "*)"}], " ", 
     "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]2Di", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]2D", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"3", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"\[Lambda]2Di", ".", "#"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"X", ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "1"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "The", " ", "right", " ", "tensor", " ", "needs", " ", "the", " ", 
       "inverse", " ", "right", " ", "lambda", " ", "to", " ", "fit"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"\[Lambda]RDi", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"PseudoInverse", "[", 
        RowBox[{"Normal", "[", "\[Lambda]RD", "]"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"iTEBD", "[", 
       RowBox[{"[", 
        RowBox[{"4", ",", "1"}], "]"}], "]"}], "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"Chop", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"#", ".", "\[Lambda]RDi"}], "&"}], ")"}], "/@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{
             RowBox[{"ConjugateTranspose", "[", "YT", "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"\[Chi]", ",", "\[Chi]"}], "}"}]}], "]"}], "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "All"}], "]"}], "]"}], ")"}]}], "]"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"3", "-", "norm1", "-", "norm2", "-", "norm3"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4491431494991198`*^9, 3.4491431527666407`*^9}, {
   3.449143212112667*^9, 3.449143275839323*^9}, {3.449164546719405*^9, 
   3.449164580972435*^9}, {3.44916461938943*^9, 3.449164668995058*^9}, {
   3.449164729946808*^9, 3.449164739042309*^9}, {3.449164806146693*^9, 
   3.449164820317066*^9}, {3.44917087363531*^9, 3.4491709587544107`*^9}, {
   3.4491709908520203`*^9, 3.4491710043715*^9}, {3.44917103780374*^9, 
   3.449171228495027*^9}, {3.4491712664888153`*^9, 3.449171402561606*^9}, {
   3.449172157031952*^9, 3.449172172217957*^9}, {3.449173376733779*^9, 
   3.449173378616562*^9}, {3.449173716807646*^9, 3.4491737189759283`*^9}, 
   3.44917407645816*^9, 3.4491741880710793`*^9, {3.449177521399815*^9, 
   3.449177525050384*^9}, {3.449177601982314*^9, 3.449177609138399*^9}, {
   3.4493049683917313`*^9, 3.449304984210821*^9}, {3.4493114972087708`*^9, 
   3.449311522015972*^9}, {3.449311700910709*^9, 3.449311760331352*^9}, {
   3.449311800279505*^9, 3.449311863765473*^9}, {3.4493123239076633`*^9, 
   3.4493123490134*^9}, {3.4493124660798693`*^9, 3.449312476077244*^9}, {
   3.449312683242168*^9, 3.4493126866431313`*^9}, {3.44994961964924*^9, 
   3.44994976756621*^9}, {3.4499498084028177`*^9, 3.44994981091599*^9}, {
   3.4499498451973877`*^9, 3.449949851862445*^9}, {3.449949903035152*^9, 
   3.449949946475707*^9}, {3.44994998948744*^9, 3.4499500257070303`*^9}, {
   3.449950059319805*^9, 3.449950121117448*^9}, 3.449950786423176*^9, {
   3.449951232894981*^9, 3.449951292466333*^9}, {3.449951330978504*^9, 
   3.4499514818199253`*^9}, {3.4500717966466017`*^9, 3.450071796904984*^9}, {
   3.450071830877224*^9, 3.450071847687511*^9}, {3.450071930571629*^9, 
   3.450071937662971*^9}, {3.4502027928548326`*^9, 3.4502028235594788`*^9}, {
   3.4502032469622107`*^9, 3.450203315383472*^9}, {3.45113889417951*^9, 
   3.451139009140963*^9}, {3.4516518287116623`*^9, 3.4516518312845488`*^9}, {
   3.4516518827833776`*^9, 3.451651886558598*^9}, 3.4516523831306963`*^9, {
   3.451652556871183*^9, 3.451652563957781*^9}, {3.451652782138345*^9, 
   3.45165285148764*^9}, {3.451652885554762*^9, 3.451652981476429*^9}, {
   3.4516530189594107`*^9, 3.4516531701336718`*^9}, {3.4564811998868437`*^9, 
   3.4564812275218678`*^9}, {3.4578709850332203`*^9, 3.457871006103302*^9}, {
   3.4670927219417133`*^9, 3.467092722154592*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Single qubit gate", "Subsection",
 CellChangeTimes->{{3.449949223884014*^9, 3.4499492284435167`*^9}}],

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"iTEBD1QGate", ",", "HoldFirst"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBD1QGate", "[", 
   RowBox[{"iTEBD_", ",", "H_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "error", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"iTEBD", "=", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{"H", ".", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"#", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "}"}], "&"}], ")"}], "/@", 
       "iTEBD"}]}], ";", "\[IndentingNewLine]", "0"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->{{3.45165191555215*^9, 3.451651971115922*^9}, {
  3.451653276404819*^9, 3.451653281633542*^9}, {3.451653488934196*^9, 
  3.451653495796842*^9}, {3.451668975049211*^9, 3.4516689857526207`*^9}, {
  3.4670927221646013`*^9, 3.467092722196026*^9}}]
}, Closed]],

Cell[CellGroupData[{

Cell["Wrappers", "Subsection",
 CellChangeTimes->{{3.449949254320237*^9, 3.4499492572930527`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBDEvolution", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBDEvolution", "[", 
   RowBox[{"Hams_", ",", "iTEBD_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "error", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "Hams", "]"}], "\[NotEqual]", 
         RowBox[{"Length", "[", "iTEBD", "]"}]}], ",", 
        RowBox[{"Return", "[", 
         RowBox[{"-", "999"}], "]"}]}], "]"}], ";"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{"Switch", "[", 
     RowBox[{
      RowBox[{"Length", "[", "iTEBD", "]"}], ",", "\[IndentingNewLine]", "2", 
      ",", 
      RowBox[{"Evolution2Sites", "[", 
       RowBox[{"Hams", ",", "iTEBD"}], "]"}], ",", "\[IndentingNewLine]", "3",
       ",", 
      RowBox[{"Evolution3Sites", "[", 
       RowBox[{"Hams", ",", "iTEBD"}], "]"}], ",", "\[IndentingNewLine]", "4",
       ",", 
      RowBox[{"Evolution4Sites", "[", 
       RowBox[{"Hams", ",", "iTEBD"}], "]"}]}], "\[IndentingNewLine]", 
     "]"}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4507825783310127`*^9, 3.45078270319532*^9}, {
   3.450782746595615*^9, 3.450782884226019*^9}, {3.4507829427853394`*^9, 
   3.450782987058442*^9}, {3.4507839976398697`*^9, 3.450783998210019*^9}, {
   3.451640347580037*^9, 3.451640348387051*^9}, {3.451652011139406*^9, 
   3.451652015247087*^9}, {3.451652098081888*^9, 3.451652109487685*^9}, {
   3.4516521540389833`*^9, 3.4516521688615913`*^9}, {3.451652363046414*^9, 
   3.451652371383101*^9}, 3.451668219588066*^9, {3.451669608645258*^9, 
   3.451669608958296*^9}, {3.4670927222091227`*^9, 3.467092722277904*^9}}],

Cell[CellGroupData[{

Cell["Unfolded evolutions", "Subsubsection",
 CellChangeTimes->{{3.449949342896626*^9, 3.4499493470581913`*^9}, {
  3.451653573462118*^9, 3.4516535766239643`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Evolution2Sites", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Evolution2Sites", "[", 
   RowBox[{"Hams_", ",", "iTEBD_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "error", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD2QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateRight", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD2QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD1QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD2QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateLeft", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD2QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.449212578826249*^9, 3.449212686913636*^9}, {
  3.451652237645454*^9, 3.451652250398192*^9}, {3.45165234604064*^9, 
  3.4516523551282597`*^9}, {3.451653407503243*^9, 3.451653557645836*^9}, {
  3.4670927222953167`*^9, 3.467092722467216*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Evolution3Sites", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Evolution3Sites", "[", 
   RowBox[{"Hams_", ",", "iTEBD_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "error", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD3QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateRight", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD3QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateRight", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD3QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD1QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD3QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateLeft", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD3QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateLeft", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD3QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.451653582336782*^9, 3.451653583981464*^9}, {
  3.451653651778379*^9, 3.451653666082593*^9}, {3.4516684054387703`*^9, 
  3.451668411221794*^9}, {3.451669469607889*^9, 3.451669472694769*^9}, {
  3.451670142624399*^9, 3.451670145847761*^9}, {3.467092722487132*^9, 
  3.4670927227905617`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Evolution4Sites", ",", "HoldAll"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Evolution4Sites", "[", 
   RowBox[{"Hams_", ",", "iTEBD_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "error", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"error", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateRight", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateRight", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateRight", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD1QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateLeft", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateLeft", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"iTEBD", "=", 
      RowBox[{"RotateLeft", "[", 
       RowBox[{"iTEBD", ",", "1"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"error", "+=", 
      RowBox[{"iTEBD4QGate", "[", 
       RowBox[{"iTEBD", ",", 
        RowBox[{"Hams", "[", 
         RowBox[{"[", "2", "]"}], "]"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "error"}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.4516536811584587`*^9, 3.4516537008868237`*^9}, {
  3.451668418304145*^9, 3.4516684263471117`*^9}, {3.4670927228135366`*^9, 
  3.46709272327077*^9}}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Expectation values", "Section",
 CellChangeTimes->{{3.449949358815351*^9, 3.44994936257061*^9}}],

Cell[CellGroupData[{

Cell["One qubit operators", "Subsubsection",
 CellChangeTimes->{{3.44994936726726*^9, 3.449949373019763*^9}, {
  3.4502675401460447`*^9, 3.45026754194738*^9}, {3.450758995974264*^9, 
  3.4507589963047743`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"Expectation1O", ",", "HoldRest"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Expectation1O", "[", 
   RowBox[{"Operator_", ",", "iTEBD_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "Mdown", ",", "Mup", ",", "value", ",", "numTensors", ",", "tensor"}], 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"value", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"tensor", "[", "n_", "]"}], ":=", 
      RowBox[{
       RowBox[{"Mod", "[", 
        RowBox[{"n", ",", "numTensors"}], "]"}], "+", "1"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Do", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"Mup", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"iTEBD", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"tensor", "[", 
                RowBox[{"index", "-", "1"}], "]"}], ",", "2"}], "]"}], "]"}], 
            "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"Operator", ".", 
               RowBox[{"iTEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"tensor", "[", "index", "]"}], ",", "1"}], "]"}], 
                "]"}]}], ")"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"iTEBD", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"tensor", "[", "index", "]"}], ",", "2"}], "]"}], 
             "]"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Mdown", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"iTEBD", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"tensor", "[", 
                RowBox[{"index", "-", "1"}], "]"}], ",", "2"}], "]"}], "]"}], 
            "]"}], ".", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{"Conjugate", "[", 
              RowBox[{"iTEBD", "[", 
               RowBox[{"[", 
                RowBox[{
                 RowBox[{"tensor", "[", "index", "]"}], ",", "1"}], "]"}], 
               "]"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
           RowBox[{"DiagonalMatrix", "[", 
            RowBox[{"iTEBD", "[", 
             RowBox[{"[", 
              RowBox[{
               RowBox[{"tensor", "[", "index", "]"}], ",", "2"}], "]"}], 
             "]"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"value", "+=", 
         RowBox[{"Mdown", ".", "Mup"}]}]}], "\[IndentingNewLine]", ",", 
       RowBox[{"{", 
        RowBox[{"index", ",", "1", ",", "numTensors"}], "}"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Chop", "[", 
      RowBox[{"value", "/", "numTensors"}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.449233614719467*^9, 3.449233670884383*^9}, {
  3.449235402316236*^9, 3.449235417207464*^9}, {3.449235541149622*^9, 
  3.449235747560297*^9}, {3.449236566706367*^9, 3.4492365681376963`*^9}, {
  3.449236852706596*^9, 3.4492368688938007`*^9}, {3.4492374791787577`*^9, 
  3.4492374794490967`*^9}, {3.4492377227010508`*^9, 3.4492378186020823`*^9}, {
  3.449237867849146*^9, 3.449237962509055*^9}, {3.449238015762892*^9, 
  3.4492380201013193`*^9}, {3.449238096649747*^9, 3.4492381060916567`*^9}, {
  3.449238168223916*^9, 3.4492381707170553`*^9}, {3.4492382774626102`*^9, 
  3.449238286069556*^9}, {3.449238360423627*^9, 3.4492384211833878`*^9}, {
  3.449238457009124*^9, 3.449238459797823*^9}, {3.449238490182811*^9, 
  3.4492385352592087`*^9}, {3.4492918057836313`*^9, 3.449291807671534*^9}, {
  3.4500315708614817`*^9, 3.4500316497706337`*^9}, {3.450759016055152*^9, 
  3.450759246115004*^9}, {3.450759571254134*^9, 3.450759585810769*^9}, {
  3.451024972504018*^9, 3.451024994056218*^9}, {3.45130643587245*^9, 
  3.45130647161018*^9}, {3.4516522080992947`*^9, 3.451652210394803*^9}, {
  3.4670927232856693`*^9, 3.4670927233932867`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["For two qubit expectation values use Correlation list", "Subsubsection",
 CellChangeTimes->{{3.450111436694368*^9, 3.450111450732808*^9}, {
  3.4516523129440727`*^9, 3.4516523170839376`*^9}, {3.4516537649570837`*^9, 
  3.451653766163197*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBDCorrelationList", ",", "HoldFirst"}], "]"}], ";", 
  RowBox[{
   RowBox[{"iTEBDCorrelationList", "[", 
    RowBox[{
    "iTEBD_", ",", "Operator1_", ",", "Operator2_", ",", "distance_"}], "]"}],
    ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "numTensors", ",", "M", ",", "value", ",", "tensor", ",", "temp", ",", 
       "SpinDimension"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"numTensors", "=", 
       RowBox[{"Length", "[", "iTEBD", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"SpinDimension", "=", 
       RowBox[{"Length", "[", 
        RowBox[{"iTEBD", "[", 
         RowBox[{"[", 
          RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"tensor", "[", "n_", "]"}], ":=", 
       RowBox[{
        RowBox[{"Mod", "[", 
         RowBox[{"n", ",", "numTensors"}], "]"}], "+", "1"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"value", "=", 
       RowBox[{"Array", "[", 
        RowBox[{
         RowBox[{"0", "&"}], ",", "distance"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "This", " ", "will", " ", "do", " ", "a", " ", "loop", " ", "over", 
        " ", "the", " ", "different", " ", "tensors", " ", "in", " ", "the", 
        " ", "iTEBD", " ", "and", " ", "average", " ", "the", " ", 
        "expectation", " ", "value"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "First", " ", "prepare", " ", "the", " ", "initial", " ", "matrix", 
         " ", "with", " ", "the", " ", "action", " ", "of", " ", "the", " ", 
         "Operator1", " ", "on", " ", "the", " ", "starting", " ", "tensor"}],
         " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"M", "=", 
          RowBox[{
           RowBox[{"SparseArray", "[", 
            RowBox[{"DiagonalMatrix", "[", 
             RowBox[{"iTEBD", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"tensor", "[", "start", "]"}], ",", "2"}], "]"}], 
              "]"}], "]"}], "]"}], ".", 
           RowBox[{"Sum", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"ConjugateTranspose", "[", 
               RowBox[{"iTEBD", "[", 
                RowBox[{"[", 
                 RowBox[{
                  RowBox[{"tensor", "[", "start", "]"}], ",", "1", ",", "i"}],
                  "]"}], "]"}], "]"}], ".", 
              RowBox[{"(", 
               RowBox[{"SparseArray", "[", 
                RowBox[{"DiagonalMatrix", "[", 
                 RowBox[{
                  RowBox[{"iTEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "-", "1"}], "]"}], ",", "2"}], "]"}], 
                   "]"}], "^", "2"}], "]"}], "]"}], ")"}], ".", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{"Operator1", ".", 
                  RowBox[{"iTEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", "start", "]"}], ",", "1"}], "]"}], 
                   "]"}]}], ")"}], "[", 
                RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"i", ",", "1", ",", "SpinDimension"}], "}"}]}], "]"}], 
           ".", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"DiagonalMatrix", "[", 
             RowBox[{"iTEBD", "[", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"tensor", "[", "start", "]"}], ",", "2"}], "]"}], 
              "]"}], "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
          "The", " ", "expectation", " ", "value", " ", "is", " ", "added", 
           " ", "a", " ", "table", " ", "as", " ", "a", " ", "function", " ", 
           "of", " ", "distance"}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"value", "+=", 
          RowBox[{"Table", "[", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "First", " ", "we", " ", "calculate", " ", "the", " ", 
             "expectation", " ", "value", " ", "using", " ", "Operator2"}], 
            " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"temp", "=", 
              RowBox[{"Tr", "[", 
               RowBox[{
                RowBox[{"SparseArray", "[", 
                 RowBox[{"DiagonalMatrix", "[", 
                  RowBox[{"iTEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "2"}], "]"}], 
                   "]"}], "]"}], "]"}], ".", 
                RowBox[{"Sum", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"ConjugateTranspose", "[", 
                    RowBox[{"iTEBD", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "1", ",", 
                    "i"}], "]"}], "]"}], "]"}], ".", "M", ".", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"(", 
                    RowBox[{"Operator2", ".", 
                    RowBox[{"iTEBD", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "1"}], "]"}], 
                    "]"}]}], ")"}], "[", 
                    RowBox[{"[", "i", "]"}], "]"}], ")"}]}], ",", 
                  RowBox[{"{", 
                   RowBox[{"i", ",", "1", ",", "SpinDimension"}], "}"}]}], 
                 "]"}], ".", 
                RowBox[{"SparseArray", "[", 
                 RowBox[{"DiagonalMatrix", "[", 
                  RowBox[{"iTEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "2"}], "]"}], 
                   "]"}], "]"}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]",
              
             RowBox[{"(*", " ", 
              RowBox[{
               RowBox[{
               "Now", " ", "almost", " ", "the", " ", "same", " ", 
                "computation", " ", "but", " ", "for", " ", "the", " ", 
                "following", " ", "iteration"}], ",", " ", 
               RowBox[{
                RowBox[{"without", " ", "the", " ", 
                 RowBox[{"Operator2", ".", " ", "The"}], " ", "last", " ", 
                 "computation", " ", "is", " ", "useless"}], "..."}]}], " ", 
              "*)"}], "\[IndentingNewLine]", 
             RowBox[{"M", "=", 
              RowBox[{
               RowBox[{"SparseArray", "[", 
                RowBox[{"DiagonalMatrix", "[", 
                 RowBox[{"iTEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "2"}], "]"}], 
                  "]"}], "]"}], "]"}], ".", 
               RowBox[{"Sum", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"ConjugateTranspose", "[", 
                   RowBox[{"iTEBD", "[", 
                    RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "1", ",", 
                    "i"}], "]"}], "]"}], "]"}], ".", "M", ".", 
                  RowBox[{"iTEBD", "[", 
                   RowBox[{"[", 
                    RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "1", ",", 
                    "i"}], "]"}], "]"}]}], ",", 
                 RowBox[{"{", 
                  RowBox[{"i", ",", "1", ",", "SpinDimension"}], "}"}]}], 
                "]"}], ".", 
               RowBox[{"SparseArray", "[", 
                RowBox[{"DiagonalMatrix", "[", 
                 RowBox[{"iTEBD", "[", 
                  RowBox[{"[", 
                   RowBox[{
                    RowBox[{"tensor", "[", 
                    RowBox[{"start", "+", "dist"}], "]"}], ",", "2"}], "]"}], 
                  "]"}], "]"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
             "temp"}], "\[IndentingNewLine]", ",", 
            RowBox[{"{", 
             RowBox[{"dist", ",", "1", ",", "distance"}], "}"}]}], "]"}]}], 
         ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"start", ",", "0", ",", 
          RowBox[{"numTensors", "-", "1"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Chop", "[", 
       RowBox[{"value", "/", "numTensors"}], "]"}]}]}], "\[IndentingNewLine]",
     "]"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.45050873136408*^9, 3.4505087972512503`*^9}, {
   3.450508831075302*^9, 3.450508853306519*^9}, {3.450509151084873*^9, 
   3.450509175942548*^9}, {3.4505092808396597`*^9, 3.450509298782295*^9}, {
   3.450509587829466*^9, 3.450509703474001*^9}, {3.4505097487305317`*^9, 
   3.450509996302004*^9}, {3.4505102863956337`*^9, 3.450510359953023*^9}, {
   3.450510396395653*^9, 3.450510469887895*^9}, {3.450510506578932*^9, 
   3.450510519464325*^9}, {3.4505105495340242`*^9, 3.45051055740023*^9}, {
   3.450510591377123*^9, 3.450510701237884*^9}, {3.45051086847309*^9, 
   3.450510871682789*^9}, {3.4505489187011843`*^9, 3.450548918928994*^9}, {
   3.450548960296475*^9, 3.450548962389139*^9}, {3.450548992557152*^9, 
   3.450549015434885*^9}, {3.450553433557428*^9, 3.450553450955553*^9}, {
   3.450553501261423*^9, 3.450553511855302*^9}, {3.4505537399331083`*^9, 
   3.450553766320888*^9}, {3.4505541368873663`*^9, 3.45055413847324*^9}, {
   3.4505542885151033`*^9, 3.450554295554166*^9}, {3.4505543332053957`*^9, 
   3.450554416525758*^9}, 3.450554971530918*^9, {3.450555010644158*^9, 
   3.450555053360941*^9}, {3.45055512449356*^9, 3.4505552327067757`*^9}, {
   3.450555293095409*^9, 3.450555297705481*^9}, {3.4505553916363773`*^9, 
   3.450555500596787*^9}, {3.450555533964933*^9, 3.450555544268778*^9}, {
   3.4505556128992043`*^9, 3.450555665551342*^9}, {3.450555700384555*^9, 
   3.4505557652795467`*^9}, {3.45055584668754*^9, 3.450555889181555*^9}, {
   3.4505559199522533`*^9, 3.450556081741782*^9}, {3.450556194468031*^9, 
   3.450556277286108*^9}, {3.4505563324339437`*^9, 3.450556486841494*^9}, {
   3.450556537578225*^9, 3.450556541702141*^9}, {3.450589287746997*^9, 
   3.450589292317965*^9}, {3.450589384447165*^9, 3.450589394151169*^9}, {
   3.451306495260172*^9, 3.451306499384297*^9}, {3.4513065418855543`*^9, 
   3.451306554919969*^9}, {3.4670927234197903`*^9, 3.46709272383568*^9}, {
   3.467102257316523*^9, 3.467102281867524*^9}, {3.467102332200761*^9, 
   3.467102335675375*^9}, 3.4671024053989964`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"iTEBDFidelity", ",", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBDFidelity", "[", 
   RowBox[{"iTEBD1_", ",", "iTEBD2_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "numTensors", ",", "\[Rho]1", ",", "\[Rho]2", ",", "GL", ",", "GR", ",", 
      "evs", ",", "egs"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"numTensors", "=", 
      RowBox[{"Length", "[", "iTEBD1", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"numTensors", "\[NotEqual]", 
        RowBox[{"Length", "[", "iTEBD2", "]"}]}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"-", "1"}], "]"}]}], "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"GL", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD1", "[", 
         RowBox[{"[", 
          RowBox[{"numTensors", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"GL", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Fold", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#1", ".", 
            RowBox[{"Transpose", "[", 
             RowBox[{
              RowBox[{"iTEBD1", "[", 
               RowBox[{"[", 
                RowBox[{"#2", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], ".", 
            RowBox[{"SparseArray", "[", 
             RowBox[{"DiagonalMatrix", "[", 
              RowBox[{"iTEBD1", "[", 
               RowBox[{"[", 
                RowBox[{"#2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], "&"}],
           ",", "GL", ",", 
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", "numTensors"}], "]"}]}], "]"}], ",", 
        RowBox[{"Append", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"{", "#", "}"}], "&"}], "/@", 
           RowBox[{"Range", "[", 
            RowBox[{"2", ",", 
             RowBox[{"numTensors", "+", "1"}]}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"numTensors", "+", "2"}]}], "}"}]}], "]"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"GR", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"GL", ",", 
        RowBox[{
         RowBox[{"Range", "[", 
          RowBox[{"2", ",", 
           RowBox[{"numTensors", "+", "1"}]}], "]"}], "~", "Join", "~", 
         RowBox[{"{", "1", "}"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Rho]1", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"GL", ".", "GR"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", "numTensors"}], "]"}], ",", 
          RowBox[{"Range", "[", 
           RowBox[{
            RowBox[{"numTensors", "+", "1"}], ",", 
            RowBox[{"2", " ", "numTensors"}]}], "]"}]}], "}"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"GL", "=", 
      RowBox[{"SparseArray", "[", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"iTEBD2", "[", 
         RowBox[{"[", 
          RowBox[{"numTensors", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], ";",
      "\[IndentingNewLine]", 
     RowBox[{"GL", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"Fold", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#1", ".", 
            RowBox[{"Conjugate", "[", 
             RowBox[{"Transpose", "[", 
              RowBox[{
               RowBox[{"iTEBD2", "[", 
                RowBox[{"[", 
                 RowBox[{"#2", ",", "1"}], "]"}], "]"}], ",", 
               RowBox[{"{", 
                RowBox[{"2", ",", "1", ",", "3"}], "}"}]}], "]"}], "]"}], ".",
             
            RowBox[{"SparseArray", "[", 
             RowBox[{"DiagonalMatrix", "[", 
              RowBox[{"iTEBD2", "[", 
               RowBox[{"[", 
                RowBox[{"#2", ",", "2"}], "]"}], "]"}], "]"}], "]"}]}], "&"}],
           ",", "GL", ",", 
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", "numTensors"}], "]"}]}], "]"}], ",", 
        RowBox[{"Append", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"{", "#", "}"}], "&"}], "/@", 
           RowBox[{"Range", "[", 
            RowBox[{"2", ",", 
             RowBox[{"numTensors", "+", "1"}]}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            RowBox[{"numTensors", "+", "2"}]}], "}"}]}], "]"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"GR", "=", 
      RowBox[{"Transpose", "[", 
       RowBox[{"GL", ",", 
        RowBox[{
         RowBox[{"Range", "[", 
          RowBox[{"2", ",", 
           RowBox[{"numTensors", "+", "1"}]}], "]"}], "~", "Join", "~", 
         RowBox[{"{", "1", "}"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Rho]2", "=", 
      RowBox[{"Flatten", "[", 
       RowBox[{
        RowBox[{"GL", ".", "GR"}], ",", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"Range", "[", 
           RowBox[{"1", ",", "numTensors"}], "]"}], ",", 
          RowBox[{"Range", "[", 
           RowBox[{
            RowBox[{"numTensors", "+", "1"}], ",", 
            RowBox[{"2", " ", "numTensors"}]}], "]"}]}], "}"}]}], "]"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"evs", ",", "egs"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", "\[Rho]1", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"GL", "=", 
      RowBox[{
       RowBox[{"ConjugateTranspose", "[", "egs", "]"}], ".", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"Sqrt", "[", "evs", "]"}], "]"}], ".", "egs"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"evs", ",", "egs"}], "}"}], "=", 
      RowBox[{"Eigensystem", "[", 
       RowBox[{"GL", ".", "\[Rho]2", ".", "GL"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"GR", "=", 
      RowBox[{
       RowBox[{"ConjugateTranspose", "[", "egs", "]"}], ".", 
       RowBox[{"DiagonalMatrix", "[", 
        RowBox[{"Sqrt", "[", "evs", "]"}], "]"}], ".", "egs"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Tr", "[", "GR", "]"}], "^", "2"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.450605424381297*^9, 3.450605512324194*^9}, {
   3.450632276760747*^9, 3.450632291965581*^9}, {3.450673667432448*^9, 
   3.450673933250209*^9}, {3.450674049283806*^9, 3.450674095893622*^9}, {
   3.450674139665744*^9, 3.450674182607203*^9}, {3.450674975341363*^9, 
   3.450674979577984*^9}, {3.4506771884950647`*^9, 3.450677202394393*^9}, {
   3.4506772391357203`*^9, 3.4506774008721867`*^9}, {3.45067804499586*^9, 
   3.450678047599471*^9}, 3.450678136677079*^9, {3.450679806385954*^9, 
   3.450679830334674*^9}, {3.45067986091112*^9, 3.450679907920369*^9}, {
   3.450679979643857*^9, 3.450680017523666*^9}, {3.4506801753878613`*^9, 
   3.450680294843093*^9}, {3.450680514725354*^9, 3.4506805181916018`*^9}, {
   3.450680721412281*^9, 3.450680753252092*^9}, {3.45068103601228*^9, 
   3.450681036471599*^9}, {3.450681676708234*^9, 3.4506817329828587`*^9}, {
   3.450681774696784*^9, 3.450681837080576*^9}, {3.45068187854002*^9, 
   3.4506818840853157`*^9}, {3.450681916619948*^9, 3.450681918695266*^9}, {
   3.467092723881217*^9, 3.467092724074181*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"iTEBDentropy", "[", "\[Lambda]_", "]"}], ":=", 
   RowBox[{"-", 
    RowBox[{"Sum", "[", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"\[Lambda]", "[", 
          RowBox[{"[", "n", "]"}], "]"}], ">", "0"}], ",", 
        RowBox[{
         RowBox[{
          RowBox[{"\[Lambda]", "[", 
           RowBox[{"[", "n", "]"}], "]"}], "^", "2"}], 
         RowBox[{"Log", "[", 
          RowBox[{"2", ",", 
           RowBox[{
            RowBox[{"\[Lambda]", "[", 
             RowBox[{"[", "n", "]"}], "]"}], "^", "2"}]}], "]"}]}], ",", 
        "0"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"n", ",", "1", ",", 
        RowBox[{"Length", "[", "\[Lambda]", "]"}]}], "}"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBDentropyList", "[", "TEBD_", "]"}], ":=", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"n", ",", 
      RowBox[{"iTEBDentropy", "[", 
       RowBox[{"TEBD", "[", 
        RowBox[{"[", 
         RowBox[{"n", ",", "2"}], "]"}], "]"}], "]"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"n", ",", "1", ",", 
      RowBox[{"Length", "[", "TEBD", "]"}]}], "}"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"iTEBDentropyAverage", "[", "TEBD_", "]"}], ":=", 
  RowBox[{"Mean", "[", 
   RowBox[{
    RowBox[{"iTEBDentropyList", "[", "TEBD", "]"}], "[", 
    RowBox[{"[", 
     RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.468482525061323*^9, 3.4684825483620367`*^9}, {
  3.468482586476363*^9, 3.468482673368292*^9}}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->None,
WindowSize->{863, 784},
WindowMargins->{{Automatic, 150}, {Automatic, 0}},
FrontEndVersion->"6.0 for Mac OS X x86 (32-bit) (March 13, 2008)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[590, 23, 268, 3, 76, "Title"],
Cell[CellGroupData[{
Cell[883, 30, 104, 1, 67, "Section"],
Cell[990, 33, 154, 2, 26, "Text"],
Cell[1147, 37, 2247, 33, 43, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[3431, 75, 231, 3, 67, "Section"],
Cell[3665, 80, 235, 5, 26, "Text"],
Cell[CellGroupData[{
Cell[3925, 89, 150, 2, 34, "Subsection"],
Cell[4078, 93, 164, 2, 27, "Input"],
Cell[4245, 97, 8510, 188, 358, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[12792, 290, 117, 1, 34, "Subsection"],
Cell[12912, 293, 1566, 41, 103, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[14515, 339, 103, 1, 34, "Subsection"],
Cell[14621, 342, 2784, 68, 208, "Input",
 InitializationCell->True],
Cell[17408, 412, 3176, 71, 193, "Input",
 InitializationCell->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[20633, 489, 139, 2, 67, "Section"],
Cell[CellGroupData[{
Cell[20797, 495, 154, 2, 34, "Subsection"],
Cell[20954, 499, 296, 6, 26, "Text"],
Cell[21253, 507, 12654, 282, 433, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[33944, 794, 110, 1, 34, "Subsection"],
Cell[CellGroupData[{
Cell[34079, 799, 192, 2, 25, "Subsubsection"],
Cell[34274, 803, 1073, 30, 73, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[35384, 838, 120, 1, 25, "Subsubsection"],
Cell[35507, 841, 499, 15, 27, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[36043, 861, 213, 4, 25, "Subsubsection"],
Cell[36259, 867, 1184, 34, 58, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[37480, 906, 114, 1, 25, "Subsubsection"],
Cell[37597, 909, 1640, 46, 88, "Input"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[39286, 961, 204, 3, 34, "Subsection"],
Cell[39493, 966, 360, 7, 26, "Text"],
Cell[39856, 975, 20252, 458, 838, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[60145, 1438, 261, 3, 34, "Subsection"],
Cell[60409, 1443, 422, 7, 26, "Text"],
Cell[60834, 1452, 20247, 459, 853, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[81118, 1916, 157, 2, 34, "Subsection"],
Cell[81278, 1920, 14045, 347, 658, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[95360, 2272, 208, 3, 34, "Subsection"],
Cell[95571, 2277, 15759, 392, 763, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[111367, 2674, 207, 3, 34, "Subsection"],
Cell[111577, 2679, 18435, 454, 853, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[130049, 3138, 107, 1, 34, "Subsection"],
Cell[130159, 3141, 1081, 27, 121, "Input"]
}, Closed]],
Cell[CellGroupData[{
Cell[131277, 3173, 98, 1, 26, "Subsection"],
Cell[131378, 3176, 1861, 42, 148, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[133264, 3222, 163, 2, 25, "Subsubsection"],
Cell[133430, 3226, 2094, 54, 193, "Input",
 InitializationCell->True],
Cell[135527, 3282, 2839, 73, 253, "Input",
 InitializationCell->True],
Cell[138369, 3357, 3393, 89, 313, "Input",
 InitializationCell->True]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[141823, 3453, 102, 1, 67, "Section"],
Cell[CellGroupData[{
Cell[141950, 3458, 210, 3, 25, "Subsubsection"],
Cell[142163, 3463, 4523, 104, 253, "Input",
 InitializationCell->True]
}, Open  ]],
Cell[CellGroupData[{
Cell[146723, 3572, 248, 3, 25, "Subsubsection"],
Cell[146974, 3577, 11305, 243, 538, "Input",
 InitializationCell->True],
Cell[158282, 3822, 7632, 191, 418, "Input",
 InitializationCell->True],
Cell[165917, 4015, 1658, 49, 58, "Input",
 InitializationCell->True]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

(* End of internal cache information *)
